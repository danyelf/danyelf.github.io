(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(t){if(t.ep)return;t.ep=!0;const i=o(t);fetch(t.href,i)}})();const Ge=`#version 300 es
  uniform vec2 u_resolution;
  uniform vec2 u_pan;
  uniform float u_zoom;

  in vec2 a_position;
  in vec3 a_color;
  in vec2 a_uv;

  out vec3 v_color;
  out vec2 v_uv;

  void main() {
    vec2 pos = (a_position + u_pan) * u_zoom;
    vec2 clipSpace = (pos / u_resolution) * 2.0 - 1.0;
    gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
    v_color = a_color;
    v_uv = a_uv;
  }
`,qe=`#version 300 es
  precision mediump float;
  in vec3 v_color;
  in vec2 v_uv;
  out vec4 fragColor;

  // Simple hash for dithering noise
  float hash(vec2 p) {
    return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
  }

  void main() {
    // Add dithering noise to break up moiré patterns
    float noise = (hash(gl_FragCoord.xy) - 0.5) * 0.15;
    vec3 color = v_color + noise;
    fragColor = vec4(color, 1.0);
  }
`;function Je(e){const s=e.getContext("webgl2",{antialias:!0});if(!s)throw new Error("WebGL2 not supported");return s}function ke(e,s,o){const n=e.createShader(s);if(!n)throw new Error("Failed to create shader");if(e.shaderSource(n,o),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n)||"Shader compilation failed");return n}function Qe(e){const s=ke(e,e.VERTEX_SHADER,Ge),o=ke(e,e.FRAGMENT_SHADER,qe),n=e.createProgram();if(!n)throw new Error("Failed to create program");if(e.attachShader(n,s),e.attachShader(n,o),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(n)||"Program linking failed");return{program:n,attribs:{position:e.getAttribLocation(n,"a_position"),color:e.getAttribLocation(n,"a_color"),uv:e.getAttribLocation(n,"a_uv")},uniforms:{resolution:e.getUniformLocation(n,"u_resolution"),pan:e.getUniformLocation(n,"u_pan"),zoom:e.getUniformLocation(n,"u_zoom")}}}function q(e){const s=Math.sin(e*12.9898+e*78.233)*43758.5453;return s-Math.floor(s)}const U=[{name:"Genesis",file:"genesis",section:"torah"},{name:"Exodus",file:"exodus",section:"torah"},{name:"Leviticus",file:"leviticus",section:"torah"},{name:"Numbers",file:"numbers",section:"torah"},{name:"Deuteronomy",file:"deuteronomy",section:"torah"},{name:"Joshua",file:"joshua",section:"neviim"},{name:"Judges",file:"judges",section:"neviim"},{name:"I Samuel",file:"i-samuel",section:"neviim"},{name:"II Samuel",file:"ii-samuel",section:"neviim"},{name:"I Kings",file:"i-kings",section:"neviim"},{name:"II Kings",file:"ii-kings",section:"neviim"},{name:"Isaiah",file:"isaiah",section:"neviim"},{name:"Jeremiah",file:"jeremiah",section:"neviim"},{name:"Ezekiel",file:"ezekiel",section:"neviim"},{name:"Hosea",file:"hosea",section:"neviim"},{name:"Joel",file:"joel",section:"neviim"},{name:"Amos",file:"amos",section:"neviim"},{name:"Obadiah",file:"obadiah",section:"neviim"},{name:"Jonah",file:"jonah",section:"neviim"},{name:"Micah",file:"micah",section:"neviim"},{name:"Nahum",file:"nahum",section:"neviim"},{name:"Habakkuk",file:"habakkuk",section:"neviim"},{name:"Zephaniah",file:"zephaniah",section:"neviim"},{name:"Haggai",file:"haggai",section:"neviim"},{name:"Zechariah",file:"zechariah",section:"neviim"},{name:"Malachi",file:"malachi",section:"neviim"},{name:"Psalms",file:"psalms",section:"ketuvim"},{name:"Proverbs",file:"proverbs",section:"ketuvim"},{name:"Job",file:"job",section:"ketuvim"},{name:"Song of Songs",file:"song-of-songs",section:"ketuvim"},{name:"Ruth",file:"ruth",section:"ketuvim"},{name:"Lamentations",file:"lamentations",section:"ketuvim"},{name:"Ecclesiastes",file:"ecclesiastes",section:"ketuvim"},{name:"Esther",file:"esther",section:"ketuvim"},{name:"Daniel",file:"daniel",section:"ketuvim"},{name:"Ezra",file:"ezra",section:"ketuvim"},{name:"Nehemiah",file:"nehemiah",section:"ketuvim"},{name:"I Chronicles",file:"i-chronicles",section:"ketuvim"},{name:"II Chronicles",file:"ii-chronicles",section:"ketuvim"}],Ze=U.map(e=>e.name),et=new Set(U.filter(e=>e.section==="torah").map(e=>e.name));new Set(U.filter(e=>e.section==="neviim").map(e=>e.name));const tt=new Set(U.filter(e=>e.section==="ketuvim").map(e=>e.name)),nt=Object.fromEntries(U.map(e=>[e.name,e.file]));function ot(e){return et.has(e)?"torah":tt.has(e)?"ketuvim":"neviim"}const I=6,ye=2,V=12,xe=70,$e=35,B=50,it=12,Le=3,Se=15,st=72,Oe=[["Hosea","Joel"],["Amos","Obadiah","Jonah"],["Micah","Nahum","Habakkuk","Zephaniah","Haggai"],["Zechariah","Malachi"]],Ee=new Set(Oe.flat()),Ie=[{books:["Song of Songs","Ruth","Lamentations"],insertAfter:"Job"},{books:["Ecclesiastes","Esther"],insertAfter:"Job"},{books:["Ezra","Nehemiah"],insertAfter:"Daniel"}],rt=new Set(Ie.flatMap(e=>e.books));function at(e){if(e<=B)return[e];const s=[];let o=e;for(;o>0;)if(o<=B)s.push(o),o=0;else if(o<=B+Le-1){const n=o-Le;s.push(n),o-=n}else s.push(B),o-=B;return s}function ae(e,s,o,n,t,i,r){const c=at(o);let a=0,h=t,l=0;for(let d=0;d<c.length;d++){const g=c[d],f=d>0?it:0;for(let C=0;C<g;C++){const _=(q(i.value*2)-.5)*2,v=(q(i.value*2+1)-.5)*2,x=.4+q(i.value*3)*.4,A=n+f+C*I+_;r.push({book:e,chapter:s+1,verse:l+1,x:A,y:h+v,size:I,color:[x,x,x]}),a=Math.max(a,f+(C+1)*I),l++,i.value++}h+=I+ye}return{width:a,height:c.length*(I+ye)}}function he(e,s,o,n,t){let i=0,r=o;for(let c=0;c<e.chapters.length;c++){const a=e.chapters[c],{width:h,height:l}=ae(e.name,c,a,s,r,n,t);i=Math.max(i,h),r+=l}return{width:i,height:r-o}}function Be(e,s,o,n,t,i,r=he){let c=s,a=0;for(const h of e){const{width:l,height:d}=r(h,c,o,t,i);a=Math.max(a,d),c+=l+n}return{width:c-s-(e.length>0?n:0),height:a,nextX:c}}function je(e,s,o,n,t,i,r){let c=n,a=0;for(const l of e){const d=s.get(l);if(!d)continue;const{width:g,height:f}=he(d,o,c,i,r);a=Math.max(a,g),c+=f+t}const h=c-n-(e.length>0?t:0);return{width:a,height:h}}function ct(e,s,o,n,t,i,r,c){let a=o,h=0;for(const l of e){const{width:d,height:g}=je(l,s,a,n,t,r,c);h=Math.max(h,g),a+=d+i}return{width:a-o-(e.length>0?i:0),height:h}}function lt(e,s,o,n,t){const i=st;let r=o,c=0;for(let f=0;f<i;f++){const C=e.chapters[f],{width:_,height:v}=ae(e.name,f,C,s,r,n,t);c=Math.max(c,_),r+=v}const a=r-o,h=s+c+Se;let l=o,d=0;for(let f=i;f<e.chapters.length;f++){const C=e.chapters[f],{width:_,height:v}=ae(e.name,f,C,h,l,n,t);d=Math.max(d,_),l+=v}const g=l-o;return{width:c+Se+d,height:Math.max(a,g)}}function ut(e,s,o,n){const t=e.filter(l=>!Ee.has(l.name)),i=e.filter(l=>Ee.has(l.name)),r=new Map(i.map(l=>[l.name,l])),{height:c,nextX:a}=Be(t,0,s,V,o,n),{height:h}=ct(Oe,r,a,s,$e,V,o,n);return Math.max(c,h)}function ht(e,s,o,n){const t=new Map(e.map(a=>[a.name,a]));let i=0,r=0;const c=e.filter(a=>!rt.has(a.name));for(const a of c){const{width:h,height:l}=a.name==="Psalms"?lt(a,i,s,o,n):he(a,i,s,o,n);r=Math.max(r,l),i+=h+V;for(const d of Ie)if(a.name===d.insertAfter){const{width:g,height:f}=je(d.books,t,i,s,$e,o,n);r=Math.max(r,f),i+=g+V}}return r}function dt(e,s,o,n){const{height:t}=Be(e,0,s,V,o,n);return t}function mt(e){const s=[],o={value:0},n=[],t=[],i=[];for(const h of e.books){const l=ot(h.name);l==="torah"?n.push(h):l==="neviim"?t.push(h):i.push(h)}let r=0;const c=dt(n,r,o,s);r+=c+xe;const a=ut(t,r,o,s);return r+=a+xe,ht(i,r,o,s),s}function ft(e){let s=0,o=0;for(const n of e)s=Math.max(s,n.x+n.size),o=Math.max(o,n.y+n.size);return{width:s,height:o}}function Me(e,s=[.6,.6,.6]){const t=new Float32Array(e.length*6*7);let i=0;for(const r of e){const c=r.x,a=r.y,h=r.x+r.size-2,l=r.y+r.size-2,[d,g,f]=r.color||s;t[i++]=c,t[i++]=a,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=0,t[i++]=0,t[i++]=h,t[i++]=a,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=1,t[i++]=0,t[i++]=c,t[i++]=l,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=0,t[i++]=1,t[i++]=c,t[i++]=l,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=0,t[i++]=1,t[i++]=h,t[i++]=a,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=1,t[i++]=0,t[i++]=h,t[i++]=l,t[i++]=d,t[i++]=g,t[i++]=f,t[i++]=1,t[i++]=1}return t}function pt(e,s){const o=e.createBuffer();if(!o)throw new Error("Failed to create buffer");return e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),o}const gt=-20;function vt(e,s){const o={};for(const t of e)o[t.book]||(o[t.book]={minX:t.x,maxX:t.x+t.size,minY:t.y}),o[t.book].maxX=Math.max(o[t.book].maxX,t.x+t.size),o[t.book].minY=Math.min(o[t.book].minY,t.y);const n=document.createElement("div");n.id="book-labels",n.style.cssText="position:fixed;top:0;left:0;pointer-events:none;";for(const[t,i]of Object.entries(o)){const r=document.createElement("div");r.textContent=t,r.style.cssText=`
      position:absolute;
      color:#666;
      font-family:sans-serif;
      font-size:12px;
      white-space:nowrap;
    `,r.dataset.bookName=t,r.dataset.leftX=String(i.minX),r.dataset.topY=String(i.minY),n.appendChild(r)}return s.appendChild(n),n}function Te(e,s,o){for(const n of e.children)if(n instanceof HTMLElement){const t=parseFloat(n.dataset.leftX||"0"),i=parseFloat(n.dataset.topY||"0"),r=(t+s.x)*o,c=(i+s.y)*o+gt;n.style.left=r+"px",n.style.top=c+"px"}}function Ce(e){return e.replace(/<sup[^>]*>[\s\S]*?<\/sup>/g,"").replace(/<i class="footnote">[\s\S]*?<\/i>/g,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&[a-z]+;/g,"").replace(/\s+/g," ").trim()}async function bt(e){const[s,o]=await Promise.all([fetch(`/data/texts/${e}-he.json`),fetch(`/data/texts/${e}-en.json`)]);if(!s.ok||!o.ok)return console.error(`Failed to load text files for ${e}: he=${s.status}, en=${o.status}`),{};let n,t;try{n=await s.json(),t=await o.json()}catch(r){return console.error(`Failed to parse text files for ${e}:`,r),{}}const i={};for(let r=0;r<n.text.length;r++){const c=String(r+1);i[c]={};const a=n.text[r]||[],h=t.text[r]||[];for(let l=0;l<a.length;l++){const d=String(l+1);i[c][d]={he:Ce(a[l]||""),en:Ce(h[l]||"")}}}return i}async function wt(){const e={},s=Object.entries(nt),o=await Promise.all(s.map(([n,t])=>bt(t).then(i=>({bookName:n,texts:i}))));for(const{bookName:n,texts:t}of o)e[n]=t;return console.log(`Loaded verse texts for ${Object.keys(e).length} books`),e}function kt(e,s,o,n){var t,i;return((i=(t=e[s])==null?void 0:t[String(o)])==null?void 0:i[String(n)])||null}function Y(e,s,o){return`${e}:${s}:${o}`}const yt=1424,xt=1535,Lt=1425,St=1479;let z=[];function Fe(e){let s="";for(const o of e){const n=o.charCodeAt(0);(n<Lt||n>St||n===1470||n===1472||n===1475||n===1478)&&(s+=o)}return s}function Et(e){for(const s of e){const o=s.charCodeAt(0);if(o>=yt&&o<=xt)return!0}return!1}function Mt(e){z=[];for(const s of Ze){const o=e[s];if(!o)continue;const n=Object.keys(o).map(Number).sort((t,i)=>t-i);for(const t of n){const i=o[String(t)],r=Object.keys(i).map(Number).sort((c,a)=>c-a);for(const c of r){const{he:a,en:h}=i[String(c)];z.push({book:s,chapter:t,verse:c,hebrewText:Fe(a),hebrewOriginal:a,englishText:h.toLowerCase(),englishOriginal:h})}}}console.log(`Search index built with ${z.length} verses`)}function Tt(e){if(!e||e.length<2)return[];const s=Et(e),o=[];if(s){const n=Fe(e);for(const t of z){const i=t.hebrewText.indexOf(n);if(i!==-1){const r=Ae(t.hebrewOriginal,i,n.length);o.push({book:t.book,chapter:t.chapter,verse:t.verse,snippet:r.text,matchStart:r.matchStart,matchEnd:r.matchEnd,language:"he"})}}}else{const n=e.toLowerCase();for(const t of z){const i=t.englishText.indexOf(n);if(i!==-1){const r=Ae(t.englishOriginal,i,n.length);o.push({book:t.book,chapter:t.chapter,verse:t.verse,snippet:r.text,matchStart:r.matchStart,matchEnd:r.matchEnd,language:"en"})}}}return o}function Ae(e,s,o){let i=Math.max(0,s-20),r=Math.min(e.length,i+60);r===e.length&&r-i<60&&(i=Math.max(0,r-60));let c=e.slice(i,r);const a=s-i,h=a+o;return i>0&&(c="..."+c),r<e.length&&(c=c+"..."),{text:c,matchStart:i>0?a+3:a,matchEnd:i>0?h+3:h}}function Ct(e){const s=new Set;for(const o of e)s.add(Y(o.book,o.chapter,o.verse));return s}const de=new Map;function G(e){de.set(e.id,e)}function At(e){return de.get(e)}function Pt(){return Array.from(de.values())}const Rt={1:[.3,.5,.9],2:[.9,.3,.3],3:[.7,.3,.8]},_t={1:"YHWH",2:"Elohim",3:"YHWH + Elohim"};let se={};const Nt={id:"divine-names",name:"Divine Names",async init(){try{const e=await fetch("/data/divine-names.json");if(!e.ok){console.error(`Failed to load divine-names.json: ${e.status}`);return}se=await e.json()}catch(e){console.error("Failed to parse divine-names.json:",e)}},getVerseColor(e){var o,n;const s=((n=(o=se[e.book])==null?void 0:o[e.chapter-1])==null?void 0:n[e.verse-1])??0;return s>0?Rt[s]??null:null},renderLegend(e){e.innerHTML=`
      <div class="legend-row"><span class="swatch" style="background: rgb(77, 128, 230)"></span><span>YHWH</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(230, 77, 77)"></span><span>Elohim</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(179, 77, 204)"></span><span>Both</span></div>
    `},getHoverInfo(e){var o,n;const s=((n=(o=se[e.book])==null?void 0:o[e.chapter-1])==null?void 0:n[e.verse-1])??0;return s>0?_t[s]:null}},Ht=[.2,.9,1],$t=.3;function Ot(e,s){if(e===0)return[.15,.15,.2];const o=Math.log(s+1),n=Math.log(e+1)/o;if(n<.25){const t=n/.25;return[.1,.13+t*.1,.18+t*.2]}else if(n<.5){const t=(n-.25)/.25;return[.1+t*.1,.23+t*.2,.38-t*.05]}else if(n<.75){const t=(n-.5)/.25;return[.2+t*.7,.43-t*.1,.33-t*.2]}else{const t=(n-.75)/.25;return[.9+t*.1,.33-t*.1,.13+t*.05]}}let Z={},T="total",j=null,$={},De=[];function ze(e,s,o){var t,i;const n=(i=(t=Z[e])==null?void 0:t[String(s)])==null?void 0:i[String(o)];return n?T==="total"?n.total:n.categories[T]||0:0}function Pe(){if($[T]!==void 0)return $[T];let e=0;for(const s of De){const o=ze(s.book,s.chapter,s.verse);o>e&&(e=o)}return $[T]=e,e}const It={id:"commentary",name:"Commentary Density",async init(){try{const e=await fetch("/data/commentary-counts.json");if(!e.ok){console.error(`Failed to load commentary-counts.json: ${e.status}`);return}Z=await e.json()}catch(e){console.error("Failed to parse commentary-counts.json:",e)}},destroy(){T="total",$={},j=null},onUpdate(e){j=e},getVerseColor(e){const s=ze(e.book,e.chapter,e.verse),o=Pe();return Ot(s,o)},renderControls(e){const s=document.createElement("div");s.className="commentary-controls",s.innerHTML=`
      <label for="category-select">Category:</label>
      <select id="category-select">
        <option value="total">All Commentary</option>
        <option value="Tanakh">Tanakh</option>
        <option value="Talmud">Talmud</option>
        <option value="Midrash">Midrash</option>
        <option value="Halakhah">Halakhah</option>
        <option value="Kabbalah">Kabbalah</option>
      </select>
    `;const o=s.querySelector("select");o.value=T,o.addEventListener("change",()=>{T=o.value,$={},j==null||j()}),e.appendChild(s)},renderLegend(e){const s=Pe(),o=Math.log(s+1),n=[0];let t=1;for(;t<=s;)n.push(t),t*=10;n[n.length-1]<s&&n.push(s),e.innerHTML=`
      <div class="legend-gradient"></div>
      <div class="legend-ticks">
        ${n.map(i=>{const r=i===0?0:Math.log(i+1)/o*100,c=i>=1e3?`${i/1e3}k`:String(i);return`<span class="tick" style="left: ${r}%">${c}</span>`}).join("")}
      </div>
    `},getHoverInfo(e){var n,t;const s=(t=(n=Z[e.book])==null?void 0:n[String(e.chapter)])==null?void 0:t[String(e.verse)];if(!s)return null;if(T==="total")return`${s.total} links`;const o=s.categories[T];return o?`${o} ${T}`:null}};function Bt(e){De=e.verses,$={}}function jt(e,s,o){var t,i;const n=(i=(t=Z[e])==null?void 0:t[String(s)])==null?void 0:i[String(o)];return(n==null?void 0:n.total)??null}const Ke=[{unicode:"֒",codePoint:1426,name:"Segol",hebrewName:"סגול"},{unicode:"֓",codePoint:1427,name:"Shalshelet",hebrewName:"שלשלת"},{unicode:"֔",codePoint:1428,name:"Zaqef Qatan",hebrewName:"זקף קטן"},{unicode:"֕",codePoint:1429,name:"Zaqef Gadol",hebrewName:"זקף גדול"},{unicode:"֖",codePoint:1430,name:"Tipcha",hebrewName:"טפחא"},{unicode:"֗",codePoint:1431,name:"Revia",hebrewName:"רביע"},{unicode:"֘",codePoint:1432,name:"Zarqa",hebrewName:"זרקא"},{unicode:"֙",codePoint:1433,name:"Pashta",hebrewName:"פשטא"},{unicode:"֚",codePoint:1434,name:"Yetiv",hebrewName:"יתיב"},{unicode:"֛",codePoint:1435,name:"Tevir",hebrewName:"תביר"},{unicode:"֜",codePoint:1436,name:"Geresh",hebrewName:"גרש"},{unicode:"֝",codePoint:1437,name:"Geresh Muqdam",hebrewName:"גרש מוקדם"},{unicode:"֞",codePoint:1438,name:"Gershayim",hebrewName:"גרשיים"},{unicode:"֟",codePoint:1439,name:"Karnei Parah",hebrewName:"קרני פרה"},{unicode:"֠",codePoint:1440,name:"Telisha Gedola",hebrewName:"תלישא גדולה"},{unicode:"֡",codePoint:1441,name:"Pazer",hebrewName:"פזר"},{unicode:"֣",codePoint:1443,name:"Munach",hebrewName:"מונח"},{unicode:"֤",codePoint:1444,name:"Mahapakh",hebrewName:"מהפך"},{unicode:"֥",codePoint:1445,name:"Merkha",hebrewName:"מרכא"},{unicode:"֦",codePoint:1446,name:"Merkha Kefula",hebrewName:"מרכא כפולה"},{unicode:"֧",codePoint:1447,name:"Darga",hebrewName:"דרגא"},{unicode:"֨",codePoint:1448,name:"Qadma",hebrewName:"קדמא"},{unicode:"֩",codePoint:1449,name:"Telisha Qetana",hebrewName:"תלישא קטנה"},{unicode:"֪",codePoint:1450,name:"Yerah Ben Yomo",hebrewName:"ירח בן יומו"},{unicode:"֫",codePoint:1451,name:"Ole",hebrewName:"עולה"},{unicode:"֬",codePoint:1452,name:"Iluy",hebrewName:"אילוי"},{unicode:"֭",codePoint:1453,name:"Dehi",hebrewName:"דחי"},{unicode:"֮",codePoint:1454,name:"Zinor",hebrewName:"זינור"},{unicode:"֑",codePoint:1425,name:"Etnachta",hebrewName:"אתנחתא"},{unicode:"֢",codePoint:1442,name:"Atnah Hafukh",hebrewName:"אתנח הפוך"},{unicode:"֯",codePoint:1455,name:"Masora Circle",hebrewName:"עיגול מסורה"}];new Map(Ke.map(e=>[e.unicode,e]));const Re={RARE:50,UNCOMMON:500};function ee(e){return e<Re.RARE?"rare":e<Re.UNCOMMON?"uncommon":"common"}function Ft(e){const s=[];for(const o of e){const n=o.codePointAt(0);n&&n>=1425&&n<=1455&&s.push(o)}return s}function Dt(e){const s=new Map,o=Ft(e);for(const n of o)s.set(n,(s.get(n)||0)+1);return s}function zt(e){const s=new Map;for(const o of Ke)s.set(o.unicode,{unicode:o.unicode,name:o.name,hebrewName:o.hebrewName,totalCount:0,verses:[]});for(const[o,n]of Object.entries(e))for(const[t,i]of Object.entries(n)){const r=parseInt(t,10);for(const[c,a]of Object.entries(i)){const h=parseInt(c,10),l=Dt(a.he);for(const[d,g]of l){const f=s.get(d);f&&(f.totalCount+=g,f.verses.push({book:o,chapter:r,verse:h,count:g}))}}}return s}function Kt(e){return Array.from(e.values()).filter(s=>s.totalCount>0).sort((s,o)=>s.totalCount-o.totalCount)}let _e=new Map,K=[],w=null,J=null,ce=new Map,D=1,Ve=0,le="common";const Vt=[1,.84,0],Yt=[.15,.15,.15];function Ut(){if(ce.clear(),!!w){le=ee(w.totalCount);for(const e of w.verses){const s=Y(e.book,e.chapter,e.verse);ce.set(s,e.count)}D=1;for(const e of w.verses)e.count>D&&(D=e.count);Ve=Math.log(D+1)}}function Wt(e){if(!w)return null;const s=Y(e.book,e.chapter,e.verse),o=ce.get(s)||0;if(le==="rare")return o>0?Vt:Yt;if(le==="uncommon"){if(o===0)return[.12,.12,.15];const n=o/D;return[.4+n*.5,.2+n*.2,.6+n*.35]}else{if(o===0)return[.12,.1,.15];const n=Math.log(o+1)/Ve;if(n<.33){const t=n/.33;return[.2+t*.2,.1+t*.1,.3+t*.2]}else if(n<.66){const t=(n-.33)/.33;return[.4+t*.3,.2+t*.1,.5+t*.2]}else{const t=(n-.66)/.34;return[.7+t*.25,.3+t*.3,.7+t*.2]}}}function Xt(e){e.innerHTML=`
    <div class="trop-controls">
      <label style="margin-bottom: 8px;">Select Trop Mark</label>
      <div class="trop-chart"></div>
      <div class="trop-info"></div>
    </div>
  `;const s=e.querySelector(".trop-chart"),o=e.querySelector(".trop-info");let n=null;for(const t of K){const i=document.createElement("button");i.textContent="ב"+t.unicode,i.title=`${t.name} (${t.hebrewName})`;const r=ee(t.totalCount);r==="rare"&&i.classList.add("rare"),i.addEventListener("mouseenter",()=>{const c=r==="rare"?"Rare":r==="uncommon"?"Uncommon":"Common";o.textContent=`${t.name} (${t.hebrewName}) · ${t.totalCount.toLocaleString()} occurrences · ${c}`}),i.addEventListener("mouseleave",()=>{if(!n)o.textContent="";else{const c=K.find(a=>a.unicode===(n==null?void 0:n.dataset.unicode));if(c){const a=ee(c.totalCount),h=a==="rare"?"Rare":a==="uncommon"?"Uncommon":"Common";o.textContent=`${c.name} (${c.hebrewName}) · ${c.totalCount.toLocaleString()} · ${h}`}}}),i.addEventListener("click",()=>{n===i?(i.classList.remove("selected"),n=null,w=null,o.textContent=""):(n&&n.classList.remove("selected"),i.classList.add("selected"),n=i,w=t),Ut(),J==null||J()}),i.dataset.unicode=t.unicode,s.appendChild(i)}}const Gt={id:"trop",name:"Cantillation (Trop)",async init(){},destroy(){w=null},onUpdate(e){J=e},getVerseColor(e){return Wt(e)},renderControls(e){Xt(e)},renderLegend(e){if(!w){e.innerHTML='<div style="color: #666; font-size: 11px;">Select a trop mark above</div>';return}ee(w.totalCount)==="rare"?e.innerHTML=`
        <div class="legend-row"><span class="swatch" style="background: rgb(255, 214, 0)"></span><span>Contains ${w.name}</span></div>
        <div class="legend-row"><span class="swatch" style="background: rgb(38, 38, 38)"></span><span>Does not contain</span></div>
      `:e.innerHTML=`
        <div class="legend-gradient" style="background: linear-gradient(to right, #1f1a2e, #5a3f7a, #a060a0, #e090c0);"></div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
          <span>0</span>
          <span>Count</span>
          <span>Max</span>
        </div>
      `},getHoverInfo(e){if(!w)return null;const s=w.verses.find(o=>o.book===e.book&&o.chapter===e.chapter&&o.verse===e.verse);return s?`${w.name} ×${s.count}`:null}};function qt(e){_e=zt(e.verseTexts),K=Kt(_e),console.log(`Built trop index: ${K.length} marks found`),console.log("Rarest trop:",K.slice(0,5).map(s=>`${s.name} (${s.totalCount})`).join(", "))}function Jt(){return w}function Qt(e,s){const o=[];let n=0;for(;n<e.length;){const t=e[n];if(t===s)if(o.length>0){const i=[];for(;o.length>0;){const c=o[o.length-1].codePointAt(0)||0;if(c>=1425&&c<=1479)i.unshift(o.pop());else{i.unshift(o.pop());break}}i.push(t),o.push(`<mark class="trop-highlight">${i.join("")}</mark>`)}else o.push(`<mark class="trop-highlight">${t}</mark>`);else o.push(t);n++}return o.join("")}let Ye=[],R="",S=[],te=new Set,Q=null,ue=null,k=null,M=null,y=null,F=null;function Zt(e){var s;Ye=e.verses,(s=e.callbacks)!=null&&s.onVerseClick&&(ue=e.callbacks.onVerseClick)}function Ne(e){R=e,e.length<2?(S=[],te=new Set):(S=Tt(e),te=Ct(S)),Ue(),Q==null||Q()}function Ue(){if(!y)return;y.querySelectorAll(".search-result").forEach(n=>n.remove());const s=y.querySelector("#search-count");if(S.length===0){y.classList.remove("visible"),s&&(s.textContent="");return}s&&(s.textContent=`${S.length}${S.length>=100?"+":""} results`);const o=S.slice(0,10);for(const n of o){const t=document.createElement("div");t.className="search-result",t.innerHTML=`
      <div class="ref">${n.book} ${n.chapter}:${n.verse}</div>
      <div class="snippet ${n.language==="he"?"rtl":""}">${en(n.snippet,n.matchStart,n.matchEnd)}</div>
    `,t.addEventListener("click",()=>{const i=Ye.find(r=>r.book===n.book&&r.chapter===n.chapter&&r.verse===n.verse);i&&ue&&ue(i)}),y.appendChild(t)}y.classList.add("visible")}function en(e,s,o){const n=re(e.slice(0,s)),t=re(e.slice(s,o)),i=re(e.slice(o));return`${n}<mark>${t}</mark>${i}`}function re(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const tn={id:"search",name:"Text Search",getVerseColor(e){if(R.length<2)return null;const s=Y(e.book,e.chapter,e.verse);if(te.has(s))return Ht;const o=(.4+.2)*$t;return[o,o,o]},renderControls(e){e.innerHTML=`
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search Hebrew or English...">
        <button id="search-clear">&times;</button>
        <div id="search-results">
          <div id="search-count"></div>
        </div>
      </div>
    `,k=e.querySelector("#search-input"),M=e.querySelector("#search-clear"),y=e.querySelector("#search-results"),k&&R&&(k.value=R,M&&(M.style.display=R?"block":"none"),S.length>0&&Ue()),k==null||k.addEventListener("input",()=>{const s=k.value.trim();M&&(M.style.display=s?"block":"none"),Ne(s)}),M==null||M.addEventListener("click",()=>{k&&(k.value="",M.style.display="none"),Ne("")}),F=s=>{y&&!y.contains(s.target)&&s.target!==k&&s.target!==M&&y.classList.remove("visible")},document.addEventListener("click",F),k==null||k.addEventListener("focus",()=>{S.length>0&&(y==null||y.classList.add("visible"))})},renderLegend(e){S.length>0?e.innerHTML=`<div style="color: #888; font-size: 11px;">${S.length} matching verses highlighted</div>`:R.length>0&&R.length<2?e.innerHTML='<div style="color: #888; font-size: 11px;">Type at least 2 characters</div>':e.innerHTML='<div style="color: #888; font-size: 11px;">Type to search Hebrew or English text</div>'},getHoverInfo(e){if(R.length<2)return null;const s=Y(e.book,e.chapter,e.verse);if(!te.has(s))return null;const o=S.find(n=>n.book===e.book&&n.chapter===e.chapter&&n.verse===e.verse);return o?`Match: "${o.snippet.replace(/\.\.\./g,"").trim()}"`:"Match"},onUpdate(e){Q=e},destroy(){F&&(document.removeEventListener("click",F),F=null),k=null,M=null,y=null}};function He(e,s,o,n,t){const i=n/o-s.x,r=t/o-s.y;for(const c of e)if(i>=c.x&&i<c.x+c.size&&r>=c.y&&r<c.y+c.size)return c;return null}async function nn(){document.title="Tanakh Map [main]";const[e,s]=await Promise.all([fetch("/data/tanakh-structure.json"),wt()]);if(!e.ok)throw new Error(`Failed to load tanakh-structure.json: ${e.status}`);let o;try{o=await e.json()}catch(u){throw new Error(`Failed to parse tanakh-structure.json: ${u}`)}const n=mt(o),t=ft(n);console.log(`Loaded ${n.length} verses, bounds: ${t.width}x${t.height}`),Mt(s),G(Nt),G(It),G(Gt),G(tn),Bt({verses:n}),qt({verseTexts:s}),await Promise.all(Pt().map(u=>{var m;return(m=u.init)==null?void 0:m.call(u)}));const i=document.getElementById("canvas");if(!i)throw new Error("Canvas not found");const r=window.devicePixelRatio||1;function c(){const u=window.innerWidth,m=window.innerHeight;i.width=u*r,i.height=m*r,i.style.width=u+"px",i.style.height=m+"px"}c();const a=Je(i),h=Qe(a);let l=null,d;function g(){n.forEach((m,b)=>{const L=(l==null?void 0:l.getVerseColor(m))??null;if(L)m.color=L;else{const P=.4+q(b*3)*.4;m.color=[P,P,P]}});const u=Me(n,[.6,.6,.6]);a.bindBuffer(a.ARRAY_BUFFER,d),a.bufferData(a.ARRAY_BUFFER,u,a.STATIC_DRAW)}const f=Me(n);d=pt(a,f);const C=window.innerWidth,_=window.innerHeight;let v=1;const x={x:C/2-t.width/2,y:_/2-t.height/2};function A(){a.viewport(0,0,i.width,i.height),a.clearColor(.1,.1,.1,1),a.clear(a.COLOR_BUFFER_BIT),a.useProgram(h.program),a.uniform2f(h.uniforms.resolution,i.width,i.height),a.uniform2f(h.uniforms.pan,x.x,x.y),a.uniform1f(h.uniforms.zoom,v*r),a.bindBuffer(a.ARRAY_BUFFER,d);const u=7*4;a.enableVertexAttribArray(h.attribs.position),a.vertexAttribPointer(h.attribs.position,2,a.FLOAT,!1,u,0),a.enableVertexAttribArray(h.attribs.color),a.vertexAttribPointer(h.attribs.color,3,a.FLOAT,!1,u,2*4),a.enableVertexAttribArray(h.attribs.uv),a.vertexAttribPointer(h.attribs.uv,2,a.FLOAT,!1,u,5*4),a.drawArrays(a.TRIANGLES,0,n.length*6),window.bookLabels&&Te(window.bookLabels,x,v)}A(),window.bookLabels=vt(n,document.body),Te(window.bookLabels,x,v),i.addEventListener("wheel",u=>{u.preventDefault();const m=u.deltaY>0?.9:1.1;v=Math.max(.1,Math.min(10,v*m)),A()},{passive:!1});let O=!1,W={x:0,y:0};i.addEventListener("mousedown",u=>{O=!0,W={x:u.clientX,y:u.clientY}}),i.addEventListener("mousemove",u=>{if(O){const m=u.clientX-W.x,b=u.clientY-W.y;x.x+=m/v,x.y+=b/v,W={x:u.clientX,y:u.clientY},A()}}),i.addEventListener("mouseup",()=>{O=!1}),i.addEventListener("mouseleave",()=>{O=!1});const p=document.getElementById("verse-sidebar"),me=p==null?void 0:p.querySelector(".ref-text"),ne=p==null?void 0:p.querySelector(".verse-hebrew"),fe=p==null?void 0:p.querySelector(".verse-english"),pe=p==null?void 0:p.querySelector(".sefaria-link"),ge=p==null?void 0:p.querySelector(".link-subtitle"),oe=p==null?void 0:p.querySelector(".close-btn"),ve=document.getElementById("controls");function be(){if(!p||!ve)return;const u=ve.getBoundingClientRect();p.style.top=`${u.bottom+10}px`}function We(u,m,b){return`https://www.sefaria.org/${u.replace(/ /g,"_")}.${m}.${b}`}let E=null;function N(u,m=!1){if(!p)return;if(!u){p.classList.remove("visible"),p.classList.remove("pinned");return}const b=kt(s,u.book,u.chapter,u.verse);if(me&&(me.textContent=`${u.book} ${u.chapter}:${u.verse}`),ne){const L=(b==null?void 0:b.he)||"Loading...",P=Jt();(l==null?void 0:l.id)==="trop"&&P?ne.innerHTML=Qt(L,P.unicode):ne.textContent=L}if(fe&&(fe.textContent=(b==null?void 0:b.en)||"Loading..."),pe&&(pe.href=We(u.book,u.chapter,u.verse)),ge){const L=jt(u.book,u.chapter,u.verse);ge.textContent=L?`${L} linked texts`:""}be(),p.classList.add("visible"),m?p.classList.add("pinned"):p.classList.remove("pinned")}i.addEventListener("mousemove",u=>{if(!O){const m=He(n,x,v,u.clientX,u.clientY);E||(m?N(m,!1):N(null))}}),i.addEventListener("click",u=>{const m=He(n,x,v,u.clientX,u.clientY);m?E&&E.book===m.book&&E.chapter===m.chapter&&E.verse===m.verse?(E=null,N(null)):(E=m,N(m,!0)):E&&(E=null,N(null))}),oe==null||oe.addEventListener("click",()=>{E=null,N(null)});const X=document.getElementById("overlay-select"),ie=document.getElementById("overlay-controls"),H=document.getElementById("overlay-legend");function Xe(u){var m,b,L,P;(m=l==null?void 0:l.destroy)==null||m.call(l),l=At(u)??null,(b=l==null?void 0:l.onUpdate)==null||b.call(l,()=>{var we;g(),H&&(H.innerHTML="",(we=l==null?void 0:l.renderLegend)==null||we.call(l,H)),A()}),ie&&(ie.innerHTML="",(L=l==null?void 0:l.renderControls)==null||L.call(l,ie)),H&&(H.innerHTML="",(P=l==null?void 0:l.renderLegend)==null||P.call(l,H)),g(),A(),requestAnimationFrame(be)}X==null||X.addEventListener("change",()=>{Xe(X.value)}),window.addEventListener("resize",()=>{c(),A()}),window.torahMap={verses:n,pan:x,zoom:v,render:A,canvas:i,bounds:t},Zt({verses:n,callbacks:{onVerseClick:u=>{E=u,N(u,!0)}}})}nn().catch(console.error);
