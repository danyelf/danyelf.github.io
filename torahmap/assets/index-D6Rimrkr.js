(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=i(t);fetch(t.href,s)}})();const Ze=`#version 300 es
  uniform vec2 u_resolution;
  uniform vec2 u_pan;
  uniform float u_zoom;

  in vec2 a_position;
  in vec3 a_color;
  in vec2 a_uv;

  out vec3 v_color;
  out vec2 v_uv;

  void main() {
    vec2 pos = (a_position + u_pan) * u_zoom;
    vec2 clipSpace = (pos / u_resolution) * 2.0 - 1.0;
    gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
    v_color = a_color;
    v_uv = a_uv;
  }
`,Qe=`#version 300 es
  precision mediump float;
  in vec3 v_color;
  in vec2 v_uv;
  out vec4 fragColor;

  // Simple hash for dithering noise
  float hash(vec2 p) {
    return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
  }

  void main() {
    // Add dithering noise to break up moiré patterns
    float noise = (hash(gl_FragCoord.xy) - 0.5) * 0.15;
    vec3 color = v_color + noise;
    fragColor = vec4(color, 1.0);
  }
`;function et(e){const o=e.getContext("webgl2",{antialias:!0});if(!o)throw new Error("WebGL2 not supported");return o}function Le(e,o,i){const n=e.createShader(o);if(!n)throw new Error("Failed to create shader");if(e.shaderSource(n,i),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n)||"Shader compilation failed");return n}function tt(e){const o=Le(e,e.VERTEX_SHADER,Ze),i=Le(e,e.FRAGMENT_SHADER,Qe),n=e.createProgram();if(!n)throw new Error("Failed to create program");if(e.attachShader(n,o),e.attachShader(n,i),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(n)||"Program linking failed");return{program:n,attribs:{position:e.getAttribLocation(n,"a_position"),color:e.getAttribLocation(n,"a_color"),uv:e.getAttribLocation(n,"a_uv")},uniforms:{resolution:e.getUniformLocation(n,"u_resolution"),pan:e.getUniformLocation(n,"u_pan"),zoom:e.getUniformLocation(n,"u_zoom")}}}function Q(e){const o=Math.sin(e*12.9898+e*78.233)*43758.5453;return o-Math.floor(o)}const q=[{name:"Genesis",file:"genesis",section:"torah"},{name:"Exodus",file:"exodus",section:"torah"},{name:"Leviticus",file:"leviticus",section:"torah"},{name:"Numbers",file:"numbers",section:"torah"},{name:"Deuteronomy",file:"deuteronomy",section:"torah"},{name:"Joshua",file:"joshua",section:"neviim"},{name:"Judges",file:"judges",section:"neviim"},{name:"I Samuel",file:"i-samuel",section:"neviim"},{name:"II Samuel",file:"ii-samuel",section:"neviim"},{name:"I Kings",file:"i-kings",section:"neviim"},{name:"II Kings",file:"ii-kings",section:"neviim"},{name:"Isaiah",file:"isaiah",section:"neviim"},{name:"Jeremiah",file:"jeremiah",section:"neviim"},{name:"Ezekiel",file:"ezekiel",section:"neviim"},{name:"Hosea",file:"hosea",section:"neviim"},{name:"Joel",file:"joel",section:"neviim"},{name:"Amos",file:"amos",section:"neviim"},{name:"Obadiah",file:"obadiah",section:"neviim"},{name:"Jonah",file:"jonah",section:"neviim"},{name:"Micah",file:"micah",section:"neviim"},{name:"Nahum",file:"nahum",section:"neviim"},{name:"Habakkuk",file:"habakkuk",section:"neviim"},{name:"Zephaniah",file:"zephaniah",section:"neviim"},{name:"Haggai",file:"haggai",section:"neviim"},{name:"Zechariah",file:"zechariah",section:"neviim"},{name:"Malachi",file:"malachi",section:"neviim"},{name:"Psalms",file:"psalms",section:"ketuvim"},{name:"Proverbs",file:"proverbs",section:"ketuvim"},{name:"Job",file:"job",section:"ketuvim"},{name:"Song of Songs",file:"song-of-songs",section:"ketuvim"},{name:"Ruth",file:"ruth",section:"ketuvim"},{name:"Lamentations",file:"lamentations",section:"ketuvim"},{name:"Ecclesiastes",file:"ecclesiastes",section:"ketuvim"},{name:"Esther",file:"esther",section:"ketuvim"},{name:"Daniel",file:"daniel",section:"ketuvim"},{name:"Ezra",file:"ezra",section:"ketuvim"},{name:"Nehemiah",file:"nehemiah",section:"ketuvim"},{name:"I Chronicles",file:"i-chronicles",section:"ketuvim"},{name:"II Chronicles",file:"ii-chronicles",section:"ketuvim"}],nt=q.map(e=>e.name),ot=new Set(q.filter(e=>e.section==="torah").map(e=>e.name));new Set(q.filter(e=>e.section==="neviim").map(e=>e.name));const it=new Set(q.filter(e=>e.section==="ketuvim").map(e=>e.name));Object.fromEntries(q.map(e=>[e.name,e.file]));function st(e){return ot.has(e)?"torah":it.has(e)?"ketuvim":"neviim"}const F=6,Me=2,W=12,Se=70,Oe=35,z=50,rt=12,Te=3,Ee=15,at=72,Be=[["Hosea","Joel"],["Amos","Obadiah","Jonah"],["Micah","Nahum","Habakkuk","Zephaniah","Haggai"],["Zechariah","Malachi"]],Ce=new Set(Be.flat()),je=[{books:["Song of Songs","Ruth","Lamentations"],insertAfter:"Job"},{books:["Ecclesiastes","Esther"],insertAfter:"Job"},{books:["Ezra","Nehemiah"],insertAfter:"Daniel"}],ct=new Set(je.flatMap(e=>e.books));function lt(e){if(e<=z)return[e];const o=[];let i=e;for(;i>0;)if(i<=z)o.push(i),i=0;else if(i<=z+Te-1){const n=i-Te;o.push(n),i-=n}else o.push(z),i-=z;return o}function he(e,o,i,n,t,s,a){const c=lt(i);let r=0,u=t,l=0;for(let d=0;d<c.length;d++){const f=c[d],m=d>0?rt:0;for(let x=0;x<f;x++){const N=(Q(s.value*2)-.5)*2,v=(Q(s.value*2+1)-.5)*2,k=.4+Q(s.value*3)*.4,w=n+m+x*F+N;a.push({book:e,chapter:o+1,verse:l+1,x:w,y:u+v,size:F,color:[k,k,k]}),r=Math.max(r,m+(x+1)*F),l++,s.value++}u+=F+Me}return{width:r,height:c.length*(F+Me)}}function pe(e,o,i,n,t){let s=0,a=i;for(let c=0;c<e.chapters.length;c++){const r=e.chapters[c],{width:u,height:l}=he(e.name,c,r,o,a,n,t);s=Math.max(s,u),a+=l}return{width:s,height:a-i}}function Fe(e,o,i,n,t,s,a=pe){let c=o,r=0;for(const u of e){const{width:l,height:d}=a(u,c,i,t,s);r=Math.max(r,d),c+=l+n}return{width:c-o-(e.length>0?n:0),height:r,nextX:c}}function ze(e,o,i,n,t,s,a){let c=n,r=0;for(const l of e){const d=o.get(l);if(!d)continue;const{width:f,height:m}=pe(d,i,c,s,a);r=Math.max(r,f),c+=m+t}const u=c-n-(e.length>0?t:0);return{width:r,height:u}}function ut(e,o,i,n,t,s,a,c){let r=i,u=0;for(const l of e){const{width:d,height:f}=ze(l,o,r,n,t,a,c);u=Math.max(u,f),r+=d+s}return{width:r-i-(e.length>0?s:0),height:u}}function ht(e,o,i,n,t){const s=at;let a=i,c=0;for(let m=0;m<s;m++){const x=e.chapters[m],{width:N,height:v}=he(e.name,m,x,o,a,n,t);c=Math.max(c,N),a+=v}const r=a-i,u=o+c+Ee;let l=i,d=0;for(let m=s;m<e.chapters.length;m++){const x=e.chapters[m],{width:N,height:v}=he(e.name,m,x,u,l,n,t);d=Math.max(d,N),l+=v}const f=l-i;return{width:c+Ee+d,height:Math.max(r,f)}}function mt(e,o,i,n){const t=e.filter(l=>!Ce.has(l.name)),s=e.filter(l=>Ce.has(l.name)),a=new Map(s.map(l=>[l.name,l])),{height:c,nextX:r}=Fe(t,0,o,W,i,n),{height:u}=ut(Be,a,r,o,Oe,W,i,n);return Math.max(c,u)}function dt(e,o,i,n){const t=new Map(e.map(r=>[r.name,r]));let s=0,a=0;const c=e.filter(r=>!ct.has(r.name));for(const r of c){const{width:u,height:l}=r.name==="Psalms"?ht(r,s,o,i,n):pe(r,s,o,i,n);a=Math.max(a,l),s+=u+W;for(const d of je)if(r.name===d.insertAfter){const{width:f,height:m}=ze(d.books,t,s,o,Oe,i,n);a=Math.max(a,m),s+=f+W}}return a}function ft(e,o,i,n){const{height:t}=Fe(e,0,o,W,i,n);return t}function pt(e){const o=[],i={value:0},n=[],t=[],s=[];for(const u of e.books){const l=st(u.name);l==="torah"?n.push(u):l==="neviim"?t.push(u):s.push(u)}let a=0;const c=ft(n,a,i,o);a+=c+Se;const r=mt(t,a,i,o);return a+=r+Se,dt(s,a,i,o),o}function gt(e){let o=0,i=0;for(const n of e)o=Math.max(o,n.x+n.size),i=Math.max(i,n.y+n.size);return{width:o,height:i}}function Ae(e,o=[.6,.6,.6]){const t=new Float32Array(e.length*6*7);let s=0;for(const a of e){const c=a.x,r=a.y,u=a.x+a.size-2,l=a.y+a.size-2,[d,f,m]=a.color||o;t[s++]=c,t[s++]=r,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=0,t[s++]=0,t[s++]=u,t[s++]=r,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=1,t[s++]=0,t[s++]=c,t[s++]=l,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=0,t[s++]=1,t[s++]=c,t[s++]=l,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=0,t[s++]=1,t[s++]=u,t[s++]=r,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=1,t[s++]=0,t[s++]=u,t[s++]=l,t[s++]=d,t[s++]=f,t[s++]=m,t[s++]=1,t[s++]=1}return t}function vt(e,o){const i=e.createBuffer();if(!i)throw new Error("Failed to create buffer");return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),i}const bt=-20;function wt(e,o){const i={};for(const t of e)i[t.book]||(i[t.book]={minX:t.x,maxX:t.x+t.size,minY:t.y}),i[t.book].maxX=Math.max(i[t.book].maxX,t.x+t.size),i[t.book].minY=Math.min(i[t.book].minY,t.y);const n=document.createElement("div");n.id="book-labels",n.style.cssText="position:fixed;top:0;left:0;pointer-events:none;";for(const[t,s]of Object.entries(i)){const a=document.createElement("div");a.textContent=t,a.style.cssText=`
      position:absolute;
      color:#666;
      font-family:sans-serif;
      font-size:12px;
      white-space:nowrap;
    `,a.dataset.bookName=t,a.dataset.leftX=String(s.minX),a.dataset.topY=String(s.minY),n.appendChild(a)}return o.appendChild(n),n}function Pe(e,o,i){for(const n of e.children)if(n instanceof HTMLElement){const t=parseFloat(n.dataset.leftX||"0"),s=parseFloat(n.dataset.topY||"0"),a=(t+o.x)*i,c=(s+o.y)*i+bt;n.style.left=a+"px",n.style.top=c+"px"}}async function kt(){const e=await fetch("/torahmap/data/all-texts.json");if(!e.ok)return console.error(`Failed to load verse texts: ${e.status}`),{};const o=await e.json();return console.log(`Loaded verse texts for ${Object.keys(o).length} books`),o}function yt(e,o,i,n){var t,s;return((s=(t=e[o])==null?void 0:t[String(i)])==null?void 0:s[String(n)])||null}function X(e,o,i){return`${e}:${o}:${i}`}const xt=1424,Lt=1535,Mt=1425,St=1479;let ee=[];function oe(e){let o="";for(const i of e){const n=i.charCodeAt(0);(n<Mt||n>St||n===1470||n===1472||n===1475||n===1478)&&(o+=i)}return o}function De(e){return e.split(",").map(o=>o.trim()).filter(o=>o.length>=2)}function Tt(e){for(const o of e){const i=o.charCodeAt(0);if(i>=xt&&i<=Lt)return!0}return!1}function Et(e){ee=[];for(const o of nt){const i=e[o];if(!i)continue;const n=Object.keys(i).map(Number).sort((t,s)=>t-s);for(const t of n){const s=i[String(t)],a=Object.keys(s).map(Number).sort((c,r)=>c-r);for(const c of a){const{he:r,en:u}=s[String(c)];ee.push({book:o,chapter:t,verse:c,hebrewText:oe(r),hebrewOriginal:r,englishText:u.toLowerCase(),englishOriginal:u})}}}console.log(`Search index built with ${ee.length} verses`)}function Ct(e){const o=De(e);if(o.length===0)return[];const i=Tt(o[0]),n=new Map;for(let t=0;t<o.length;t++){const s=o[t],a=i?oe(s):s.toLowerCase();for(const c of ee){const r=i?c.hebrewText:c.englishText,u=i?c.hebrewOriginal:c.englishOriginal,l=r.indexOf(a);if(l!==-1){const d=`${c.book}:${c.chapter}:${c.verse}`,f=At(u,l,a.length);let m=n.get(d);m||(m={book:c.book,chapter:c.chapter,verse:c.verse,language:i?"he":"en",matchingTerms:[]},n.set(d,m)),m.matchingTerms.some(x=>x.termIndex===t)||m.matchingTerms.push({termIndex:t,snippet:f.text,matchStart:f.matchStart,matchEnd:f.matchEnd})}}}return Array.from(n.values())}function At(e,o,i){let s=Math.max(0,o-20),a=Math.min(e.length,s+60);a===e.length&&a-s<60&&(s=Math.max(0,a-60));let c=e.slice(s,a);const r=o-s,u=r+i;return s>0&&(c="..."+c),a<e.length&&(c=c+"..."),{text:c,matchStart:s>0?r+3:r,matchEnd:s>0?u+3:u}}function Pt(e){const o=new Map;for(const i of e){const n=X(i.book,i.chapter,i.verse);o.set(n,i.matchingTerms.map(t=>t.termIndex))}return o}const ge=new Map;function Z(e){ge.set(e.id,e)}function Rt(e){return ge.get(e)}function Nt(){return Array.from(ge.values())}const _t={1:[.3,.5,.9],2:[.9,.3,.3],3:[.7,.3,.8]},Ht={1:"YHWH",2:"Elohim",3:"YHWH + Elohim"};let ue={};const $t={id:"divine-names",name:"Divine Names",async init(){try{const e=await fetch("/torahmap/data/divine-names.json");if(!e.ok){console.error(`Failed to load divine-names.json: ${e.status}`);return}ue=await e.json()}catch(e){console.error("Failed to parse divine-names.json:",e)}},getVerseColor(e){var i,n;const o=((n=(i=ue[e.book])==null?void 0:i[e.chapter-1])==null?void 0:n[e.verse-1])??0;return o>0?_t[o]??null:null},renderLegend(e){e.innerHTML=`
      <div class="legend-row"><span class="swatch" style="background: rgb(77, 128, 230)"></span><span>YHWH</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(230, 77, 77)"></span><span>Elohim</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(179, 77, 204)"></span><span>Both</span></div>
    `},getHoverInfo(e){var i,n;const o=((n=(i=ue[e.book])==null?void 0:i[e.chapter-1])==null?void 0:n[e.verse-1])??0;return o>0?Ht[o]:null}},It=.3,B=[[.2,.9,1],[1,.5,0],[.5,1,.2],[1,.2,.8],[1,1,.2]];function Ot(e,o){if(e===0)return[.15,.15,.2];const i=Math.log(o+1),n=Math.log(e+1)/i;if(n<.25){const t=n/.25;return[.1,.13+t*.1,.18+t*.2]}else if(n<.5){const t=(n-.25)/.25;return[.1+t*.1,.23+t*.2,.38-t*.05]}else if(n<.75){const t=(n-.5)/.25;return[.2+t*.7,.43-t*.1,.33-t*.2]}else{const t=(n-.75)/.25;return[.9+t*.1,.33-t*.1,.13+t*.05]}}function Bt(e){const[o,i,n]=e,t=Math.max(o,i,n),s=Math.min(o,i,n),a=(t+s)/2;if(t===s)return{h:0,s:0,l:a};const c=t-s,r=a>.5?c/(2-t-s):c/(t+s);let u;return t===o?u=((i-n)/c+(i<n?6:0))/6:t===i?u=((n-o)/c+2)/6:u=((o-i)/c+4)/6,{h:u*360,s:r,l:a}}function jt(e){const{h:o,s:i,l:n}=e;if(i===0)return[n,n,n];const t=(r,u,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<1/6?r+(u-r)*6*l:l<1/2?u:l<2/3?r+(u-r)*(2/3-l)*6:r),s=n<.5?n*(1+i):n+i-n*i,a=2*n-s,c=o/360;return[t(a,s,c+1/3),t(a,s,c),t(a,s,c-1/3)]}function Ft(e){let o=0,i=0;for(const s of e){const a=s*Math.PI/180;o+=Math.sin(a),i+=Math.cos(a)}let t=Math.atan2(o/e.length,i/e.length)*180/Math.PI;return t<0&&(t+=360),t}function zt(e){if(e.length===0)return[0,0,0];if(e.length===1)return e[0];const o=e.map(Bt),i=Ft(o.map(s=>s.h)),n=o.reduce((s,a)=>s+a.s,0)/o.length,t=o.reduce((s,a)=>s+a.l,0)/o.length;return jt({h:i,s:n,l:t})}let ie={},P="total",D=null,j={},Ve=[];function Ke(e,o,i){var t,s;const n=(s=(t=ie[e])==null?void 0:t[String(o)])==null?void 0:s[String(i)];return n?P==="total"?n.total:n.categories[P]||0:0}function Re(){if(j[P]!==void 0)return j[P];let e=0;for(const o of Ve){const i=Ke(o.book,o.chapter,o.verse);i>e&&(e=i)}return j[P]=e,e}const Dt={id:"commentary",name:"Commentary Density",async init(){try{const e=await fetch("/torahmap/data/commentary-counts.json");if(!e.ok){console.error(`Failed to load commentary-counts.json: ${e.status}`);return}ie=await e.json()}catch(e){console.error("Failed to parse commentary-counts.json:",e)}},destroy(){P="total",j={},D=null},onUpdate(e){D=e},getVerseColor(e){const o=Ke(e.book,e.chapter,e.verse),i=Re();return Ot(o,i)},renderControls(e){const o=document.createElement("div");o.className="commentary-controls",o.innerHTML=`
      <label for="category-select">Category:</label>
      <select id="category-select">
        <option value="total">All Commentary</option>
        <option value="Tanakh">Tanakh</option>
        <option value="Talmud">Talmud</option>
        <option value="Midrash">Midrash</option>
        <option value="Halakhah">Halakhah</option>
        <option value="Kabbalah">Kabbalah</option>
      </select>
    `;const i=o.querySelector("select");i.value=P,i.addEventListener("change",()=>{P=i.value,j={},D==null||D()}),e.appendChild(o)},renderLegend(e){const o=Re(),i=Math.log(o+1),n=[0];let t=1;for(;t<=o;)n.push(t),t*=10;n[n.length-1]<o&&n.push(o),e.innerHTML=`
      <div class="legend-gradient"></div>
      <div class="legend-ticks">
        ${n.map(s=>{const a=s===0?0:Math.log(s+1)/i*100,c=s>=1e3?`${s/1e3}k`:String(s);return`<span class="tick" style="left: ${a}%">${c}</span>`}).join("")}
      </div>
    `},getHoverInfo(e){var n,t;const o=(t=(n=ie[e.book])==null?void 0:n[String(e.chapter)])==null?void 0:t[String(e.verse)];if(!o)return null;if(P==="total")return`${o.total} links`;const i=o.categories[P];return i?`${i} ${P}`:null}};function Vt(e){Ve=e.verses,j={}}function Kt(e,o,i){var t,s;const n=(s=(t=ie[e])==null?void 0:t[String(o)])==null?void 0:s[String(i)];return(n==null?void 0:n.total)??null}const Ye=[{unicode:"֒",codePoint:1426,name:"Segol",hebrewName:"סגול"},{unicode:"֓",codePoint:1427,name:"Shalshelet",hebrewName:"שלשלת"},{unicode:"֔",codePoint:1428,name:"Zaqef Qatan",hebrewName:"זקף קטן"},{unicode:"֕",codePoint:1429,name:"Zaqef Gadol",hebrewName:"זקף גדול"},{unicode:"֖",codePoint:1430,name:"Tipcha",hebrewName:"טפחא"},{unicode:"֗",codePoint:1431,name:"Revia",hebrewName:"רביע"},{unicode:"֘",codePoint:1432,name:"Zarqa",hebrewName:"זרקא"},{unicode:"֙",codePoint:1433,name:"Pashta",hebrewName:"פשטא"},{unicode:"֚",codePoint:1434,name:"Yetiv",hebrewName:"יתיב"},{unicode:"֛",codePoint:1435,name:"Tevir",hebrewName:"תביר"},{unicode:"֜",codePoint:1436,name:"Geresh",hebrewName:"גרש"},{unicode:"֝",codePoint:1437,name:"Geresh Muqdam",hebrewName:"גרש מוקדם"},{unicode:"֞",codePoint:1438,name:"Gershayim",hebrewName:"גרשיים"},{unicode:"֟",codePoint:1439,name:"Karnei Parah",hebrewName:"קרני פרה"},{unicode:"֠",codePoint:1440,name:"Telisha Gedola",hebrewName:"תלישא גדולה"},{unicode:"֡",codePoint:1441,name:"Pazer",hebrewName:"פזר"},{unicode:"֣",codePoint:1443,name:"Munach",hebrewName:"מונח"},{unicode:"֤",codePoint:1444,name:"Mahapakh",hebrewName:"מהפך"},{unicode:"֥",codePoint:1445,name:"Merkha",hebrewName:"מרכא"},{unicode:"֦",codePoint:1446,name:"Merkha Kefula",hebrewName:"מרכא כפולה"},{unicode:"֧",codePoint:1447,name:"Darga",hebrewName:"דרגא"},{unicode:"֨",codePoint:1448,name:"Qadma",hebrewName:"קדמא"},{unicode:"֩",codePoint:1449,name:"Telisha Qetana",hebrewName:"תלישא קטנה"},{unicode:"֪",codePoint:1450,name:"Yerah Ben Yomo",hebrewName:"ירח בן יומו"},{unicode:"֫",codePoint:1451,name:"Ole",hebrewName:"עולה"},{unicode:"֬",codePoint:1452,name:"Iluy",hebrewName:"אילוי"},{unicode:"֭",codePoint:1453,name:"Dehi",hebrewName:"דחי"},{unicode:"֮",codePoint:1454,name:"Zinor",hebrewName:"זינור"},{unicode:"֑",codePoint:1425,name:"Etnachta",hebrewName:"אתנחתא"},{unicode:"֢",codePoint:1442,name:"Atnah Hafukh",hebrewName:"אתנח הפוך"},{unicode:"֯",codePoint:1455,name:"Masora Circle",hebrewName:"עיגול מסורה"}];new Map(Ye.map(e=>[e.unicode,e]));const Ne={RARE:50,UNCOMMON:500};function se(e){return e<Ne.RARE?"rare":e<Ne.UNCOMMON?"uncommon":"common"}function Yt(e){const o=[];for(const i of e){const n=i.codePointAt(0);n&&n>=1425&&n<=1455&&o.push(i)}return o}function Ut(e){const o=new Map,i=Yt(e);for(const n of i)o.set(n,(o.get(n)||0)+1);return o}function Wt(e){const o=new Map;for(const i of Ye)o.set(i.unicode,{unicode:i.unicode,name:i.name,hebrewName:i.hebrewName,totalCount:0,verses:[]});for(const[i,n]of Object.entries(e))for(const[t,s]of Object.entries(n)){const a=parseInt(t,10);for(const[c,r]of Object.entries(s)){const u=parseInt(c,10),l=Ut(r.he);for(const[d,f]of l){const m=o.get(d);m&&(m.totalCount+=f,m.verses.push({book:i,chapter:a,verse:u,count:f}))}}}return o}function Xt(e){return Array.from(e.values()).filter(o=>o.totalCount>0).sort((o,i)=>o.totalCount-i.totalCount)}let _e=new Map,U=[],M=null,te=null,me=new Map,K=1,Ue=0,de="common";const qt=[1,.84,0],Gt=[.15,.15,.15];function Jt(){if(me.clear(),!!M){de=se(M.totalCount);for(const e of M.verses){const o=X(e.book,e.chapter,e.verse);me.set(o,e.count)}K=1;for(const e of M.verses)e.count>K&&(K=e.count);Ue=Math.log(K+1)}}function Zt(e){if(!M)return null;const o=X(e.book,e.chapter,e.verse),i=me.get(o)||0;if(de==="rare")return i>0?qt:Gt;if(de==="uncommon"){if(i===0)return[.12,.12,.15];const n=i/K;return[.4+n*.5,.2+n*.2,.6+n*.35]}else{if(i===0)return[.12,.1,.15];const n=Math.log(i+1)/Ue;if(n<.33){const t=n/.33;return[.2+t*.2,.1+t*.1,.3+t*.2]}else if(n<.66){const t=(n-.33)/.33;return[.4+t*.3,.2+t*.1,.5+t*.2]}else{const t=(n-.66)/.34;return[.7+t*.25,.3+t*.3,.7+t*.2]}}}function Qt(e){e.innerHTML=`
    <div class="trop-controls">
      <label style="margin-bottom: 8px;">Select Trop Mark</label>
      <div class="trop-chart"></div>
      <div class="trop-info"></div>
    </div>
  `;const o=e.querySelector(".trop-chart"),i=e.querySelector(".trop-info");let n=null;for(const t of U){const s=document.createElement("button");s.textContent="ב"+t.unicode,s.title=`${t.name} (${t.hebrewName})`;const a=se(t.totalCount);a==="rare"&&s.classList.add("rare"),s.addEventListener("mouseenter",()=>{const c=a==="rare"?"Rare":a==="uncommon"?"Uncommon":"Common";i.textContent=`${t.name} (${t.hebrewName}) · ${t.totalCount.toLocaleString()} occurrences · ${c}`}),s.addEventListener("mouseleave",()=>{if(!n)i.textContent="";else{const c=U.find(r=>r.unicode===(n==null?void 0:n.dataset.unicode));if(c){const r=se(c.totalCount),u=r==="rare"?"Rare":r==="uncommon"?"Uncommon":"Common";i.textContent=`${c.name} (${c.hebrewName}) · ${c.totalCount.toLocaleString()} · ${u}`}}}),s.addEventListener("click",()=>{n===s?(s.classList.remove("selected"),n=null,M=null,i.textContent=""):(n&&n.classList.remove("selected"),s.classList.add("selected"),n=s,M=t),Jt(),te==null||te()}),s.dataset.unicode=t.unicode,o.appendChild(s)}}const en={id:"trop",name:"Cantillation (Trop)",async init(){},destroy(){M=null},onUpdate(e){te=e},getVerseColor(e){return Zt(e)},renderControls(e){Qt(e)},renderLegend(e){if(!M){e.innerHTML='<div style="color: #666; font-size: 11px;">Select a trop mark above</div>';return}se(M.totalCount)==="rare"?e.innerHTML=`
        <div class="legend-row"><span class="swatch" style="background: rgb(255, 214, 0)"></span><span>Contains ${M.name}</span></div>
        <div class="legend-row"><span class="swatch" style="background: rgb(38, 38, 38)"></span><span>Does not contain</span></div>
      `:e.innerHTML=`
        <div class="legend-gradient" style="background: linear-gradient(to right, #1f1a2e, #5a3f7a, #a060a0, #e090c0);"></div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
          <span>0</span>
          <span>Count</span>
          <span>Max</span>
        </div>
      `},getHoverInfo(e){if(!M)return null;const o=M.verses.find(i=>i.book===e.book&&i.chapter===e.chapter&&i.verse===e.verse);return o?`${M.name} ×${o.count}`:null}};function tn(e){_e=Wt(e.verseTexts),U=Xt(_e),console.log(`Built trop index: ${U.length} marks found`),console.log("Rarest trop:",U.slice(0,5).map(o=>`${o.name} (${o.totalCount})`).join(", "))}function nn(){return M}function on(e,o){const i=[];let n=0;for(;n<e.length;){const t=e[n];if(t===o)if(i.length>0){const s=[];for(;i.length>0;){const c=i[i.length-1].codePointAt(0)||0;if(c>=1425&&c<=1479)s.unshift(i.pop());else{s.unshift(i.pop());break}}s.push(t),i.push(`<mark class="trop-highlight">${s.join("")}</mark>`)}else i.push(`<mark class="trop-highlight">${t}</mark>`);else i.push(t);n++}return i.join("")}function We(e){return`rgb(${Math.round(e[0]*255)}, ${Math.round(e[1]*255)}, ${Math.round(e[2]*255)})`}let Xe=[],Y="",E=[],R=[],re=new Map,ne=null,fe=null,S=null,A=null,T=null,V=null;function sn(e){var o;Xe=e.verses,(o=e.callbacks)!=null&&o.onVerseClick&&(fe=e.callbacks.onVerseClick)}function He(e){Y=e,E=De(e),E.length===0?(R=[],re=new Map):(R=Ct(e),re=Pt(R)),qe(),ne==null||ne()}function qe(){if(!T)return;T.querySelectorAll(".search-result").forEach(n=>n.remove());const o=T.querySelector("#search-count");if(R.length===0){T.classList.remove("visible"),o&&(o.textContent="");return}if(o){const n=E.length>1?` (${E.length} terms)`:"";o.textContent=`${R.length}${R.length>=100?"+":""} results${n}`}const i=R.slice(0,10);for(const n of i){const t=document.createElement("div");t.className="search-result";const s=n.matchingTerms.map(r=>{const u=B[r.termIndex%B.length];return`<span class="term-dot" style="background: ${We(u)}"></span>`}).join(""),a=n.matchingTerms[0],c=rn(a.snippet,a.matchStart,a.matchEnd,a.termIndex);t.innerHTML=`
      <div class="ref">
        <span class="term-indicators">${s}</span>
        ${n.book} ${n.chapter}:${n.verse}
      </div>
      <div class="snippet ${n.language==="he"?"rtl":""}">${c}</div>
    `,t.addEventListener("click",()=>{const r=Xe.find(u=>u.book===n.book&&u.chapter===n.chapter&&u.verse===n.verse);r&&fe&&fe(r)}),T.appendChild(t)}T.classList.add("visible")}function rn(e,o,i,n){const t=H(e.slice(0,o)),s=H(e.slice(o,i)),a=H(e.slice(i));return`${t}<mark class="term-${n%5}">${s}</mark>${a}`}function H(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function $e(e,o){if(E.length===0)return H(e);const i=o==="he",n=[],t=i?oe(e):e.toLowerCase();for(let r=0;r<E.length;r++){const u=E[r],l=i?oe(u):u.toLowerCase();let d=0;for(;;){const f=t.indexOf(l,d);if(f===-1)break;let m=f,x=f+l.length;if(i){let N=0,v=0;for(let w=0;w<e.length&&v<f;w++){const b=e.charCodeAt(w);b>=1425&&b<=1479&&b!==1470&&b!==1472&&b!==1475&&b!==1478?N++:v++}m=f+N;let k=0;v=0;for(let w=m;w<e.length&&v<l.length;w++){const b=e.charCodeAt(w);b>=1425&&b<=1479&&b!==1470&&b!==1472&&b!==1475&&b!==1478?k++:v++}x=m+l.length+k}n.push({start:m,end:x,termIndex:r}),d=f+1}}if(n.length===0)return H(e);n.sort((r,u)=>r.start-u.start||u.end-r.end);const s=[];for(const r of n)(s.length===0||r.start>=s[s.length-1].end)&&s.push(r);let a="",c=0;for(const r of s)r.start>c&&(a+=H(e.slice(c,r.start))),a+=`<mark class="term-${r.termIndex%5}">${H(e.slice(r.start,r.end))}</mark>`,c=r.end;return c<e.length&&(a+=H(e.slice(c))),a}const an={id:"search",name:"Text Search",getVerseColor(e){if(E.length===0)return null;const o=X(e.book,e.chapter,e.verse),i=re.get(o);if(i&&i.length>0){const t=i.map(s=>B[s%B.length]);return t.length===1?t[0]:zt(t)}const n=(.4+.2)*It;return[n,n,n]},renderControls(e){e.innerHTML=`
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search Hebrew or English...">
        <button id="search-clear">&times;</button>
        <div id="search-results">
          <div id="search-count"></div>
        </div>
      </div>
    `,S=e.querySelector("#search-input"),A=e.querySelector("#search-clear"),T=e.querySelector("#search-results"),S&&Y&&(S.value=Y,A&&(A.style.display=Y?"block":"none"),R.length>0&&qe()),S==null||S.addEventListener("input",()=>{const o=S.value.trim();A&&(A.style.display=o?"block":"none"),He(o)}),A==null||A.addEventListener("click",()=>{S&&(S.value="",A.style.display="none"),He("")}),V=o=>{T&&!T.contains(o.target)&&o.target!==S&&o.target!==A&&T.classList.remove("visible")},document.addEventListener("click",V),S==null||S.addEventListener("focus",()=>{R.length>0&&(T==null||T.classList.add("visible"))})},renderLegend(e){if(E.length>0&&R.length>0){const o=E.map((i,n)=>{const t=B[n%B.length];return`<span class="legend-term">
            <span class="color-swatch" style="background: ${We(t)}"></span>
            "${i}"
          </span>`}).join(" ");e.innerHTML=`<div class="search-legend">${o}</div>
        <div style="color: #888; font-size: 11px; margin-top: 4px;">${R.length} matching verses</div>`}else Y.length>0&&E.length===0?e.innerHTML='<div style="color: #888; font-size: 11px;">Type at least 2 characters per term</div>':e.innerHTML='<div style="color: #888; font-size: 11px;">Type to search (comma-separate multiple terms)</div>'},getHoverInfo(e){if(E.length===0)return null;const o=X(e.book,e.chapter,e.verse),i=re.get(o);return i?`Matches: ${i.map(t=>`"${E[t]}"`).join(", ")}`:null},onUpdate(e){ne=e},destroy(){V&&(document.removeEventListener("click",V),V=null),S=null,A=null,T=null}};function Ie(e,o,i,n,t){const s=n/i-o.x,a=t/i-o.y;for(const c of e)if(s>=c.x&&s<c.x+c.size&&a>=c.y&&a<c.y+c.size)return c;return null}async function cn(){document.title="Tanakh Map [main]";const[e,o]=await Promise.all([fetch("/torahmap/data/tanakh-structure.json"),kt()]);if(!e.ok)throw new Error(`Failed to load tanakh-structure.json: ${e.status}`);let i;try{i=await e.json()}catch(h){throw new Error(`Failed to parse tanakh-structure.json: ${h}`)}const n=pt(i),t=gt(n);console.log(`Loaded ${n.length} verses, bounds: ${t.width}x${t.height}`),Et(o),Z($t),Z(Dt),Z(en),Z(an),Vt({verses:n}),tn({verseTexts:o}),await Promise.all(Nt().map(h=>{var p;return(p=h.init)==null?void 0:p.call(h)}));const s=document.getElementById("canvas");if(!s)throw new Error("Canvas not found");const a=window.devicePixelRatio||1;function c(){const h=window.innerWidth,p=window.innerHeight;s.width=h*a,s.height=p*a,s.style.width=h+"px",s.style.height=p+"px"}c();const r=et(s),u=tt(r);let l=null,d;function f(){n.forEach((p,L)=>{const y=(l==null?void 0:l.getVerseColor(p))??null;if(y)p.color=y;else{const _=.4+Q(L*3)*.4;p.color=[_,_,_]}});const h=Ae(n,[.6,.6,.6]);r.bindBuffer(r.ARRAY_BUFFER,d),r.bufferData(r.ARRAY_BUFFER,h,r.STATIC_DRAW)}const m=Ae(n);d=vt(r,m);const x=window.innerWidth,N=window.innerHeight;let v=1;const k={x:x/2-t.width/2,y:N/2-t.height/2};function w(){r.viewport(0,0,s.width,s.height),r.clearColor(.1,.1,.1,1),r.clear(r.COLOR_BUFFER_BIT),r.useProgram(u.program),r.uniform2f(u.uniforms.resolution,s.width,s.height),r.uniform2f(u.uniforms.pan,k.x,k.y),r.uniform1f(u.uniforms.zoom,v*a),r.bindBuffer(r.ARRAY_BUFFER,d);const h=7*4;r.enableVertexAttribArray(u.attribs.position),r.vertexAttribPointer(u.attribs.position,2,r.FLOAT,!1,h,0),r.enableVertexAttribArray(u.attribs.color),r.vertexAttribPointer(u.attribs.color,3,r.FLOAT,!1,h,2*4),r.enableVertexAttribArray(u.attribs.uv),r.vertexAttribPointer(u.attribs.uv,2,r.FLOAT,!1,h,5*4),r.drawArrays(r.TRIANGLES,0,n.length*6),window.bookLabels&&Pe(window.bookLabels,k,v)}w(),window.bookLabels=wt(n,document.body),Pe(window.bookLabels,k,v),s.addEventListener("wheel",h=>{h.preventDefault();const p=h.deltaY>0?.9:1.1;v=Math.max(.1,Math.min(10,v*p)),w()},{passive:!1});let b=!1,I={x:0,y:0};s.addEventListener("mousedown",h=>{b=!0,I={x:h.clientX,y:h.clientY}}),s.addEventListener("mousemove",h=>{if(b){const p=h.clientX-I.x,L=h.clientY-I.y;k.x+=p/v,k.y+=L/v,I={x:h.clientX,y:h.clientY},w()}}),s.addEventListener("mouseup",()=>{b=!1}),s.addEventListener("mouseleave",()=>{b=!1});const g=document.getElementById("verse-sidebar"),ve=g==null?void 0:g.querySelector(".ref-text"),G=g==null?void 0:g.querySelector(".verse-hebrew"),ae=g==null?void 0:g.querySelector(".verse-english"),be=g==null?void 0:g.querySelector(".sefaria-link"),we=g==null?void 0:g.querySelector(".link-subtitle"),ce=g==null?void 0:g.querySelector(".close-btn"),ke=document.getElementById("controls");function ye(){if(!g||!ke)return;const h=ke.getBoundingClientRect();g.style.top=`${h.bottom+10}px`}function Ge(h,p,L){return`https://www.sefaria.org/${h.replace(/ /g,"_")}.${p}.${L}`}let C=null;function $(h,p=!1){if(!g)return;if(!h){g.classList.remove("visible"),g.classList.remove("pinned");return}const L=yt(o,h.book,h.chapter,h.verse);if(ve&&(ve.textContent=`${h.book} ${h.chapter}:${h.verse}`),G){const y=(L==null?void 0:L.he)||"Loading...",_=nn();(l==null?void 0:l.id)==="trop"&&_?G.innerHTML=on(y,_.unicode):(l==null?void 0:l.id)==="search"?G.innerHTML=$e(y,"he"):G.textContent=y}if(ae){const y=(L==null?void 0:L.en)||"Loading...";(l==null?void 0:l.id)==="search"?ae.innerHTML=$e(y,"en"):ae.textContent=y}if(be&&(be.href=Ge(h.book,h.chapter,h.verse)),we){const y=Kt(h.book,h.chapter,h.verse);we.textContent=y?`${y} linked texts`:""}ye(),g.classList.add("visible"),p?g.classList.add("pinned"):g.classList.remove("pinned")}s.addEventListener("mousemove",h=>{if(!b){const p=Ie(n,k,v,h.clientX,h.clientY);C||(p?$(p,!1):$(null))}}),s.addEventListener("click",h=>{const p=Ie(n,k,v,h.clientX,h.clientY);p?C&&C.book===p.book&&C.chapter===p.chapter&&C.verse===p.verse?(C=null,$(null)):(C=p,$(p,!0)):C&&(C=null,$(null))}),ce==null||ce.addEventListener("click",()=>{C=null,$(null)});const J=document.getElementById("overlay-select"),le=document.getElementById("overlay-controls"),O=document.getElementById("overlay-legend");function Je(h){var p,L,y,_;(p=l==null?void 0:l.destroy)==null||p.call(l),l=Rt(h)??null,(L=l==null?void 0:l.onUpdate)==null||L.call(l,()=>{var xe;f(),O&&(O.innerHTML="",(xe=l==null?void 0:l.renderLegend)==null||xe.call(l,O)),w()}),le&&(le.innerHTML="",(y=l==null?void 0:l.renderControls)==null||y.call(l,le)),O&&(O.innerHTML="",(_=l==null?void 0:l.renderLegend)==null||_.call(l,O)),f(),w(),requestAnimationFrame(ye)}J==null||J.addEventListener("change",()=>{Je(J.value)}),window.addEventListener("resize",()=>{c(),w()}),window.torahMap={verses:n,pan:k,zoom:v,render:w,canvas:s,bounds:t},sn({verses:n,callbacks:{onVerseClick:h=>{C=h,$(h,!0)}}})}cn().catch(console.error);
