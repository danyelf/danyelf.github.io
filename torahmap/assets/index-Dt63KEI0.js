(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();function Ne(e){const t=Math.sin(e*12.9898+e*78.233)*43758.5453;return t-Math.floor(t)}const he=[{name:"Genesis",file:"genesis",section:"torah"},{name:"Exodus",file:"exodus",section:"torah"},{name:"Leviticus",file:"leviticus",section:"torah"},{name:"Numbers",file:"numbers",section:"torah"},{name:"Deuteronomy",file:"deuteronomy",section:"torah"},{name:"Joshua",file:"joshua",section:"neviim"},{name:"Judges",file:"judges",section:"neviim"},{name:"I Samuel",file:"i-samuel",section:"neviim"},{name:"II Samuel",file:"ii-samuel",section:"neviim"},{name:"I Kings",file:"i-kings",section:"neviim"},{name:"II Kings",file:"ii-kings",section:"neviim"},{name:"Isaiah",file:"isaiah",section:"neviim"},{name:"Jeremiah",file:"jeremiah",section:"neviim"},{name:"Ezekiel",file:"ezekiel",section:"neviim"},{name:"Hosea",file:"hosea",section:"neviim"},{name:"Joel",file:"joel",section:"neviim"},{name:"Amos",file:"amos",section:"neviim"},{name:"Obadiah",file:"obadiah",section:"neviim"},{name:"Jonah",file:"jonah",section:"neviim"},{name:"Micah",file:"micah",section:"neviim"},{name:"Nahum",file:"nahum",section:"neviim"},{name:"Habakkuk",file:"habakkuk",section:"neviim"},{name:"Zephaniah",file:"zephaniah",section:"neviim"},{name:"Haggai",file:"haggai",section:"neviim"},{name:"Zechariah",file:"zechariah",section:"neviim"},{name:"Malachi",file:"malachi",section:"neviim"},{name:"Psalms",file:"psalms",section:"ketuvim"},{name:"Proverbs",file:"proverbs",section:"ketuvim"},{name:"Job",file:"job",section:"ketuvim"},{name:"Song of Songs",file:"song-of-songs",section:"ketuvim"},{name:"Ruth",file:"ruth",section:"ketuvim"},{name:"Lamentations",file:"lamentations",section:"ketuvim"},{name:"Ecclesiastes",file:"ecclesiastes",section:"ketuvim"},{name:"Esther",file:"esther",section:"ketuvim"},{name:"Daniel",file:"daniel",section:"ketuvim"},{name:"Ezra",file:"ezra",section:"ketuvim"},{name:"Nehemiah",file:"nehemiah",section:"ketuvim"},{name:"I Chronicles",file:"i-chronicles",section:"ketuvim"},{name:"II Chronicles",file:"ii-chronicles",section:"ketuvim"}],Et=he.map(e=>e.name),_t=new Set(he.filter(e=>e.section==="torah").map(e=>e.name));new Set(he.filter(e=>e.section==="neviim").map(e=>e.name));const Nt=new Set(he.filter(e=>e.section==="ketuvim").map(e=>e.name));Object.fromEntries(he.map(e=>[e.name,e.file]));function Lt(e){return _t.has(e)?"torah":Nt.has(e)?"ketuvim":"neviim"}const ne=6,Oe=2,ue=12,Ue=70,rt=35,oe=50,$t=12,Ve=3,De=15,Te=72,it=[["Hosea","Joel"],["Amos","Obadiah","Jonah"],["Micah","Nahum","Habakkuk","Zephaniah","Haggai"],["Zechariah","Malachi"]],je=new Set(it.flat()),at=[{books:["Song of Songs","Ruth","Lamentations"],insertAfter:"Job"},{books:["Ecclesiastes","Esther"],insertAfter:"Job"},{books:["Ezra","Nehemiah"],insertAfter:"Daniel"}],Rt=new Set(at.flatMap(e=>e.books));function Pt(e){if(!Number.isFinite(e)||e<0)return console.error(`Invalid verse count: ${e}, defaulting to 0`),[0];if(e===0)return[0];if(e<=oe)return[e];const t=[];let n=e;for(;n>0;)if(n<=oe)t.push(n),n=0;else if(n<=oe+Ve-1){const o=n-Ve;t.push(o),n-=o}else t.push(oe),n-=oe;return t}function Le(e,t,n,o,r,i,a){if(!Number.isFinite(n)||n<0)return console.error(`Invalid verse count for ${e} chapter ${t+1}: ${n}`),{width:0,height:0};if(!Number.isFinite(o)||!Number.isFinite(r))return console.error(`Invalid coordinates for ${e} chapter ${t+1}: (${o}, ${r})`),{width:0,height:0};if(!Array.isArray(a))return console.error(`Verses array is not an array for ${e} chapter ${t+1}`),{width:0,height:0};const c=Pt(n);let l=0,u=r,s=0;for(let h=0;h<c.length;h++){const f=c[h];if(!Number.isFinite(f)||f<0){console.error(`Invalid wrap point ${f} at line ${h} for ${e} chapter ${t+1}`);continue}const d=h>0?$t:0;for(let g=0;g<f;g++){const p=(Ne(i.value*2)-.5)*2,b=(Ne(i.value*2+1)-.5)*2,k=o+d+g*ne+p;a.push({book:e,chapter:t+1,verse:s+1,x:k,y:u+b,size:ne}),l=Math.max(l,d+(g+1)*ne),s++,i.value++}u+=ne+Oe}return{width:l,height:c.length*(ne+Oe)}}function Me(e,t,n,o,r){if(!e||typeof e!="object")return console.error(`Invalid book object: ${e}`),{width:0,height:0};if(!e.name||typeof e.name!="string")return console.error(`Invalid book name: ${e.name}`),{width:0,height:0};if(!Array.isArray(e.chapters))return console.error(`Book ${e.name} has invalid chapters array`),{width:0,height:0};if(!Number.isFinite(t)||!Number.isFinite(n))return console.error(`Invalid coordinates for ${e.name}: (${t}, ${n})`),{width:0,height:0};let i=0,a=n;for(let c=0;c<e.chapters.length;c++){const l=e.chapters[c];if(!Number.isFinite(l)||l<0){console.error(`Invalid verse count for ${e.name} chapter ${c+1}: ${l}`);continue}const{width:u,height:s}=Le(e.name,c,l,t,a,o,r);i=Math.max(i,u),a+=s}return{width:i,height:a-n}}function st(e,t,n,o,r,i,a=Me){if(!Array.isArray(e))return console.error(`Books is not an array: ${e}`),{width:0,height:0,nextX:t};if(!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o))return console.error(`Invalid layout parameters: startX=${t}, y=${n}, gap=${o}`),{width:0,height:0,nextX:t};let c=t,l=0;for(const u of e){if(!u){console.error("Encountered null or undefined book in layoutBooksRow");continue}const{width:s,height:h}=a(u,c,n,r,i);l=Math.max(l,h),c+=s+o}return{width:c-t-(e.length>0?o:0),height:l,nextX:c}}function ct(e,t,n,o,r,i,a){if(!Array.isArray(e))return console.error(`Book names is not an array: ${e}`),{width:0,height:0};if(!(t instanceof Map))return console.error(`Book map is not a Map: ${t}`),{width:0,height:0};if(!Number.isFinite(n)||!Number.isFinite(o)||!Number.isFinite(r))return console.error(`Invalid layout parameters: x=${n}, startY=${o}, gap=${r}`),{width:0,height:0};let c=o,l=0;for(const s of e){if(!s||typeof s!="string"){console.error(`Invalid book name in stack: ${s}`);continue}const h=t.get(s);if(!h){console.error(`Book not found in map: ${s}`);continue}const{width:f,height:d}=Me(h,n,c,i,a);l=Math.max(l,f),c+=d+r}const u=c-o-(e.length>0?r:0);return{width:l,height:u}}function Mt(e,t,n,o,r,i,a,c){if(!Array.isArray(e))return console.error(`Stacks is not an array: ${e}`),{width:0,height:0};if(!Number.isFinite(n)||!Number.isFinite(o)||!Number.isFinite(r)||!Number.isFinite(i))return console.error(`Invalid layout parameters: startX=${n}, y=${o}, stackGap=${r}, columnGap=${i}`),{width:0,height:0};let l=n,u=0;for(const s of e){if(!Array.isArray(s)){console.error(`Stack is not an array: ${s}`);continue}const{width:h,height:f}=ct(s,t,l,o,r,a,c);u=Math.max(u,f),l+=h+i}return{width:l-n-(e.length>0?i:0),height:u}}function Ht(e,t,n,o,r){if(!e||!Array.isArray(e.chapters))return console.error(`Invalid Psalms book structure: ${e==null?void 0:e.name}`),{width:0,height:0};if(!Number.isFinite(t)||!Number.isFinite(n))return console.error(`Invalid coordinates for Psalms: (${t}, ${n})`),{width:0,height:0};const i=Math.min(Te,e.chapters.length);Te>e.chapters.length&&console.warn(`Psalms split point ${Te} exceeds chapter count ${e.chapters.length}, using ${i}`);let a=n,c=0;for(let d=0;d<i;d++){const g=e.chapters[d];if(d>=e.chapters.length){console.error(`Chapter index ${d} out of bounds for Psalms (${e.chapters.length} chapters)`);break}const{width:p,height:b}=Le(e.name,d,g,t,a,o,r);c=Math.max(c,p),a+=b}const l=a-n,u=t+c+De;let s=n,h=0;for(let d=i;d<e.chapters.length;d++){const g=e.chapters[d];if(d>=e.chapters.length){console.error(`Chapter index ${d} out of bounds for Psalms (${e.chapters.length} chapters)`);break}const{width:p,height:b}=Le(e.name,d,g,u,s,o,r);h=Math.max(h,p),s+=b}const f=s-n;return{width:c+De+h,height:Math.max(l,f)}}function It(e,t,n,o){if(!Array.isArray(e))return console.error(`Nevi'im books is not an array: ${e}`),0;if(!Number.isFinite(t))return console.error(`Invalid Nevi'im section Y: ${t}`),0;const r=e.filter(s=>s&&!je.has(s.name)),i=e.filter(s=>s&&je.has(s.name)),a=new Map(i.map(s=>[s.name,s])),{height:c,nextX:l}=st(r,0,t,ue,n,o),{height:u}=Mt(it,a,l,t,rt,ue,n,o);return Math.max(c,u)}function Ft(e,t,n,o){if(!Array.isArray(e))return console.error(`Ketuvim books is not an array: ${e}`),0;if(!Number.isFinite(t))return console.error(`Invalid Ketuvim section Y: ${t}`),0;const r=new Map(e.filter(l=>l&&l.name).map(l=>[l.name,l]));let i=0,a=0;const c=e.filter(l=>l&&!Rt.has(l.name));for(const l of c){if(!l){console.error("Encountered null or undefined book in Ketuvim");continue}const{width:u,height:s}=l.name==="Psalms"?Ht(l,i,t,n,o):Me(l,i,t,n,o);a=Math.max(a,s),i+=u+ue;for(const h of at){if(!h||!Array.isArray(h.books)){console.error(`Invalid Ketuvim stack config: ${h}`);continue}if(l.name===h.insertAfter){const{width:f,height:d}=ct(h.books,r,i,t,rt,n,o);a=Math.max(a,d),i+=f+ue}}}return a}function zt(e,t,n,o){if(!Array.isArray(e))return console.error(`Torah books is not an array: ${e}`),0;if(!Number.isFinite(t))return console.error(`Invalid Torah section Y: ${t}`),0;const{height:r}=st(e,0,t,ue,n,o);return r}function Bt(e){if(!e||typeof e!="object")return console.error("Invalid torahData: not an object"),[];if(!Array.isArray(e.books))return console.error("Invalid torahData: books is not an array"),[];if(e.books.length===0)return console.warn("Empty books array in torahData"),[];const t=[],n={value:0},o=[],r=[],i=[];for(const u of e.books){if(!u||typeof u!="object"){console.error(`Invalid book in torahData: ${u}`);continue}if(!u.name||typeof u.name!="string"){console.error(`Book missing valid name: ${JSON.stringify(u)}`);continue}const s=Lt(u.name);s==="torah"?o.push(u):s==="neviim"?r.push(u):s==="ketuvim"?i.push(u):console.warn(`Book ${u.name} has unknown section: ${s}`)}o.length===0&&console.warn("Torah section is empty"),r.length===0&&console.warn("Neviim section is empty"),i.length===0&&console.warn("Ketuvim section is empty");let a=0;const c=zt(o,a,n,t);a+=c+Ue;const l=It(r,a,n,t);return a+=l+Ue,Ft(i,a,n,t),t}function Ot(e){if(!Array.isArray(e))return console.error("getLayoutBounds: verses is not an array"),{width:0,height:0};if(e.length===0)return console.warn("getLayoutBounds: empty verses array"),{width:0,height:0};let t=0,n=0;for(const o of e){if(!o||typeof o!="object"){console.error(`Invalid verse in bounds calculation: ${o}`);continue}if(!Number.isFinite(o.x)||!Number.isFinite(o.y)||!Number.isFinite(o.size)){console.error(`Invalid verse coordinates: ${o.book} ${o.chapter}:${o.verse} at (${o.x}, ${o.y}) size=${o.size}`);continue}(o.x<-2||o.y<-2||o.size<0)&&console.warn(`Suspicious coordinates for verse ${o.book} ${o.chapter}:${o.verse}: (${o.x}, ${o.y}) size=${o.size}`),t=Math.max(t,o.x+o.size),n=Math.max(n,o.y+o.size)}return!Number.isFinite(t)||!Number.isFinite(n)?(console.error(`Invalid bounds calculated: width=${t}, height=${n}`),{width:0,height:0}):{width:t,height:n}}const Ut=-20;function Vt(e,t){const n={};for(const r of e)n[r.book]||(n[r.book]={minX:r.x,maxX:r.x+r.size,minY:r.y}),n[r.book].maxX=Math.max(n[r.book].maxX,r.x+r.size),n[r.book].minY=Math.min(n[r.book].minY,r.y);const o=document.createElement("div");o.id="book-labels",o.style.cssText="position:fixed;top:0;left:0;pointer-events:none;";for(const[r,i]of Object.entries(n)){const a=document.createElement("div");a.textContent=r,a.style.cssText=`
      position:absolute;
      color:#666;
      font-family:sans-serif;
      font-size:12px;
      white-space:nowrap;
    `,a.dataset.bookName=r,a.dataset.leftX=String(i.minX),a.dataset.topY=String(i.minY),o.appendChild(a)}return t.appendChild(o),o}function lt(e,t,n){for(const o of e.children)if(o instanceof HTMLElement){const r=parseFloat(o.dataset.leftX||"0"),i=parseFloat(o.dataset.topY||"0"),a=(r+t.x)*n,c=(i+t.y)*n+Ut;o.style.left=a+"px",o.style.top=c+"px"}}async function Dt(){const e=await fetch("/torahmap/data/all-texts.json");if(!e.ok)return console.error(`Failed to load verse texts: ${e.status}`),{};const t=await e.json();return console.log(`Loaded verse texts for ${Object.keys(t).length} books`),t}function jt(e,t,n,o){var r,i;return((i=(r=e[t])==null?void 0:r[String(n)])==null?void 0:i[String(o)])||null}function ge(e,t){return e===null&&t===null?!0:e===null||t===null?!1:e.book===t.book&&e.chapter===t.chapter&&e.verse===t.verse}function N(e,t,n){return`${e}:${t}:${n}`}const Gt=1424,qt=1535,He=1425,Ie=1479;let me=[];function ve(e){let t="";for(const n of e){const o=n.charCodeAt(0);(o<He||o>Ie||o===1470||o===1472||o===1475||o===1478)&&(t+=n)}return t}function ut(e){return e.split(",").map(t=>t.trim()).filter(t=>t.length>=2)}function Kt(e){for(const t of e){const n=t.charCodeAt(0);if(n>=Gt&&n<=qt)return!0}return!1}function Yt(e){me=[];for(const t of Et){const n=e[t];if(!n)continue;const o=Object.keys(n).map(Number).sort((r,i)=>r-i);for(const r of o){const i=n[String(r)],a=Object.keys(i).map(Number).sort((c,l)=>c-l);for(const c of a){const{he:l,en:u}=i[String(c)];me.push({book:t,chapter:r,verse:c,hebrewText:ve(l),hebrewOriginal:l,englishText:u.toLowerCase(),englishOriginal:u})}}}console.log(`Search index built with ${me.length} verses`)}function Wt(e){const t=ut(e);if(t.length===0)return[];const n=Kt(t[0]),o=new Map;for(let r=0;r<t.length;r++){const i=t[r],a=n?ve(i):i.toLowerCase();for(const c of me){const l=n?c.hebrewText:c.englishText,u=n?c.hebrewOriginal:c.englishOriginal,s=l.indexOf(a);if(s!==-1){const h=`${c.book}:${c.chapter}:${c.verse}`,f=Jt(u,s,a.length,n);let d=o.get(h);d||(d={book:c.book,chapter:c.chapter,verse:c.verse,language:n?"he":"en",matchingTerms:[]},o.set(h,d)),d.matchingTerms.some(g=>g.termIndex===r)||d.matchingTerms.push({termIndex:r,snippet:f.text,matchStart:f.matchStart,matchEnd:f.matchEnd})}}}return Array.from(o.values())}function Xt(e,t){if(t<0)return 0;let n=0;for(let o=0;o<e.length;o++){if(n===t)return o;const r=e.charCodeAt(o);r>=He&&r<=Ie&&r!==1470&&r!==1472&&r!==1475&&r!==1478||n++}return e.length}function Zt(e,t,n){if(t<0||t>=e.length||n<0)return 0;let o=0,r=0;for(let i=t;i<e.length&&r<n;i++){const a=e.charCodeAt(i);a>=He&&a<=Ie&&a!==1470&&a!==1472&&a!==1475&&a!==1478?o++:r++}return o}function Jt(e,t,n,o=!1){let a=t,c=t+n;if(o){a=Xt(e,t);const g=Zt(e,a,n);c=a+n+g}let l=Math.max(0,a-20),u=Math.min(e.length,l+60);u===e.length&&u-l<60&&(l=Math.max(0,u-60));let s=e.slice(l,u);const h=a-l,f=c-l;let d=0;return l>0&&(s="..."+s,d=3),u<e.length&&(s=s+"..."),{text:s,matchStart:h+d,matchEnd:Math.min(f+d,s.length)}}function Qt(e){const t=new Map;for(const n of e){const o=N(n.book,n.chapter,n.verse);t.set(o,n.matchingTerms.map(r=>r.termIndex))}return t}const ht="torahMap.helpSeen",dt="torahMap.helpTab",ft={overview:{title:"Overview",content:`
      <h2>Torah Map</h2>
      <p>An interactive visualization of the entire Tanakh (Hebrew Bible) where every verse has a fixed position.</p>
      <p>The map is divided into three sections, stacked vertically:</p>
      <ul>
        <li><strong>Torah</strong> — The Five Books of Moses</li>
        <li><strong>Nevi'im</strong> — The Prophets</li>
        <li><strong>Ketuvim</strong> — The Writings</li>
      </ul>
      <p>Switch between different analytical overlays to reveal patterns across 23,000+ verses.</p>
      <p class="credits">
        By <a href="https://danyelfisher.info" target="_blank">Danyel Fisher</a> ·
        <a href="https://github.com/danyelf/torahmap" target="_blank">GitHub</a> ·
        Data from <a href="https://www.sefaria.org/" target="_blank">Sefaria</a>
      </p>
    `},controls:{title:"Controls",content:`
      <table class="controls-table">
        <tr><td>Mouse wheel</td><td>Zoom in/out</td></tr>
        <tr><td>Click + drag</td><td>Pan around</td></tr>
        <tr><td>Hover</td><td>Preview verse details</td></tr>
        <tr><td>Click verse</td><td>Pin verse in sidebar</td></tr>
        <tr><td>Click pinned</td><td>Unpin verse</td></tr>
      </table>
    `},overlays:{title:"Overlays",content:`
      <dl class="overlay-list">
        <dt>Text Search</dt>
        <dd>Search Hebrew or English text. Matching verses are highlighted on the map.</dd>

        <dt>Divine Names</dt>
        <dd>Colors Torah verses by divine name usage: YHWH (blue), Elohim (red), both (purple).</dd>

        <dt>Commentary</dt>
        <dd>Heatmap showing commentary density from Sefaria. Filter by source type.</dd>

        <dt>Trop</dt>
        <dd>Visualize cantillation marks (trope). Select a mark to see where it appears.</dd>
      </dl>
    `}};let Y=null;function en(){const e=document.createElement("div");e.id="help-modal",e.className="help-modal",e.innerHTML=`
    <div class="help-backdrop"></div>
    <div class="help-content">
      <div class="help-header">
        <div class="help-tabs">
          <button class="help-tab active" data-tab="overview">Overview</button>
          <button class="help-tab" data-tab="controls">Controls</button>
          <button class="help-tab" data-tab="overlays">Overlays</button>
        </div>
        <button class="help-close">&times;</button>
      </div>
      <div class="help-body"></div>
    </div>
  `;const t=e.querySelector(".help-backdrop"),n=e.querySelector(".help-close"),o=e.querySelectorAll(".help-tab");return t.addEventListener("click",qe),n.addEventListener("click",qe),o.forEach(r=>{r.addEventListener("click",()=>{const i=r.dataset.tab;mt(e,i)})}),e}function mt(e,t){localStorage.setItem(dt,t),e.querySelectorAll(".help-tab").forEach(o=>{o.classList.toggle("active",o.dataset.tab===t)});const n=e.querySelector(".help-body");n.innerHTML=ft[t].content}function Ge(){Y||(Y=en(),document.body.appendChild(Y));const e=localStorage.getItem(dt),t=e&&ft[e]?e:"overview";Y.classList.add("visible"),mt(Y,t)}function qe(){Y&&(Y.classList.remove("visible"),localStorage.setItem(ht,"true"))}function tn(e){const t=document.createElement("button");t.id="help-btn",t.textContent="?",t.title="How to use",t.addEventListener("click",Ge),e.appendChild(t),localStorage.getItem(ht)||Ge()}const Ke=1e6,pt=50,nn=1e3;function gt(e,t){if(!e)return null;const n=e.trim();return!n||n.length>t||/<[^>]*>/.test(n)||/javascript:/i.test(n)||/on\w+=/i.test(n)?null:n}function ke(e,t=pt){const n=gt(e,t);return!n||/[/\\|;]/.test(n)?null:n}function on(e){const t=gt(e,pt);return!t||!/^[a-zA-Z\s/]+$/.test(t)?null:t}function rn(e){return!e||e.trim()===""?!1:/^[a-zA-Z\u0590-\u05FF\s.]+$/.test(e)}function an(e){return e.replace(/<[^>]*>/g,"")}function sn(){const e=window.location.hash.slice(1),t=new URLSearchParams(e),n={overlayParams:{}},o=t.get("overlay"),r=ke(o);r&&(n.overlay=r);const i=t.get("verse"),a=ke(i,100);a&&(n.verse=a);const c=t.get("zoom");if(c){const p=parseFloat(c);!isNaN(p)&&p>=.1&&p<=10&&(n.zoom=p)}const l=t.get("x");if(l){const p=parseFloat(l);!isNaN(p)&&isFinite(p)&&Math.abs(p)<=Ke&&(n.x=p)}const u=t.get("y");if(u){const p=parseFloat(u);!isNaN(p)&&isFinite(p)&&Math.abs(p)<=Ke&&(n.y=p)}const s=t.get("trop"),h=ke(s);h&&(n.overlayParams.trop=h);const f=t.get("category"),d=on(f);d&&(n.overlayParams.category=d);const g=t.get("q");if(g){const p=g.trim();p&&p.length<=nn&&(n.overlayParams.q=an(p))}return n}function cn(e){const t=new URLSearchParams;e.overlay&&t.set("overlay",e.overlay),e.verse&&t.set("verse",e.verse),e.zoom!==void 0&&e.zoom!==1&&t.set("zoom",e.zoom.toFixed(2).replace(/\.?0+$/,"")),e.verse||(e.x!==void 0&&t.set("x",e.x.toFixed(1).replace(/\.?0+$/,"")),e.y!==void 0&&t.set("y",e.y.toFixed(1).replace(/\.?0+$/,""))),e.overlayParams.trop&&t.set("trop",e.overlayParams.trop),e.overlayParams.category&&e.overlayParams.category!=="all"&&t.set("category",e.overlayParams.category),e.overlayParams.q&&t.set("q",e.overlayParams.q);const n=t.toString();return n?`#${n}`:""}function ln(e,t=!1){const n=cn(e),o=window.location.pathname+window.location.search+n;t?history.pushState(null,"",o):history.replaceState(null,"",o)}function un(e){window.addEventListener("popstate",e),window.addEventListener("hashchange",e)}function hn(e,t,n){return`${e.replace(/ /g,".")}.${t}.${n}`}function dn(e){const t=e.split(".");if(t.length<3||t.length>5)return null;const n=t.pop(),o=t.pop(),r=t.join(" "),i=parseInt(n,10),a=parseInt(o,10);return isNaN(i)||isNaN(a)||i<0||a<0||a>200||i>200||!rn(r)?null:{book:r,chapter:a,verse:i}}function fn(e,t){let n=null;return(...o)=>{n&&clearTimeout(n),n=setTimeout(()=>{e(...o),n=null},t)}}const vt=[{unicode:"֒",codePoint:1426,name:"Segol",hebrewName:"סגול"},{unicode:"֓",codePoint:1427,name:"Shalshelet",hebrewName:"שלשלת"},{unicode:"֔",codePoint:1428,name:"Zaqef Qatan",hebrewName:"זקף קטן"},{unicode:"֕",codePoint:1429,name:"Zaqef Gadol",hebrewName:"זקף גדול"},{unicode:"֖",codePoint:1430,name:"Tipcha",hebrewName:"טפחא"},{unicode:"֗",codePoint:1431,name:"Revia",hebrewName:"רביע"},{unicode:"֘",codePoint:1432,name:"Zarqa",hebrewName:"זרקא"},{unicode:"֙",codePoint:1433,name:"Pashta",hebrewName:"פשטא"},{unicode:"֚",codePoint:1434,name:"Yetiv",hebrewName:"יתיב"},{unicode:"֛",codePoint:1435,name:"Tevir",hebrewName:"תביר"},{unicode:"֜",codePoint:1436,name:"Geresh",hebrewName:"גרש"},{unicode:"֝",codePoint:1437,name:"Geresh Muqdam",hebrewName:"גרש מוקדם"},{unicode:"֞",codePoint:1438,name:"Gershayim",hebrewName:"גרשיים"},{unicode:"֟",codePoint:1439,name:"Karnei Parah",hebrewName:"קרני פרה"},{unicode:"֠",codePoint:1440,name:"Telisha Gedola",hebrewName:"תלישא גדולה"},{unicode:"֡",codePoint:1441,name:"Pazer",hebrewName:"פזר"},{unicode:"֣",codePoint:1443,name:"Munach",hebrewName:"מונח"},{unicode:"֤",codePoint:1444,name:"Mahapakh",hebrewName:"מהפך"},{unicode:"֥",codePoint:1445,name:"Merkha",hebrewName:"מרכא"},{unicode:"֦",codePoint:1446,name:"Merkha Kefula",hebrewName:"מרכא כפולה"},{unicode:"֧",codePoint:1447,name:"Darga",hebrewName:"דרגא"},{unicode:"֨",codePoint:1448,name:"Qadma",hebrewName:"קדמא"},{unicode:"֩",codePoint:1449,name:"Telisha Qetana",hebrewName:"תלישא קטנה"},{unicode:"֪",codePoint:1450,name:"Yerah Ben Yomo",hebrewName:"ירח בן יומו"},{unicode:"֫",codePoint:1451,name:"Ole",hebrewName:"עולה"},{unicode:"֬",codePoint:1452,name:"Iluy",hebrewName:"אילוי"},{unicode:"֭",codePoint:1453,name:"Dehi",hebrewName:"דחי"},{unicode:"֮",codePoint:1454,name:"Zinor",hebrewName:"זינור"},{unicode:"֑",codePoint:1425,name:"Etnachta",hebrewName:"אתנחתא"},{unicode:"֢",codePoint:1442,name:"Atnah Hafukh",hebrewName:"אתנח הפוך"},{unicode:"֯",codePoint:1455,name:"Masora Circle",hebrewName:"עיגול מסורה"}];new Map(vt.map(e=>[e.unicode,e]));const Ye={RARE:50,UNCOMMON:500};function ae(e){return e<Ye.RARE?"rare":e<Ye.UNCOMMON?"uncommon":"common"}function mn(e){const t=[];for(const n of e){const o=n.codePointAt(0);o&&o>=1425&&o<=1455&&t.push(n)}return t}function pn(e){const t=new Map,n=mn(e);for(const o of n)t.set(o,(t.get(o)||0)+1);return t}function gn(e){const t=new Map;for(const n of vt)t.set(n.unicode,{unicode:n.unicode,name:n.name,hebrewName:n.hebrewName,totalCount:0,verses:[]});for(const[n,o]of Object.entries(e))for(const[r,i]of Object.entries(o)){const a=parseInt(r,10);for(const[c,l]of Object.entries(i)){const u=parseInt(c,10),s=pn(l.he);for(const[h,f]of s){const d=t.get(h);d&&(d.totalCount+=f,d.verses.push({book:n,chapter:a,verse:u,count:f}))}}}return t}function vn(e){return Array.from(e.values()).filter(t=>t.totalCount>0).sort((t,n)=>t.totalCount-n.totalCount)}const T={FUZZY_RADIUS:10,MIN_BRIGHTNESS:.4,BRIGHTNESS_RANGE:.4,OUTLINE_COLOR:[.6,.6,.6],BLEED_PIXELS:3,HIGHLIGHT_COLOR:[.2,.9,1],DIM_FACTOR:.3,BRIGHTNESS_FACTOR:1.5,DESATURATE_FACTOR:.2,RARE_NO_MATCH_COLOR:[.15,.15,.15]};let We=new Map,J=[],x=null,G=null,ye=new Map,X=1,Fe=0,be="common";const yn=[1,.84,0];function yt(){if(ye.clear(),!!x){be=ae(x.totalCount);for(const e of x.verses){const t=N(e.book,e.chapter,e.verse);ye.set(t,e.count)}X=1;for(const e of x.verses)e.count>X&&(X=e.count);Fe=Math.log(X+1)}}function bn(e){if(!x)return null;const t=N(e.book,e.chapter,e.verse),n=ye.get(t)||0;if(be==="rare")return n>0?yn:T.RARE_NO_MATCH_COLOR;if(be==="uncommon"){if(n===0)return[.12,.12,.15];const o=n/X;return[.4+o*.5,.2+o*.2,.6+o*.35]}else{if(n===0)return[.12,.1,.15];const o=Math.log(n+1)/Fe;if(o<.33){const r=o/.33;return[.2+r*.2,.1+r*.1,.3+r*.2]}else if(o<.66){const r=(o-.33)/.33;return[.4+r*.3,.2+r*.1,.5+r*.2]}else{const r=(o-.66)/.34;return[.7+r*.25,.3+r*.3,.7+r*.2]}}}function wn(e){e.innerHTML=`
    <div class="trop-controls">
      <label style="margin-bottom: 8px;">Select Trop Mark</label>
      <div class="trop-chart"></div>
      <div class="trop-info"></div>
    </div>
  `;const t=e.querySelector(".trop-chart"),n=e.querySelector(".trop-info");let o=null;for(const r of J){const i=document.createElement("button");i.textContent="ב"+r.unicode,i.title=`${r.name} (${r.hebrewName})`;const a=ae(r.totalCount);if(a==="rare"&&i.classList.add("rare"),i.addEventListener("mouseenter",()=>{const c=a==="rare"?"Rare":a==="uncommon"?"Uncommon":"Common";n.textContent=`${r.name} (${r.hebrewName}) · ${r.totalCount.toLocaleString()} occurrences · ${c}`}),i.addEventListener("mouseleave",()=>{if(!o)n.textContent="";else{const c=J.find(l=>l.unicode===(o==null?void 0:o.dataset.unicode));if(c){const l=ae(c.totalCount),u=l==="rare"?"Rare":l==="uncommon"?"Uncommon":"Common";n.textContent=`${c.name} (${c.hebrewName}) · ${c.totalCount.toLocaleString()} · ${u}`}}}),i.addEventListener("click",()=>{o===i?(i.classList.remove("selected"),o=null,x=null,n.textContent=""):(o&&o.classList.remove("selected"),i.classList.add("selected"),o=i,x=r),yt(),G==null||G()}),i.dataset.unicode=r.unicode,t.appendChild(i),x&&r.unicode===x.unicode){i.classList.add("selected"),o=i;const c=ae(r.totalCount),l=c==="rare"?"Rare":c==="uncommon"?"Uncommon":"Common";n.textContent=`${r.name} (${r.hebrewName}) · ${r.totalCount.toLocaleString()} · ${l}`}}}const Sn={id:"trop",name:"Cantillation (Trop)",async init(){},destroy(){x=null,G=null,ye.clear(),X=1,Fe=0,be="common"},onUpdate(e){G=e},getVerseColor(e){return bn(e)},renderControls(e){wn(e)},renderLegend(e){if(!x){e.innerHTML='<div style="color: #666; font-size: 11px;">Select a trop mark above</div>';return}ae(x.totalCount)==="rare"?e.innerHTML=`
        <div class="legend-row"><span class="swatch" style="background: rgb(255, 214, 0)"></span><span>Contains ${x.name}</span></div>
        <div class="legend-row"><span class="swatch" style="background: rgb(38, 38, 38)"></span><span>Does not contain</span></div>
      `:e.innerHTML=`
        <div class="legend-gradient" style="background: linear-gradient(to right, #1f1a2e, #5a3f7a, #a060a0, #e090c0);"></div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
          <span>0</span>
          <span>Count</span>
          <span>Max</span>
        </div>
      `},getHoverInfo(e){if(!x)return null;const t=x.verses.find(n=>n.book===e.book&&n.chapter===e.chapter&&n.verse===e.verse);return t?`${x.name} ×${t.count}`:null},getUrlParams(){return x?{trop:x.name.toLowerCase().replace(/\s+/g,"-")}:{}},applyUrlParams(e){const t=e.get("trop");if(t){const n=J.find(o=>o.name.toLowerCase().replace(/\s+/g,"-")===t);n&&(x=n,yt(),G==null||G())}}};function xn(e){We=gn(e.verseTexts),J=vn(We),console.log(`Built trop index: ${J.length} marks found`),console.log("Rarest trop:",J.slice(0,5).map(t=>`${t.name} (${t.totalCount})`).join(", "))}function Tn(){return x}function kn(e,t){const n=[];let o=0;for(;o<e.length;){const r=e[o];if(r===t)if(n.length>0){const i=[];for(;n.length>0;){const c=n[n.length-1].codePointAt(0)||0;if(c>=1425&&c<=1479)i.unshift(n.pop());else{i.unshift(n.pop());break}}i.push(r),n.push(`<mark class="trop-highlight">${i.join("")}</mark>`)}else n.push(`<mark class="trop-highlight">${r}</mark>`);else n.push(r);o++}return n.join("")}const Z=[[.1,.7,.8],[1,.5,0],[.5,1,.2],[1,.2,.8],[1,1,.2]];function An(e,t){if(e===0)return[.15,.15,.2];const n=Math.log(t+1),o=Math.log(e+1)/n;if(o<.25){const r=o/.25;return[.1,.13+r*.1,.18+r*.2]}else if(o<.5){const r=(o-.25)/.25;return[.1+r*.1,.23+r*.2,.38-r*.05]}else if(o<.75){const r=(o-.5)/.25;return[.2+r*.7,.43-r*.1,.33-r*.2]}else{const r=(o-.75)/.25;return[.9+r*.1,.33-r*.1,.13+r*.05]}}function Cn(e){const[t,n,o]=e,r=Math.max(t,n,o),i=Math.min(t,n,o),a=(r+i)/2;if(r===i)return{h:0,s:0,l:a};const c=r-i,l=a>.5?c/(2-r-i):c/(r+i);let u;return r===t?u=((n-o)/c+(n<o?6:0))/6:r===n?u=((o-t)/c+2)/6:u=((t-n)/c+4)/6,{h:u*360,s:l,l:a}}function bt(e){const{h:t,s:n,l:o}=e;if(n===0)return[o,o,o];const r=(l,u,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<1/6?l+(u-l)*6*s:s<1/2?u:s<2/3?l+(u-l)*(2/3-s)*6:l),i=o<.5?o*(1+n):o+n-o*n,a=2*o-i,c=t/360;return[r(a,i,c+1/3),r(a,i,c),r(a,i,c-1/3)]}function wt(e){return`rgb(${Math.round(e[0]*255)}, ${Math.round(e[1]*255)}, ${Math.round(e[2]*255)})`}let St=[],j="",E=[],H=[],se=new Map,ce=null,we=null,C=null,P=null,$=null,K=null;function En(e){var t;St=e.verses,(t=e.callbacks)!=null&&t.onVerseClick&&(we=e.callbacks.onVerseClick)}function Ae(e){j=e,E=ut(e),E.length===0?(H=[],se=new Map):(H=Wt(e),se=Qt(H)),xt(),ce==null||ce()}function xt(){if(!$)return;$.querySelectorAll(".search-result").forEach(o=>o.remove());const t=$.querySelector("#search-count");if(H.length===0){$.classList.remove("visible"),t&&(t.textContent="");return}if(t){const o=E.length>1?` (${E.length} terms)`:"";t.textContent=`${H.length}${H.length>=100?"+":""} results${o}`}const n=H.slice(0,10);for(const o of n){const r=document.createElement("div");r.className="search-result";const i=document.createElement("div");i.className="ref";const a=document.createElement("span");a.className="term-indicators";for(const s of o.matchingTerms){const h=document.createElement("span");h.className="term-dot";const f=Z[s.termIndex%Z.length];h.style.background=wt(f),a.appendChild(h)}i.appendChild(a),i.appendChild(document.createTextNode(`${o.book} ${o.chapter}:${o.verse}`));const c=document.createElement("div");c.className=`snippet ${o.language==="he"?"rtl":""}`;const l=o.matchingTerms[0],u=_n(l.snippet,l.matchStart,l.matchEnd,l.termIndex);c.appendChild(u),r.appendChild(i),r.appendChild(c),r.addEventListener("click",()=>{const s=St.find(h=>h.book===o.book&&h.chapter===o.chapter&&h.verse===o.verse);s&&we&&we(s)}),$.appendChild(r)}$.classList.add("visible")}function _n(e,t,n,o){const r=document.createDocumentFragment();t>0&&r.appendChild(document.createTextNode(e.slice(0,t)));const i=document.createElement("mark");return i.className=`term-${o%5}`,i.textContent=e.slice(t,n),r.appendChild(i),n<e.length&&r.appendChild(document.createTextNode(e.slice(n))),r}function Xe(e,t){const n=document.createDocumentFragment();if(E.length===0)return n.appendChild(document.createTextNode(e)),n;const o=t==="he",r=[],i=o?ve(e):e.toLowerCase();for(let l=0;l<E.length;l++){const u=E[l],s=o?ve(u):u.toLowerCase();let h=0;for(;;){const f=i.indexOf(s,h);if(f===-1)break;let d=f,g=f+s.length;if(o){let p=0,b=0;for(let S=0;S<e.length&&b<f;S++){const y=e.charCodeAt(S);y>=1425&&y<=1479&&y!==1470&&y!==1472&&y!==1475&&y!==1478?p++:b++}d=f+p;let k=0;b=0;for(let S=d;S<e.length&&b<s.length;S++){const y=e.charCodeAt(S);y>=1425&&y<=1479&&y!==1470&&y!==1472&&y!==1475&&y!==1478?k++:b++}g=d+s.length+k}r.push({start:d,end:g,termIndex:l}),h=f+1}}if(r.length===0)return n.appendChild(document.createTextNode(e)),n;r.sort((l,u)=>l.start-u.start||u.end-l.end);const a=[];for(const l of r)(a.length===0||l.start>=a[a.length-1].end)&&a.push(l);let c=0;for(const l of a){l.start>c&&n.appendChild(document.createTextNode(e.slice(c,l.start)));const u=document.createElement("mark");u.className=`term-${l.termIndex%5}`,u.textContent=e.slice(l.start,l.end),n.appendChild(u),c=l.end}return c<e.length&&n.appendChild(document.createTextNode(e.slice(c))),n}const Nn={id:"search",name:"Text Search",getVerseColor(e){if(E.length===0)return null;const t=N(e.book,e.chapter,e.verse),n=se.get(t);if(n&&n.length>0){const r=n.map(i=>Z[i%Z.length]);return r.length===1?r[0]:r.slice(0,4)}const o=(.4+.2)*T.DIM_FACTOR;return[o,o,o]},renderControls(e){e.innerHTML=`
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search Hebrew or English...">
        <button id="search-clear">&times;</button>
        <div id="search-results">
          <div id="search-count"></div>
        </div>
      </div>
    `,C=e.querySelector("#search-input"),P=e.querySelector("#search-clear"),$=e.querySelector("#search-results"),C&&j&&(C.value=j,P&&(P.style.display=j?"block":"none"),H.length>0&&xt()),C==null||C.addEventListener("input",()=>{const t=C.value.trim();P&&(P.style.display=t?"block":"none"),Ae(t)}),P==null||P.addEventListener("click",()=>{C&&(C.value="",P.style.display="none"),Ae("")}),K&&document.removeEventListener("click",K),K=t=>{$&&!$.contains(t.target)&&t.target!==C&&t.target!==P&&$.classList.remove("visible")},document.addEventListener("click",K),C==null||C.addEventListener("focus",()=>{H.length>0&&($==null||$.classList.add("visible"))})},renderLegend(e){if(e.textContent="",E.length>0&&H.length>0){const t=document.createElement("div");t.className="search-legend";for(let o=0;o<E.length;o++){const r=E[o],i=Z[o%Z.length],a=document.createElement("span");a.className="legend-term";const c=document.createElement("span");c.className="color-swatch",c.style.background=wt(i),a.appendChild(c),a.appendChild(document.createTextNode(`"${r}"`)),t.appendChild(a),o<E.length-1&&t.appendChild(document.createTextNode(" "))}const n=document.createElement("div");n.style.color="#888",n.style.fontSize="11px",n.style.marginTop="4px",n.textContent=`${H.length} matching verses`,e.appendChild(t),e.appendChild(n)}else if(j.length>0&&E.length===0){const t=document.createElement("div");t.style.color="#888",t.style.fontSize="11px",t.textContent="Type at least 2 characters per term",e.appendChild(t)}else{const t=document.createElement("div");t.style.color="#888",t.style.fontSize="11px",t.textContent="Type to search (comma-separate multiple terms)",e.appendChild(t)}},getHoverInfo(e){if(E.length===0)return null;const t=N(e.book,e.chapter,e.verse),n=se.get(t);return n?`Matches: ${n.map(r=>`"${E[r]}"`).join(", ")}`:null},onUpdate(e){ce=e},destroy(){K&&(document.removeEventListener("click",K),K=null),C=null,P=null,$=null,j="",E=[],H=[],se.clear(),ce=null,we=null},getUrlParams(){return j?{q:j}:{}},applyUrlParams(e){const t=e.get("q");t&&(Ae(t),C&&(C.value=t,P&&(P.style.display="block")))}};let Se={},L="total",D=null,W={},Tt=[];function kt(e,t,n){var r,i;const o=(i=(r=Se[e])==null?void 0:r[String(t)])==null?void 0:i[String(n)];return o?L==="total"?o.total:o.categories[L]||0:0}function Ze(){if(W[L]!==void 0)return W[L];let e=0;for(const t of Tt){const n=kt(t.book,t.chapter,t.verse);n>e&&(e=n)}return W[L]=e,e}const Ln={id:"commentary",name:"Commentary Density",async init(){try{const e=await fetch("/torahmap/data/commentary-counts.json");if(!e.ok){console.error(`Failed to load commentary-counts.json: ${e.status}`);return}Se=await e.json()}catch(e){console.error("Failed to parse commentary-counts.json:",e)}},destroy(){L="total",W={},D=null},onUpdate(e){D=e},getVerseColor(e){const t=kt(e.book,e.chapter,e.verse),n=Ze();return An(t,n)},renderControls(e){const t=document.createElement("div");t.className="commentary-controls",t.innerHTML=`
      <label for="category-select">Category:</label>
      <select id="category-select">
        <option value="total">All Commentary</option>
        <option value="Tanakh">Tanakh</option>
        <option value="Talmud">Talmud</option>
        <option value="Midrash">Midrash</option>
        <option value="Halakhah">Halakhah</option>
        <option value="Kabbalah">Kabbalah</option>
      </select>
    `;const n=t.querySelector("select");n.value=L,n.addEventListener("change",()=>{L=n.value,W={},D==null||D()}),e.appendChild(t)},renderLegend(e){const t=Ze(),n=Math.log(t+1),o=[0];let r=1;for(;r<=t;)o.push(r),r*=10;o[o.length-1]<t&&o.push(t),e.innerHTML=`
      <div class="legend-gradient"></div>
      <div class="legend-ticks">
        ${o.map(i=>{const a=i===0?0:Math.log(i+1)/n*100,c=i>=1e3?`${i/1e3}k`:String(i);return`<span class="tick" style="left: ${a}%">${c}</span>`}).join("")}
      </div>
    `},getHoverInfo(e){var o,r;const t=(r=(o=Se[e.book])==null?void 0:o[String(e.chapter)])==null?void 0:r[String(e.verse)];if(!t)return null;if(L==="total")return`${t.total} links`;const n=t.categories[L];return n?`${n} ${L}`:null},getUrlParams(){return L==="total"?{}:{cat:L}},applyUrlParams(e){const t=e.get("cat");t&&(L=t,W={},D==null||D())}};function $n(e){Tt=e.verses,W={}}function Rn(e,t,n){var r,i;const o=(i=(r=Se[e])==null?void 0:r[String(t)])==null?void 0:i[String(n)];return(o==null?void 0:o.total)??null}function Pn(){const e=document.getElementById("verse-sidebar");return{sidebar:e,ref:(e==null?void 0:e.querySelector(".ref-text"))??null,overlayInfo:(e==null?void 0:e.querySelector(".overlay-info"))??null,hebrew:(e==null?void 0:e.querySelector(".verse-hebrew"))??null,english:(e==null?void 0:e.querySelector(".verse-english"))??null,link:(e==null?void 0:e.querySelector(".sefaria-link"))??null,linkSubtitle:(e==null?void 0:e.querySelector(".link-subtitle"))??null,closeBtn:(e==null?void 0:e.querySelector(".close-btn"))??null}}function Mn(e,t,n){return`https://www.sefaria.org/${e.replace(/ /g,"_")}.${t}.${n}`}function Je(e,t){if(!e||!t)return;const n=t.getBoundingClientRect();e.style.top=`${n.bottom+10}px`}function Hn(e,t,n,o,r,i=!1){var g;const{sidebar:a,ref:c,overlayInfo:l,hebrew:u,english:s,link:h,linkSubtitle:f}=e;if(!a)return;if(!t){a.classList.remove("visible"),a.classList.remove("pinned");return}const d=r(n,t.book,t.chapter,t.verse);if(c&&(c.textContent=`${t.book} ${t.chapter}:${t.verse}`),l){const p=(g=o==null?void 0:o.getHoverInfo)==null?void 0:g.call(o,t);l.textContent=p||""}if(u){const p=(d==null?void 0:d.he)||"Loading...",b=Tn();(o==null?void 0:o.id)==="trop"&&b?u.innerHTML=kn(p,b.unicode):(o==null?void 0:o.id)==="search"?u.replaceChildren(Xe(p,"he")):u.textContent=p}if(s){const p=(d==null?void 0:d.en)||"Loading...";(o==null?void 0:o.id)==="search"?s.replaceChildren(Xe(p,"en")):s.textContent=p}if(h&&(h.href=Mn(t.book,t.chapter,t.verse)),f){const p=Rn(t.book,t.chapter,t.verse);f.textContent=p?`${p} linked texts`:""}a.classList.add("visible"),i?a.classList.add("pinned"):a.classList.remove("pinned")}const In=.1,Fn=10;function zn(e,t,n){return{x:e/2-n.width/2,y:t/2-n.height/2,zoom:1}}function Bn(e){return Math.max(In,Math.min(Fn,e))}function On(e,t,n,o,r){return{x:e.x+o*(1/n-1/t),y:e.y+r*(1/n-1/t)}}function Un(){return{isDragging:!1,hoveredVerse:null,dragStart:{x:0,y:0}}}function Vn(e,t,n){e.isDragging=!0,e.dragStart={x:t,y:n}}function Dn(e){e.isDragging=!1}function jn(e,t){e.hoveredVerse=t}function Gn(e){e.isDragging=!1,e.hoveredVerse=null}function qn(e,t,n){return{x:e/n.zoom-n.x,y:t/n.zoom-n.y}}function Kn(e,t,n){return e>=n.x&&e<n.x+n.size&&t>=n.y&&t<n.y+n.size}function Yn(e,t,n){for(const o of e)if(Kn(t,n,o))return o;return null}function Wn(e,t,n){let o=null,r=T.FUZZY_RADIUS*T.FUZZY_RADIUS;for(const i of e){const a=i.x+i.size/2,c=i.y+i.size/2,l=t-a,u=n-c,s=l*l+u*u;s<r&&(o=i,r=s)}return o}function Qe(e,t,n,o){const{x:r,y:i}=qn(n,o,t),a=Yn(e,r,i);return a||Wn(e,r,i)}function Xn(e){const t=T.MIN_BRIGHTNESS+Ne(e*3)*T.BRIGHTNESS_RANGE;return[t,t,t]}function Zn(e,t){return(e==null?void 0:e.getVerseColor(t))??null}function Jn(e,t){if(t){if(Array.isArray(e[0]))return e.map(n=>[Math.min(1,n[0]*T.BRIGHTNESS_FACTOR),Math.min(1,n[1]*T.BRIGHTNESS_FACTOR),Math.min(1,n[2]*T.BRIGHTNESS_FACTOR)]);{const n=e;return[Math.min(1,n[0]*T.BRIGHTNESS_FACTOR),Math.min(1,n[1]*T.BRIGHTNESS_FACTOR),Math.min(1,n[2]*T.BRIGHTNESS_FACTOR)]}}else return T.HIGHLIGHT_COLOR}function Qn(e,t,n,o){return e.map((r,i)=>{const a=Zn(t,r),c=a!==null,l=c?a:Xn(i),u=ge(n,r),s=ge(o,r);return{hasOverlayColor:c,baseColor:l,isHovered:u,isPinned:s}})}function eo(e){return e.map(t=>{let n=t.baseColor;return t.isHovered&&(n=Jn(n,t.hasOverlayColor)),n})}const to=`#version 300 es
  uniform vec2 u_resolution;
  uniform vec2 u_pan;
  uniform float u_zoom;

  in vec2 a_position;
  in vec3 a_color;
  in vec3 a_color2;
  in vec3 a_color3;
  in vec3 a_color4;
  in float a_colorCount;
  in vec2 a_uv;
  in vec2 a_seed;

  out vec3 v_color;
  out vec3 v_color2;
  out vec3 v_color3;
  out vec3 v_color4;
  flat out int v_colorCount;
  out vec2 v_uv;
  out vec2 v_seed;

  void main() {
    vec2 pos = (a_position + u_pan) * u_zoom;
    vec2 clipSpace = (pos / u_resolution) * 2.0 - 1.0;
    gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
    v_color = a_color;
    v_color2 = a_color2;
    v_color3 = a_color3;
    v_color4 = a_color4;
    v_colorCount = int(a_colorCount);
    v_uv = a_uv;
    v_seed = a_seed;
  }
`,no=`#version 300 es
  precision mediump float;
  in vec3 v_color;
  in vec3 v_color2;
  in vec3 v_color3;
  in vec3 v_color4;
  flat in int v_colorCount;
  in vec2 v_uv;
  in vec2 v_seed;
  out vec4 fragColor;

  // Simple hash for dithering noise and stipple selection
  float hash(vec2 p) {
    return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
  }

  // Second hash with different coefficients for variety
  float hash2(vec2 p) {
    return fract(sin(dot(p, vec2(39.346, 11.135))) * 83758.5453);
  }

  void main() {
    vec3 color;

    if (v_colorCount <= 1) {
      // Single color - use directly
      color = v_color;
    } else {
      // Multiple colors with bleed effect
      // UV < 0 or > 1 means we're in the bleed zone
      bool inBleedZone = v_uv.x < 0.0 || v_uv.x > 1.0 || v_uv.y < 0.0 || v_uv.y > 1.0;

      if (inBleedZone) {
        // In bleed zone: sparse scattered pixels
        // Use seed + UV to create unique pattern per verse
        vec2 scatterCoord = floor(v_uv * 8.0) + v_seed * 0.1;
        float scatter = hash(scatterCoord);
        float scatter2 = hash2(scatterCoord);

        // Only render ~30% of pixels in bleed zone (sparse scatter)
        if (scatter > 0.3) {
          discard;
        }

        // Pick a color from the available colors
        int idx = int(floor(scatter2 * float(v_colorCount)));
        if (idx == 0) {
          color = v_color;
        } else if (idx == 1) {
          color = v_color2;
        } else if (idx == 2) {
          color = v_color3;
        } else {
          color = v_color4;
        }
      } else {
        // Inside verse: use seed-varied stipple pattern
        // Combine UV with verse seed for unique pattern per verse
        // Use a 5x5 grid with per-verse offset for more organic feel
        vec2 blockCoord = floor(v_uv * 5.0 + fract(v_seed * 0.0731) * 5.0);
        float h = hash(blockCoord + v_seed * 0.0137);
        int idx = int(floor(h * float(v_colorCount)));

        // Select color based on hash
        if (idx == 0) {
          color = v_color;
        } else if (idx == 1) {
          color = v_color2;
        } else if (idx == 2) {
          color = v_color3;
        } else {
          color = v_color4;
        }
      }
    }

    // Add subtle dithering noise to break up moiré patterns (UV-based for zoom stability)
    vec2 noiseCoord = floor(v_uv * 12.0);
    float noise = (hash(noiseCoord + v_seed * 0.01) - 0.5) * 0.1;
    color = color + noise;

    fragColor = vec4(color, 1.0);
  }
`,oo=`#version 300 es
  uniform vec2 u_resolution;
  uniform vec2 u_pan;
  uniform float u_zoom;

  in vec2 a_position;

  void main() {
    vec2 pos = (a_position + u_pan) * u_zoom;
    vec2 clipSpace = (pos / u_resolution) * 2.0 - 1.0;
    gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
  }
`,ro=`#version 300 es
  precision mediump float;
  uniform vec3 u_color;
  out vec4 fragColor;

  void main() {
    fragColor = vec4(u_color, 1.0);
  }
`;function io(e){const t=e.getContext("webgl2",{antialias:!0});if(!t)throw new Error("WebGL2 not supported");return t}function xe(e,t,n){const o=e.createShader(t);if(!o)throw new Error("Failed to create shader");if(e.shaderSource(o,n),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(o)||"Shader compilation failed");return o}function ao(e){const t=xe(e,e.VERTEX_SHADER,to),n=xe(e,e.FRAGMENT_SHADER,no),o=e.createProgram();if(!o)throw new Error("Failed to create program");if(e.attachShader(o,t),e.attachShader(o,n),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(o)||"Program linking failed");return{program:o,attribs:{position:e.getAttribLocation(o,"a_position"),color:e.getAttribLocation(o,"a_color"),color2:e.getAttribLocation(o,"a_color2"),color3:e.getAttribLocation(o,"a_color3"),color4:e.getAttribLocation(o,"a_color4"),colorCount:e.getAttribLocation(o,"a_colorCount"),uv:e.getAttribLocation(o,"a_uv"),seed:e.getAttribLocation(o,"a_seed")},uniforms:{resolution:e.getUniformLocation(o,"u_resolution"),pan:e.getUniformLocation(o,"u_pan"),zoom:e.getUniformLocation(o,"u_zoom")}}}function so(e){const t=xe(e,e.VERTEX_SHADER,oo),n=xe(e,e.FRAGMENT_SHADER,ro),o=e.createProgram();if(!o)throw new Error("Failed to create program");if(e.attachShader(o,t),e.attachShader(o,n),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(o)||"Program linking failed");return{program:o,attribs:{position:e.getAttribLocation(o,"a_position")},uniforms:{resolution:e.getUniformLocation(o,"u_resolution"),pan:e.getUniformLocation(o,"u_pan"),zoom:e.getUniformLocation(o,"u_zoom"),color:e.getUniformLocation(o,"u_color")}}}function co(e){return Array.isArray(e)&&Array.isArray(e[0])}function At(e,t,n=T.OUTLINE_COLOR){const i=new Float32Array(e.length*6*19);let a=0;for(let c=0;c<e.length;c++){const l=e[c],u=t==null?void 0:t[c];let s;Array.isArray(u)&&u.length===0?s=[n]:co(u)?s=u.slice(0,4):s=[u||n];const h=s.length,f=h>1,d=f?T.BLEED_PIXELS:0,g=l.x-d,p=l.y-d,b=l.x+l.size-2+d,k=l.y+l.size-2+d,S=f?-d/(l.size-2):0,y=f?1+d/(l.size-2):1,z=l.x,B=l.y;for(;s.length<4;)s.push([0,0,0]);const R=(ee,U,de,fe)=>{i[a++]=ee,i[a++]=U;for(let V=0;V<4;V++)i[a++]=s[V][0],i[a++]=s[V][1],i[a++]=s[V][2];i[a++]=h,i[a++]=de,i[a++]=fe,i[a++]=z,i[a++]=B};R(g,p,S,S),R(b,p,y,S),R(g,k,S,y),R(g,k,S,y),R(b,p,y,S),R(b,k,y,y)}return i}function Ct(e,t){const n=e.createBuffer();if(!n)throw new Error("Failed to create buffer");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),n}function lo(e,t={}){const n=t.thickness??2,o=t.color??T.OUTLINE_COLOR,r=19,i=6,a=4,c=new Float32Array(a*i*r),l=e.x-n,u=e.y-n,s=e.x+e.size-2+n,h=e.y+e.size-2+n,f=e.x,d=e.y;let g=0;const p=(k,S)=>{c[g++]=k,c[g++]=S;for(let y=0;y<4;y++)c[g++]=o[0],c[g++]=o[1],c[g++]=o[2];c[g++]=1,c[g++]=0,c[g++]=0,c[g++]=f,c[g++]=d},b=(k,S,y,z)=>{p(k,S),p(y,S),p(k,z),p(k,z),p(y,S),p(y,z)};return b(l,u,s,u+n),b(s-n,u,s,h),b(l,h-n,s,h),b(l,u,l+n,h),c}function uo(e){const t=io(e),n={main:ao(t),outline:so(t)};return{gl:t,programs:n,canvas:e}}function ho(e,t,n){const o=At(t);return{buffer:Ct(e,o),outlineBuffer:null,hoverOutlineBuffer:null,verses:t,dpr:n}}function fo(e,t,n){const o=At(t.verses,n);e.bindBuffer(e.ARRAY_BUFFER,t.buffer),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW)}function mo(e,t,n,o,r){const{gl:i,programs:a,canvas:c}=e,{buffer:l,verses:u,dpr:s}=t;i.viewport(0,0,c.width,c.height),i.clearColor(.1,.1,.1,1),i.clear(i.COLOR_BUFFER_BIT),i.useProgram(a.main.program),i.uniform2f(a.main.uniforms.resolution,c.width,c.height),i.uniform2f(a.main.uniforms.pan,n.x,n.y),i.uniform1f(a.main.uniforms.zoom,n.zoom*s),i.bindBuffer(i.ARRAY_BUFFER,l);const h=19*4;i.enableVertexAttribArray(a.main.attribs.position),i.vertexAttribPointer(a.main.attribs.position,2,i.FLOAT,!1,h,0),i.enableVertexAttribArray(a.main.attribs.color),i.vertexAttribPointer(a.main.attribs.color,3,i.FLOAT,!1,h,2*4),i.enableVertexAttribArray(a.main.attribs.color2),i.vertexAttribPointer(a.main.attribs.color2,3,i.FLOAT,!1,h,5*4),i.enableVertexAttribArray(a.main.attribs.color3),i.vertexAttribPointer(a.main.attribs.color3,3,i.FLOAT,!1,h,8*4),i.enableVertexAttribArray(a.main.attribs.color4),i.vertexAttribPointer(a.main.attribs.color4,3,i.FLOAT,!1,h,11*4),i.enableVertexAttribArray(a.main.attribs.colorCount),i.vertexAttribPointer(a.main.attribs.colorCount,1,i.FLOAT,!1,h,14*4),i.enableVertexAttribArray(a.main.attribs.uv),i.vertexAttribPointer(a.main.attribs.uv,2,i.FLOAT,!1,h,15*4),i.enableVertexAttribArray(a.main.attribs.seed),i.vertexAttribPointer(a.main.attribs.seed,2,i.FLOAT,!1,h,17*4),i.drawArrays(i.TRIANGLES,0,u.length*6),o&&!ge(o,r)&&(t.hoverOutlineBuffer=et(e,t,o,[1,1,1],t.hoverOutlineBuffer,n)),r&&(t.outlineBuffer=et(e,t,r,[.2,.9,1],t.outlineBuffer,n)),window.bookLabels&&lt(window.bookLabels,{x:n.x,y:n.y},n.zoom)}function et(e,t,n,o,r,i){const{gl:a,programs:c,canvas:l}=e,{dpr:u}=t,s=lo({x:n.x,y:n.y,size:n.size},{thickness:2,color:o});let h=r;h?(a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,s,a.STATIC_DRAW)):h=Ct(a,s),a.useProgram(c.outline.program),a.uniform2f(c.outline.uniforms.resolution,l.width,l.height),a.uniform2f(c.outline.uniforms.pan,i.x,i.y),a.uniform1f(c.outline.uniforms.zoom,i.zoom*u),a.uniform3f(c.outline.uniforms.color,...o),a.bindBuffer(a.ARRAY_BUFFER,h);const f=19*4;return a.enableVertexAttribArray(c.outline.attribs.position),a.vertexAttribPointer(c.outline.attribs.position,2,a.FLOAT,!1,f,0),a.drawArrays(a.TRIANGLES,0,24),h}const ze=new Map;function re(e){ze.set(e.id,e)}function po(e){return ze.get(e)}function go(){return Array.from(ze.values())}const vo={1:[.3,.5,.9],2:[.9,.3,.3],3:[.7,.3,.8]},yo={1:"YHWH",2:"Elohim",3:"YHWH + Elohim"};let Ce={};const bo={id:"divine-names",name:"Divine Names",async init(){try{const e=await fetch("/torahmap/data/divine-names.json");if(!e.ok){console.error(`Failed to load divine-names.json: ${e.status}`);return}Ce=await e.json()}catch(e){console.error("Failed to parse divine-names.json:",e)}},getVerseColor(e){var n,o;const t=((o=(n=Ce[e.book])==null?void 0:n[e.chapter-1])==null?void 0:o[e.verse-1])??0;return t>0?vo[t]??null:null},renderLegend(e){e.innerHTML=`
      <div class="legend-row"><span class="swatch" style="background: rgb(77, 128, 230)"></span><span>YHWH</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(230, 77, 77)"></span><span>Elohim</span></div>
      <div class="legend-row"><span class="swatch" style="background: rgb(179, 77, 204)"></span><span>Both</span></div>
    `},getHoverInfo(e){var n,o;const t=((o=(n=Ce[e.book])==null?void 0:n[e.chapter-1])==null?void 0:o[e.verse-1])??0;return t>0?yo[t]:null}};function wo(e){return"torah"in e}function $e(e,t){const n=e/t*360;return bt({h:n,s:.8,l:.55})}function tt(e,t){return[Math.min(1,e[0]*t),Math.min(1,e[1]*t),Math.min(1,e[2]*t)]}function nt(e,t){const{h:n,s:o,l:r}=Cn(e);return bt({h:n,s:o*t,l:r})}let _=null,Re=null,I="ashkenazi",A=null,ie=null,q=new Map,F=new Map,Pe=new Set,pe=new Set,Q=new Map,le=0;function So(e,t){if(!Re)return 200;const n=Re.books.find(o=>o.name===e);return!n||t<1||t>n.chapters.length?200:n.chapters[t-1]}function Ee(e,t){for(let n=e.start.chapter;n<=e.end.chapter;n++){const o=n===e.start.chapter?e.start.verse:1,r=So(e.book,n),i=n===e.end.chapter?Math.min(e.end.verse,r):r;for(let a=o;a<=i;a++)t(e.book,n,a)}}function _e(){if(q.clear(),F.clear(),Pe.clear(),pe.clear(),Q.clear(),!_)return;const e=_.specialOccasions||[];le=_.parshiot.length+e.length;for(let t=0;t<_.parshiot.length;t++){const n=_.parshiot[t];Q.set(n,$e(t,le)),Ee(n.torah,(r,i,a)=>{const c=N(r,i,a);q.set(c,n),Pe.add(c)});const o=n.haftarah[I];for(const r of o)Ee(r,(i,a,c)=>{const l=N(i,a,c),u=F.get(l);u?u.push(n):F.set(l,[n]),pe.add(l)})}for(let t=0;t<e.length;t++){const n=e[t];Q.set(n,$e(_.parshiot.length+t,le));const o=n.haftarah[I];for(const r of o)Ee(r,(i,a,c)=>{const l=N(i,a,c),u=F.get(l);u?u.push(n):F.set(l,[n]),pe.add(l)})}}function ot(e){const t=N(e.book,e.chapter,e.verse);return q.has(t)||F.has(t)}const xo={id:"haftarah",name:"Haftarah",async init(){try{const[e,t]=await Promise.all([fetch("/torahmap/data/haftarah-mappings.json"),fetch("/torahmap/data/tanakh-structure.json")]);if(!e.ok){console.error(`Failed to load haftarah-mappings.json: ${e.status}`);return}if(!t.ok){console.error(`Failed to load tanakh-structure.json: ${t.status}`);return}_=await e.json(),Re=await t.json(),_e()}catch(e){console.error("Failed to initialize haftarah overlay:",e)}},destroy(){A=null,I="ashkenazi",ie=null,q.clear(),F.clear(),Pe.clear(),pe.clear(),Q.clear()},onUpdate(e){ie=e},setHoveredVerse(e){const t=A?ot(A):!1,n=e?ot(e):!1,o=n?e:null;if(!t&&!n)return A=null,!1;const r=A?N(A.book,A.chapter,A.verse):null,i=o?N(o.book,o.chapter,o.verse):null;return r===i?!1:(A=o,t||n)},getVerseColor(e){if(!_)return null;const t=N(e.book,e.chapter,e.verse),n=q.get(t),o=F.get(t);if(n){const r=Q.get(n);if(!r)return null;if(!A)return r;const i=N(A.book,A.chapter,A.verse),a=q.get(i),c=F.get(i);return a===n||c&&c.includes(n)?tt(r,T.BRIGHTNESS_FACTOR):nt(r,T.DESATURATE_FACTOR)}if(o&&o.length>0){const r=o.map(s=>Q.get(s)).filter(s=>s!==void 0);if(r.length===0)return null;if(!A)return r.length===1?r[0]:r;const i=N(A.book,A.chapter,A.verse),a=q.get(i),c=F.get(i);if(a&&o.includes(a)||c&&c.some(s=>o.includes(s))){const s=r.map(h=>tt(h,T.BRIGHTNESS_FACTOR));return s.length===1?s[0]:s}const u=r.map(s=>nt(s,T.DESATURATE_FACTOR));return u.length===1?u[0]:u}return null},renderControls(e){const t=document.createElement("div");t.className="haftarah-controls",t.innerHTML=`
      <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
        <label for="custom-select" style="font-size: 12px; color: #aaa;">Custom:</label>
        <select id="custom-select" style="flex: 1;">
          <option value="ashkenazi">Ashkenazi</option>
          <option value="sephardi">Sephardi</option>
        </select>
      </div>
    `;const n=t.querySelector("select");n.value=I,n.addEventListener("change",()=>{I=n.value,_e(),ie==null||ie()}),e.appendChild(t)},renderLegend(e){var c;const t=I==="ashkenazi"?"Ashkenazi":"Sephardi",n=(_==null?void 0:_.parshiot.length)||54,o=((c=_==null?void 0:_.specialOccasions)==null?void 0:c.length)||0,r=[],i=10;for(let l=0;l<i;l++){const s=$e(l*(le/i),le||81).map(f=>Math.round(f*255)).join(", "),h=l/(i-1)*100;r.push(`rgb(${s}) ${h}%`)}const a=r.join(", ");e.innerHTML=`
      <div class="legend-row">
        <div style="
          width: 20px;
          height: 12px;
          background: linear-gradient(to right, ${a});
          border-radius: 2px;
        "></div>
        <span>${n} Parshiot + ${o} Special Occasions</span>
      </div>
      <div style="color: #888; font-size: 10px; margin-top: 4px; margin-left: 28px; line-height: 1.3;">
        Torah portion & haftarah (${t}) use same color
      </div>
      <div style="color: #888; font-size: 10px; margin-top: 4px; margin-left: 28px; line-height: 1.3;">
        Includes holidays, fast days, special Shabbatot
      </div>
      <div style="color: #888; font-size: 10px; margin-top: 4px; margin-left: 28px; line-height: 1.3;">
        Multi-item verses show stippled pattern
      </div>
      <div style="color: #666; font-size: 10px; margin-top: 8px; line-height: 1.4;">
        Hover brightens the reading & its haftarah, desaturates others
      </div>
    `},getHoverInfo(e){if(!_)return null;const t=N(e.book,e.chapter,e.verse),n=q.get(t);if(n){const i=n.haftarah[I].map(a=>a.start.chapter===a.end.chapter?`${a.book} ${a.start.chapter}:${a.start.verse}-${a.end.verse}`:`${a.book} ${a.start.chapter}:${a.start.verse}-${a.end.chapter}:${a.end.verse}`).join(", ");return`${n.name} (${n.hebrewName}) → ${i}`}const o=F.get(t);if(o&&o.length>0){if(o.length===1){const i=o[0];return wo(i)?`Haftarah for ${i.name} (${i.hebrewName})`:`Haftarah for ${i.name} (${i.hebrewName})`}return`Haftarah for: ${o.map(i=>`${i.name} (${i.hebrewName})`).join(", ")}`}return null},getUrlParams(){return I==="ashkenazi"?{}:{custom:I}},applyUrlParams(e){if(e.get("custom")==="sephardi"){I="sephardi",_e();const n=document.querySelector("#custom-select");n&&(n.value=I)}}};async function To(){var V;document.title="Tanakh Map [main]";const[e,t]=await Promise.all([fetch("/torahmap/data/tanakh-structure.json"),Dt()]);if(!e.ok)throw new Error(`Failed to load tanakh-structure.json: ${e.status}`);let n;try{n=await e.json()}catch(m){throw new Error(`Failed to parse tanakh-structure.json: ${m}`)}const o=Bt(n),r=Ot(o);console.log(`Loaded ${o.length} verses, bounds: ${r.width}x${r.height}`),Yt(t),re(bo),re(Ln),re(Sn),re(Nn),re(xo),$n({verses:o}),xn({verseTexts:t}),await Promise.all(go().map(m=>{var v;return(v=m.init)==null?void 0:v.call(m)}));const i=document.getElementById("canvas");if(!i)throw new Error("Canvas not found");const a=window.devicePixelRatio||1;function c(){const m=window.innerWidth,v=window.innerHeight;i.width=m*a,i.height=v*a,i.style.width=m+"px",i.style.height=v+"px"}c();const l=uo(i),u=ho(l.gl,o,a);let s=null;function h(){const m=Qn(o,s,g.hoveredVerse,d),v=eo(m);fo(l.gl,u,v)}const f=zn(window.innerWidth,window.innerHeight,r);let d=null;const g=Un();function p(){mo(l,u,f,g.hoveredVerse,d)}p(),window.bookLabels=Vt(o,document.body),lt(window.bookLabels,{x:f.x,y:f.y},f.zoom),i.addEventListener("wheel",m=>{m.preventDefault();const v=m.deltaY>0?.9:1.1,w=Bn(f.zoom*v),M=m.clientX,O=m.clientY,te=On({x:f.x,y:f.y},f.zoom,w,M,O);f.x=te.x,f.y=te.y,f.zoom=w,p(),z()},{passive:!1}),i.addEventListener("mousedown",m=>{Vn(g,m.clientX,m.clientY)}),i.addEventListener("mousemove",m=>{if(g.isDragging){const v=m.clientX-g.dragStart.x,w=m.clientY-g.dragStart.y;f.x+=v/f.zoom,f.y+=w/f.zoom,g.dragStart={x:m.clientX,y:m.clientY},p()}}),i.addEventListener("mouseup",()=>{g.isDragging&&(Dn(g),z())}),i.addEventListener("mouseleave",()=>{const m=g.hoveredVerse!==null;Gn(g);let v=!1;s!=null&&s.setHoveredVerse&&(v=s.setHoveredVerse(null)),(m||v)&&(h(),p())});const b=Pn(),k=document.getElementById("controls");function S(){var v;const m={overlayParams:{}};if(s){m.overlay=s.id;const w=((v=s.getUrlParams)==null?void 0:v.call(s))??{};w.trop&&(m.overlayParams.trop=w.trop),w.cat&&(m.overlayParams.category=w.cat),w.q&&(m.overlayParams.q=w.q)}return d&&(m.verse=hn(d.book,d.chapter,d.verse)),f.zoom!==1&&(m.zoom=f.zoom),d||(m.x=f.x,m.y=f.y),m}function y(m=!1){const v=S();ln(v,m)}const z=fn(()=>y(!1),300);function B(m,v=!1){Hn(b,m,t,s,jt,v),Je(b.sidebar,k)}i.addEventListener("mousemove",m=>{if(!g.isDragging){const v=Qe(o,f,m.clientX,m.clientY),w=g.hoveredVerse;jn(g,v);const M=!ge(w,v);let O=!1;s!=null&&s.setHoveredVerse&&(O=s.setHoveredVerse(v)),(M||O)&&(h(),p()),d||(v?B(v,!1):B(null))}}),i.addEventListener("click",m=>{const v=Qe(o,f,m.clientX,m.clientY);v?d&&d.book===v.book&&d.chapter===v.chapter&&d.verse===v.verse?(d=null,B(null),h(),p(),y(!0)):(d=v,B(v,!0),h(),p(),y(!0)):d&&(d=null,B(null),h(),p(),y(!0))}),(V=b.closeBtn)==null||V.addEventListener("click",()=>{d=null,B(null),h(),p(),y(!0)});const R=document.getElementById("overlay-select"),ee=document.getElementById("overlay-controls"),U=document.getElementById("overlay-legend");function de(m,v=!1){var w,M,O,te;(w=s==null?void 0:s.destroy)==null||w.call(s),s=po(m)??null,(M=s==null?void 0:s.onUpdate)==null||M.call(s,()=>{var Be;h(),U&&(U.innerHTML="",(Be=s==null?void 0:s.renderLegend)==null||Be.call(s,U)),p(),y(!1)}),ee&&(ee.innerHTML="",(O=s==null?void 0:s.renderControls)==null||O.call(s,ee)),U&&(U.innerHTML="",(te=s==null?void 0:s.renderLegend)==null||te.call(s,U)),h(),p(),requestAnimationFrame(()=>Je(b.sidebar,k)),v||y(!0)}R==null||R.addEventListener("change",()=>{de(R.value)}),window.addEventListener("resize",()=>{c(),p()}),window.torahMap={verses:o,pan:{x:f.x,y:f.y},zoom:f.zoom,render:p,canvas:i,bounds:r},En({verses:o,callbacks:{onVerseClick:m=>{d=m,B(m,!0),h(),p(),y(!0)}}}),k&&tn(k);function fe(){const m=sn();if(m.overlay&&(de(m.overlay,!0),R&&(R.value=m.overlay),s!=null&&s.applyUrlParams)){const v=new URLSearchParams;m.overlayParams.trop&&v.set("trop",m.overlayParams.trop),m.overlayParams.category&&v.set("cat",m.overlayParams.category),m.overlayParams.q&&v.set("q",m.overlayParams.q),s.applyUrlParams(v)}if(m.zoom!==void 0&&(f.zoom=m.zoom),m.verse){const v=dn(m.verse);if(v){const w=o.find(M=>M.book===v.book&&M.chapter===v.chapter&&M.verse===v.verse);if(w){d=w,B(w,!0);const M=window.innerWidth,O=window.innerHeight;f.x=M/2/f.zoom-w.x-w.size/2,f.y=O/2/f.zoom-w.y-w.size/2}}}else m.x!==void 0&&m.y!==void 0&&(f.x=m.x,f.y=m.y);h(),p()}window.location.hash&&fe(),un(()=>{fe()})}To().catch(console.error);
