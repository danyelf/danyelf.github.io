import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as Q}from"./data-utils-HFH0zg-E.js";const n=40,Z=10,p={top:50,right:20,bottom:200,left:250};function m(g){const i=Math.floor(g/5);return g*n+i*Z}let w=[],s=[],k={},C={},M=[],u=null,d=null;async function U(){try{w=await Q("../data.json"),V(),D()}catch(g){console.error("Error initializing matrix:",g),document.getElementById("subtitle").textContent="Error loading data"}}function V(){if(!w.some(o=>o.permission_categories&&Object.keys(o.permission_categories).length>0)){console.warn("No permission_categories found, falling back to flat view");const o=new Set;w.forEach(r=>{r.permissions&&Array.isArray(r.permissions)&&r.permissions.forEach(y=>o.add(y))}),s=Array.from(o).sort(),window.categoryBoundaries=[],k={},C={},s.forEach(r=>{k[r]={},C[r]={},s.forEach(y=>{const b=w.filter(h=>{const E=h.permissions||[];return E.includes(r)&&E.includes(y)}).length,c=w.filter(h=>{const E=h.permissions||[];return h.status==="warning"&&E.includes(r)&&E.includes(y)}).length;k[r][y]=b,C[r][y]=c})}),document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (flat view)`;return}const i=new Map;w.forEach(o=>{const r=o.permission_categories||{};Object.keys(r).forEach(y=>{i.has(y)||i.set(y,new Set),r[y].forEach(b=>{i.get(y).add(b)})})});const I=Array.from(i.keys()).sort();s=[];const $=[];I.forEach(o=>{const r=Array.from(i.get(o)).sort();$.push({category:o,startIndex:s.length,count:r.length}),s.push(...r)}),window.categoryBoundaries=$,M=$,window.categoryMap=i,console.log(`Found ${I.length} categories, ${s.length} permissions`),k={},C={},s.forEach(o=>{k[o]={},C[o]={},s.forEach(r=>{const y=w.filter(c=>{const h=c.permissions||[];return h.includes(o)&&h.includes(r)}).length,b=w.filter(c=>{const h=c.permissions||[];return c.status==="warning"&&h.includes(o)&&h.includes(r)}).length;k[o][r]=y,C[o][r]=b})}),document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (${I.length} categories)`}function N(g,i){u=g,d=i;const I=g?Array.from(window.categoryMap.get(g)).sort():s,$=i?Array.from(window.categoryMap.get(i)).sort():s;window.filteredXPermissions=I,window.filteredYPermissions=$,D()}function D(){if(console.log("Rendering matrix..."),s.length===0){const t=w.length===0?"No data loaded. Generate data with: python generator/generate_data.py --count 100 --output viewer/data.json":"No permissions found in data";document.getElementById("subtitle").textContent=t;return}const g=window.filteredXPermissions||s,i=window.filteredYPermissions||s,I=document.getElementById("zoom-controls");if(u||d){I.style.display="block";let t="Zoomed: ";u&&d?t+=`X: ${u}, Y: ${d}`:u?t+=`X: ${u}`:t+=`Y: ${d}`,document.getElementById("subtitle").textContent=`${w.length} agents, ${t}`}else{I.style.display="none";const t=M.length;document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (${t} categories)`}const $=g.length,o=i.length,r=u?$*n+p.left+p.right:M.length>0?m(s.length-1)+n+p.left+p.right:s.length*n+p.left+p.right,y=d?o*n+p.top+p.bottom:M.length>0?m(s.length-1)+n+p.top+p.bottom:s.length*n+p.top+p.bottom,b=d3.select("#matrix-svg");b.selectAll("*").remove(),b.attr("width",r).attr("height",y);const c=b.append("g").attr("transform",`translate(${p.left},${p.top})`);let h=0,E=0;i.forEach((t,l)=>{g.forEach((e,a)=>{t!==e&&(h=Math.max(h,k[t][e]),E=Math.max(E,C[t][e]))})});const B=d3.scaleSequential(d3.interpolateBlues).domain([0,h]),R=n*.4,T=d3.scaleLinear().domain([0,E]).range([0,R]),L=d3.select("#tooltip"),Y=u?(t=>t*n):m,X=d?(t=>t*n):m;i.forEach((t,l)=>{g.forEach((e,a)=>{if(t===e)return;const x=k[t][e],f=C[t][e];c.append("rect").attr("class","matrix-cell").attr("x",Y(a)).attr("y",X(l)).attr("width",n).attr("height",n).attr("fill",B(x)).attr("data-perm-a",t).attr("data-perm-b",e).attr("data-count",x).attr("data-warning-count",f).on("mouseover",function(P){const _=this.getAttribute("data-perm-a"),H=this.getAttribute("data-perm-b"),v=this.getAttribute("data-count"),j=this.getAttribute("data-warning-count");let G=`<strong>${_}</strong> × <strong>${H}</strong><br>${v} agent${v!=="1"?"s":""}`;j>0&&(G+=`<br><span style="color: #dc3545;">⚠ ${j} warning${j!=="1"?"s":""}</span>`),L.classed("visible",!0).style("left",P.pageX+10+"px").style("top",P.pageY-10+"px").html(G)}).on("mousemove",function(P){L.style("left",P.pageX+10+"px").style("top",P.pageY-10+"px")}).on("mouseout",function(){L.classed("visible",!1)})})}),i.forEach((t,l)=>{g.forEach((e,a)=>{if(t===e)return;const x=C[t][e];if(x===0)return;const f=T(x),P=Y(a),_=X(l),H=P+(n-f)/2,v=_+(n-f)/2;c.append("rect").attr("class","warning-box").attr("x",H).attr("y",v).attr("width",f).attr("height",f).attr("fill","#dc3545").attr("opacity",.8).style("pointer-events","none")})});const q=u?$*n:window.categoryBoundaries.length>0?m(s.length-1)+n:s.length*n,S=d?o*n:window.categoryBoundaries.length>0?m(s.length-1)+n:s.length*n,z=window.categoryBoundaries;if(z&&z.length>0&&z.forEach((t,l)=>{if(l===z.length-1)return;const e=t.startIndex+t.count-1,a=m(e)+n+Z/2;u||c.append("line").attr("class","category-boundary").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",S).attr("stroke","#333").attr("stroke-width",3),d||c.append("line").attr("class","category-boundary").attr("x1",0).attr("y1",a).attr("x2",q).attr("y2",a).attr("stroke","#333").attr("stroke-width",3)}),z&&z.length>0){const t=c.append("g").attr("class","x-category-headers");if(u){const e=$*n/2,a=d?o*n+15:S+15;t.append("text").attr("class","category-header-label").attr("x",e).attr("y",a).attr("text-anchor","middle").style("font-weight","bold").style("font-size","14px").style("fill","#0066cc").text(u)}else{const e=d?o*n+15:S+15;window.categoryBoundaries.forEach(a=>{const x=m(a.startIndex),f=m(a.startIndex+a.count-1)+n,P=(x+f)/2;t.append("text").attr("class","category-header-label clickable-category").attr("x",P).attr("y",e).attr("text-anchor","middle").style("font-weight","bold").style("font-size","14px").style("cursor","pointer").style("fill","#2c3e50").text(a.category).on("click",function(){N(a.category,d)})})}const l=c.append("g").attr("class","x-axis");if(u){const e=d?o*n+40:S+40;g.forEach((a,x)=>{const f=Y(x)+n/2;l.append("text").attr("class","axis-label x-axis-label").attr("x",f).attr("y",e).attr("transform",`rotate(45, ${f}, ${e})`).text(a)})}else{const e=d?o*n+40:S+40;s.forEach((a,x)=>{const f=m(x)+n/2;l.append("text").attr("class","axis-label x-axis-label").attr("x",f).attr("y",e).attr("transform",`rotate(45, ${f}, ${e})`).text(a)})}}else{const t=c.append("g").attr("class","x-axis"),l=S+10;g.forEach((e,a)=>{const x=Y(a)+n/2;t.append("text").attr("class","axis-label x-axis-label").attr("x",x).attr("y",l).attr("transform",`rotate(45, ${x}, ${l})`).text(e)})}if(z&&z.length>0){const t=c.append("g").attr("class","y-category-headers");if(!d)window.categoryBoundaries.forEach(e=>{const a=m(e.startIndex),x=m(e.startIndex+e.count-1)+n,f=(a+x)/2;t.append("text").attr("class","category-header-label clickable-category").attr("x",-60).attr("y",f).attr("dy","0.35em").attr("text-anchor","end").style("font-weight","bold").style("font-size","14px").style("cursor","pointer").style("fill","#2c3e50").text(e.category).on("click",function(){N(u,e.category)})});else{const e=o*n/2;t.append("text").attr("class","category-header-label").attr("x",-60).attr("y",e).attr("dy","0.35em").attr("text-anchor","end").style("font-weight","bold").style("font-size","14px").style("fill","#0066cc").text(d)}const l=c.append("g").attr("class","y-axis");d?i.forEach((e,a)=>{l.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",X(a)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(e)}):s.forEach((e,a)=>{l.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",m(a)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(e)})}else{const t=c.append("g").attr("class","y-axis");i.forEach((l,e)=>{t.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",X(e)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(l)})}const O=200,F=20,J=matrixPixelSize-O,W=c.append("g").attr("class","legend").attr("transform",`translate(${J}, -35)`),K=b.append("defs").append("linearGradient").attr("id","legend-gradient");for(let t=0;t<=10;t++){const l=t*10,e=h*t/10;K.append("stop").attr("offset",`${l}%`).attr("stop-color",B(e))}W.append("rect").attr("width",O).attr("height",F).style("fill","url(#legend-gradient)").style("stroke","#ccc").style("stroke-width",1),W.append("text").attr("class","legend-label").attr("x",0).attr("y",-5).text("0"),W.append("text").attr("class","legend-label").attr("x",O).attr("y",-5).attr("text-anchor","end").text(`${h} agents`)}U();
