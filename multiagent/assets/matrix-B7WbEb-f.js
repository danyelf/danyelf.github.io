import"./modulepreload-polyfill-B5Qt9EMX.js";const n=40,T=10,p={top:50,right:20,bottom:200,left:250};function m(l){const i=Math.floor(l/5);return l*n+i*T}let w=[],s=[],z={},C={},M=[],u=null,g=null;async function Q(){try{w=await U(),V(),Z()}catch(l){console.error("Error initializing matrix:",l),document.getElementById("subtitle").textContent="Error loading data"}}async function U(){const l=await fetch("../data.json");if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const i=await l.json();return console.log(`Loaded ${i.length} records`),i}function V(){if(!w.some(o=>o.permission_categories&&Object.keys(o.permission_categories).length>0)){console.warn("No permission_categories found, falling back to flat view");const o=new Set;w.forEach(r=>{r.permissions&&Array.isArray(r.permissions)&&r.permissions.forEach(y=>o.add(y))}),s=Array.from(o).sort(),window.categoryBoundaries=[],z={},C={},s.forEach(r=>{z[r]={},C[r]={},s.forEach(y=>{const b=w.filter(h=>{const E=h.permissions||[];return E.includes(r)&&E.includes(y)}).length,d=w.filter(h=>{const E=h.permissions||[];return h.status==="warning"&&E.includes(r)&&E.includes(y)}).length;z[r][y]=b,C[r][y]=d})}),document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (flat view)`;return}const i=new Map;w.forEach(o=>{const r=o.permission_categories||{};Object.keys(r).forEach(y=>{i.has(y)||i.set(y,new Set),r[y].forEach(b=>{i.get(y).add(b)})})});const I=Array.from(i.keys()).sort();s=[];const $=[];I.forEach(o=>{const r=Array.from(i.get(o)).sort();$.push({category:o,startIndex:s.length,count:r.length}),s.push(...r)}),window.categoryBoundaries=$,M=$,window.categoryMap=i,console.log(`Found ${I.length} categories, ${s.length} permissions`),z={},C={},s.forEach(o=>{z[o]={},C[o]={},s.forEach(r=>{const y=w.filter(d=>{const h=d.permissions||[];return h.includes(o)&&h.includes(r)}).length,b=w.filter(d=>{const h=d.permissions||[];return d.status==="warning"&&h.includes(o)&&h.includes(r)}).length;z[o][r]=y,C[o][r]=b})}),document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (${I.length} categories)`}function N(l,i){u=l,g=i;const I=l?Array.from(window.categoryMap.get(l)).sort():s,$=i?Array.from(window.categoryMap.get(i)).sort():s;window.filteredXPermissions=I,window.filteredYPermissions=$,Z()}function Z(){if(console.log("Rendering matrix..."),s.length===0){const t=w.length===0?"No data loaded. Generate data with: python generator/generate_data.py --count 100 --output viewer/data.json":"No permissions found in data";document.getElementById("subtitle").textContent=t;return}const l=window.filteredXPermissions||s,i=window.filteredYPermissions||s,I=document.getElementById("zoom-controls");if(u||g){I.style.display="block";let t="Zoomed: ";u&&g?t+=`X: ${u}, Y: ${g}`:u?t+=`X: ${u}`:t+=`Y: ${g}`,document.getElementById("subtitle").textContent=`${w.length} agents, ${t}`}else{I.style.display="none";const t=M.length;document.getElementById("subtitle").textContent=`${w.length} agents, ${s.length} permissions (${t} categories)`}const $=l.length,o=i.length,r=u?$*n+p.left+p.right:M.length>0?m(s.length-1)+n+p.left+p.right:s.length*n+p.left+p.right,y=g?o*n+p.top+p.bottom:M.length>0?m(s.length-1)+n+p.top+p.bottom:s.length*n+p.top+p.bottom,b=d3.select("#matrix-svg");b.selectAll("*").remove(),b.attr("width",r).attr("height",y);const d=b.append("g").attr("transform",`translate(${p.left},${p.top})`);let h=0,E=0;i.forEach((t,c)=>{l.forEach((e,a)=>{t!==e&&(h=Math.max(h,z[t][e]),E=Math.max(E,C[t][e]))})});const B=d3.scaleSequential(d3.interpolateBlues).domain([0,h]),D=n*.4,R=d3.scaleLinear().domain([0,E]).range([0,D]),L=d3.select("#tooltip"),Y=u?(t=>t*n):m,X=g?(t=>t*n):m;i.forEach((t,c)=>{l.forEach((e,a)=>{if(t===e)return;const f=z[t][e],x=C[t][e];d.append("rect").attr("class","matrix-cell").attr("x",Y(a)).attr("y",X(c)).attr("width",n).attr("height",n).attr("fill",B(f)).attr("data-perm-a",t).attr("data-perm-b",e).attr("data-count",f).attr("data-warning-count",x).on("mouseover",function(P){const W=this.getAttribute("data-perm-a"),_=this.getAttribute("data-perm-b"),v=this.getAttribute("data-count"),j=this.getAttribute("data-warning-count");let G=`<strong>${W}</strong> × <strong>${_}</strong><br>${v} agent${v!=="1"?"s":""}`;j>0&&(G+=`<br><span style="color: #dc3545;">⚠ ${j} warning${j!=="1"?"s":""}</span>`),L.classed("visible",!0).style("left",P.pageX+10+"px").style("top",P.pageY-10+"px").html(G)}).on("mousemove",function(P){L.style("left",P.pageX+10+"px").style("top",P.pageY-10+"px")}).on("mouseout",function(){L.classed("visible",!1)})})}),i.forEach((t,c)=>{l.forEach((e,a)=>{if(t===e)return;const f=C[t][e];if(f===0)return;const x=R(f),P=Y(a),W=X(c),_=P+(n-x)/2,v=W+(n-x)/2;d.append("rect").attr("class","warning-box").attr("x",_).attr("y",v).attr("width",x).attr("height",x).attr("fill","#dc3545").attr("opacity",.8).style("pointer-events","none")})});const q=u?$*n:window.categoryBoundaries.length>0?m(s.length-1)+n:s.length*n,S=g?o*n:window.categoryBoundaries.length>0?m(s.length-1)+n:s.length*n,k=window.categoryBoundaries;if(k&&k.length>0&&k.forEach((t,c)=>{if(c===k.length-1)return;const e=t.startIndex+t.count-1,a=m(e)+n+T/2;u||d.append("line").attr("class","category-boundary").attr("x1",a).attr("y1",0).attr("x2",a).attr("y2",S).attr("stroke","#333").attr("stroke-width",3),g||d.append("line").attr("class","category-boundary").attr("x1",0).attr("y1",a).attr("x2",q).attr("y2",a).attr("stroke","#333").attr("stroke-width",3)}),k&&k.length>0){const t=d.append("g").attr("class","x-category-headers");if(u){const e=$*n/2,a=g?o*n+15:S+15;t.append("text").attr("class","category-header-label").attr("x",e).attr("y",a).attr("text-anchor","middle").style("font-weight","bold").style("font-size","14px").style("fill","#0066cc").text(u)}else{const e=g?o*n+15:S+15;window.categoryBoundaries.forEach(a=>{const f=m(a.startIndex),x=m(a.startIndex+a.count-1)+n,P=(f+x)/2;t.append("text").attr("class","category-header-label clickable-category").attr("x",P).attr("y",e).attr("text-anchor","middle").style("font-weight","bold").style("font-size","14px").style("cursor","pointer").style("fill","#2c3e50").text(a.category).on("click",function(){N(a.category,g)})})}const c=d.append("g").attr("class","x-axis");if(u){const e=g?o*n+40:S+40;l.forEach((a,f)=>{const x=Y(f)+n/2;c.append("text").attr("class","axis-label x-axis-label").attr("x",x).attr("y",e).attr("transform",`rotate(45, ${x}, ${e})`).text(a)})}else{const e=g?o*n+40:S+40;s.forEach((a,f)=>{const x=m(f)+n/2;c.append("text").attr("class","axis-label x-axis-label").attr("x",x).attr("y",e).attr("transform",`rotate(45, ${x}, ${e})`).text(a)})}}else{const t=d.append("g").attr("class","x-axis"),c=S+10;l.forEach((e,a)=>{const f=Y(a)+n/2;t.append("text").attr("class","axis-label x-axis-label").attr("x",f).attr("y",c).attr("transform",`rotate(45, ${f}, ${c})`).text(e)})}if(k&&k.length>0){const t=d.append("g").attr("class","y-category-headers");if(!g)window.categoryBoundaries.forEach(e=>{const a=m(e.startIndex),f=m(e.startIndex+e.count-1)+n,x=(a+f)/2;t.append("text").attr("class","category-header-label clickable-category").attr("x",-60).attr("y",x).attr("dy","0.35em").attr("text-anchor","end").style("font-weight","bold").style("font-size","14px").style("cursor","pointer").style("fill","#2c3e50").text(e.category).on("click",function(){N(u,e.category)})});else{const e=o*n/2;t.append("text").attr("class","category-header-label").attr("x",-60).attr("y",e).attr("dy","0.35em").attr("text-anchor","end").style("font-weight","bold").style("font-size","14px").style("fill","#0066cc").text(g)}const c=d.append("g").attr("class","y-axis");g?i.forEach((e,a)=>{c.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",X(a)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(e)}):s.forEach((e,a)=>{c.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",m(a)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(e)})}else{const t=d.append("g").attr("class","y-axis");i.forEach((c,e)=>{t.append("text").attr("class","axis-label y-axis-label").attr("x",-10).attr("y",X(e)+n/2).attr("dy","0.35em").attr("text-anchor","end").text(c)})}const H=200,F=20,J=matrixPixelSize-H,O=d.append("g").attr("class","legend").attr("transform",`translate(${J}, -35)`),K=b.append("defs").append("linearGradient").attr("id","legend-gradient");for(let t=0;t<=10;t++){const c=t*10,e=h*t/10;K.append("stop").attr("offset",`${c}%`).attr("stop-color",B(e))}O.append("rect").attr("width",H).attr("height",F).style("fill","url(#legend-gradient)").style("stroke","#ccc").style("stroke-width",1),O.append("text").attr("class","legend-label").attr("x",0).attr("y",-5).text("0"),O.append("text").attr("class","legend-label").attr("x",H).attr("y",-5).attr("text-anchor","end").text(`${h} agents`)}Q();
