import{c as B}from"./regl-DHGzB4BJ.js";const E={Copilot:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <rect x="2" y="2" width="12" height="12" fill="white" opacity="0.9"/>
    <rect x="18" y="2" width="12" height="12" fill="white" opacity="0.9"/>
    <rect x="2" y="18" width="12" height="12" fill="white" opacity="0.9"/>
    <rect x="18" y="18" width="12" height="12" fill="white" opacity="0.9"/>
  </svg>`,"Copilot Studio":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <rect x="3" y="3" width="10" height="10" fill="white" opacity="0.9"/>
    <rect x="19" y="3" width="10" height="10" fill="white" opacity="0.9"/>
    <rect x="3" y="19" width="10" height="10" fill="white" opacity="0.9"/>
    <circle cx="24" cy="24" r="7" fill="none" stroke="white" stroke-width="2"/>
    <circle cx="24" cy="24" r="3" fill="white"/>
  </svg>`,Anthropic:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M16 4 L6 28 L12 28 L14 22 L18 22 L20 28 L26 28 L16 4" fill="white" opacity="0.9"/>
    <rect x="13" y="16" width="6" height="2" fill="rgba(0,0,0,0.3)"/>
  </svg>`,OpenAI:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M16 3 L27 9 L27 21 L16 27 L5 21 L5 9 Z" fill="none" stroke="white" stroke-width="2.5"/>
    <circle cx="16" cy="15" r="5" fill="white" opacity="0.9"/>
  </svg>`,"Azure AI":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M8 22 Q2 22 2 16 Q2 11 7 10 Q8 5 14 5 Q20 5 22 9 Q29 9 29 15 Q29 22 22 22 Z" fill="white" opacity="0.9"/>
  </svg>`,"Google AI":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M16 6 A10 10 0 1 0 16 26 A10 10 0 0 0 26 16 L16 16" fill="none" stroke="white" stroke-width="4" stroke-linecap="round"/>
  </svg>`,"AWS Bedrock":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M16 4 L28 16 L22 16 L22 28 L10 28 L10 16 L4 16 Z" fill="white" opacity="0.9"/>
  </svg>`,"Hugging Face":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <circle cx="16" cy="16" r="12" fill="none" stroke="white" stroke-width="2"/>
    <circle cx="11" cy="13" r="2" fill="white"/>
    <circle cx="21" cy="13" r="2" fill="white"/>
    <path d="M10 20 Q16 26 22 20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/>
  </svg>`,Cohere:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M22 8 A10 10 0 1 0 22 24" fill="none" stroke="white" stroke-width="4" stroke-linecap="round"/>
  </svg>`,"Mistral AI":`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
    <path d="M6 10 Q16 6 26 10" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
    <path d="M6 16 Q16 12 26 16" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
    <path d="M6 22 Q16 18 26 22" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
  </svg>`};function T(){return Object.keys(E)}function k(p){return E[p]||E.OpenAI}function F(p){return`data:image/svg+xml,${encodeURIComponent(p.replace(/\n/g,"").replace(/\s+/g," ").trim())}`}class H{constructor(e){this.iconTexture=null,this.dummyTexture=null,this.platformIndices=new Map,this.textureReady=!1,this.canvas=e.canvas,this.particleShape=e.particleShape,this.regl=B({canvas:this.canvas,attributes:{antialias:!1,alpha:!1}}),this.dummyTexture=this.regl.texture({width:1,height:1,data:[0,0,0,0]}),this.drawParticles=this.regl({vert:`
        precision mediump float;

        attribute vec2 position;
        attribute vec4 color;
        attribute float size;
        attribute float platformIdx;

        varying vec4 vColor;
        varying float vPlatformIdx;
        varying float vSize;

        uniform vec2 canvasSize;

        void main() {
          // Convert from pixel coordinates to clip space (-1 to 1)
          vec2 clipSpace = (position / canvasSize) * 2.0 - 1.0;

          // Flip Y axis (canvas Y goes down, clip space Y goes up)
          clipSpace.y = -clipSpace.y;

          gl_Position = vec4(clipSpace, 0.0, 1.0);
          gl_PointSize = size;

          vColor = color;
          vPlatformIdx = platformIdx;
          vSize = size;
        }
      `,frag:`
        precision mediump float;

        varying vec4 vColor;
        varying float vPlatformIdx;
        varying float vSize;

        uniform sampler2D iconTexture;
        uniform float textureSize;
        uniform float iconSize;
        uniform bool useIcons;

        void main() {
          // gl_PointCoord ranges from 0 to 1 across the point sprite
          vec2 coord = gl_PointCoord - 0.5;
          float dist = length(coord);

          // Discard fragments outside the circle
          if (dist > 0.5) {
            discard;
          }

          // Base color with soft edge
          float edgeSoftness = 1.0 - smoothstep(0.4, 0.5, dist);
          vec4 baseColor = vec4(vColor.rgb, vColor.a * edgeSoftness);

          // Only show icons on larger particles (size > 6 pixels)
          if (useIcons && vSize > 6.0 && vPlatformIdx >= 0.0) {
            // Calculate UV coordinates for this platform's icon in the atlas
            float iconsPerRow = textureSize / iconSize;
            float row = floor(vPlatformIdx / iconsPerRow);
            float col = mod(vPlatformIdx, iconsPerRow);
            
            // Map point coord to icon UV
            float uvSize = iconSize / textureSize;
            vec2 iconUV = vec2(
              (col * iconSize + gl_PointCoord.x * iconSize) / textureSize,
              (row * iconSize + gl_PointCoord.y * iconSize) / textureSize
            );
            
            // Sample icon texture
            vec4 iconColor = texture2D(iconTexture, iconUV);
            
            // Blend icon with base color - icon is white, use it as alpha mask
            // Increased from 0.7 to 0.95 for bolder, more visible icons
            float iconAlpha = iconColor.a * iconColor.r * 0.95;
            
            // Only show icon in center area (expanded from 0.3 to 0.35 radius)
            float iconRadius = 0.35;
            float iconMask = 1.0 - smoothstep(iconRadius - 0.03, iconRadius, dist);
            iconAlpha *= iconMask;
            
            // Mix icon on top of base color
            vec3 finalColor = mix(baseColor.rgb, vec3(1.0), iconAlpha);
            gl_FragColor = vec4(finalColor, baseColor.a);
          } else {
            gl_FragColor = baseColor;
          }
        }
      `,attributes:{position:this.regl.prop("positions"),color:this.regl.prop("colors"),size:this.regl.prop("sizes"),platformIdx:this.regl.prop("platformIndices")},uniforms:{canvasSize:()=>[this.canvas.width,this.canvas.height],iconTexture:()=>this.iconTexture||this.dummyTexture,textureSize:256,iconSize:64,useIcons:()=>this.textureReady&&this.iconTexture!==null},count:this.regl.prop("count"),primitive:"points",blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1}}}),this.initIconTexture()}async initIconTexture(){const e=T(),s=256,o=64,i=Math.floor(s/o),n=document.createElement("canvas");n.width=s,n.height=s;const a=n.getContext("2d");a.clearRect(0,0,s,s);const t=e.map((r,c)=>new Promise(l=>{const g=new Image,d=k(r);g.onload=()=>{const u=Math.floor(c/i),m=c%i;a.drawImage(g,m*o,u*o,o,o),this.platformIndices.set(r,c),l()},g.onerror=()=>{console.warn(`Failed to load icon for ${r}`),this.platformIndices.set(r,0),l()},g.src=F(d)}));await Promise.all(t),this.iconTexture=this.regl.texture({data:n,min:"linear",mag:"linear",wrapS:"clamp",wrapT:"clamp"}),this.textureReady=!0,console.log("Platform icon texture loaded with",e.length,"icons")}getPlatformIndex(e){return this.platformIndices.get(e)??-1}render(e,s,o,i,n=!0){const a=e.length/2;n&&this.regl.clear({color:[.05,.05,.05,1],depth:1}),this.drawParticles({positions:e,colors:s,sizes:o,platformIndices:i,count:a})}renderLegacy(e,s,o,i=!0){const n=e.length/2,a=new Float32Array(n).fill(-1);this.render(e,s,o,a,i)}resize(e,s){this.canvas.width=e,this.canvas.height=s}destroy(){this.regl.destroy()}}class Y{constructor(){this.palette=[[.2,.4,.9],[.2,.8,.3],[.95,.7,.1],[.7,.2,.9],[.1,.8,.9],[.95,.4,.1],[.6,.9,.2],[.95,.2,.5],[.2,.6,.7],[.8,.4,.9]],this.warningGlowColor=[.95,.1,.1],this.colorMap=new Map}assignColors(e,s){[...new Set(e.map(i=>String(i[s])))].forEach((i,n)=>{this.colorMap.set(i,this.palette[n%this.palette.length])})}getColor(e){return this.colorMap.get(e)||[.5,.5,.5]}getWarningGlowColor(){return this.warningGlowColor}getColorMap(){return new Map(this.colorMap)}}function S(p,e,s,o){const i=s/2,n=o/2,a=p-i,t=e-n,r=Math.sqrt(a*a+t*t);if(r===0){const c=Math.random()*Math.PI*2;return{dx:Math.cos(c),dy:Math.sin(c)}}return{dx:a/r,dy:t/r}}function q(p,e,s,o){if(!o)return 1;const i=p.x-e,n=p.y-s,a=Math.sqrt(i*i+n*n),t=100;return a>=t?1:.2+.8*a/t}function D(p,e,s,o,i=-1e3,n=-1e3,a=!1){const t=q(p,i,n,a);p.vx+=(Math.random()-.5)*s*e*t,p.vy+=(Math.random()-.5)*s*e*t;const r=a&&t<1?o*.9:o;p.vx*=r,p.vy*=r,p.x+=p.vx*e,p.y+=p.vy*e}class R{constructor(e=.5,s=.95,o=800,i=600){this.speed=e,this.damping=s,this.canvasWidth=o,this.canvasHeight=i}getName(){return"Brownian Motion"}setCanvasDimensions(e,s){this.canvasWidth=e,this.canvasHeight=s}update(e,s,o=-1e3,i=-1e3,n=!1){const a=Math.min(s/16.67,2);for(const t of e){if(t.frozen)continue;if(t.hidden){const c=S(t.x,t.y,this.canvasWidth,this.canvasHeight),l=2;t.vx+=c.dx*l*a,t.vy+=c.dy*l*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}if(t.returning){const c=this.canvasWidth/2,l=this.canvasHeight/2,g=t.x-c,d=t.y-l;if(Math.sqrt(g*g+d*d)<100)t.returning=!1;else{const m=S(t.x,t.y,this.canvasWidth,this.canvasHeight),h=2;t.vx-=m.dx*h*a,t.vy-=m.dy*h*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}}D(t,a,this.speed,this.damping,o,i,n);const r=t.size/2;t.x-r<0?(t.x=r,t.vx=Math.abs(t.vx)):t.x+r>this.canvasWidth&&(t.x=this.canvasWidth-r,t.vx=-Math.abs(t.vx)),t.y-r<0?(t.y=r,t.vy=Math.abs(t.vy)):t.y+r>this.canvasHeight&&(t.y=this.canvasHeight-r,t.vy=-Math.abs(t.vy))}}}class L{constructor(e=.3,s=.95,o=800,i=600,n="role"){this.speed=e,this.damping=s,this.canvasWidth=o,this.canvasHeight=i,this.attribute=n,this.discs=new Map,this.particleDiscs=new Map}getName(){return"Disc Clustering"}setClusteringAttribute(e){this.attribute=e}getClusteringAttribute(){return this.attribute}setCanvasDimensions(e,s){if(this.canvasWidth=e,this.canvasHeight=s,this.particleDiscs.size>0){const o=new Map;this.particleDiscs.forEach((i,n)=>{const a=String(n.agentData[this.attribute]);o.set(a,(o.get(a)||0)+1)}),this.calculateDiscPositions(o),this.particleDiscs.forEach((i,n)=>{const a=String(n.agentData[this.attribute]),t=this.discs.get(a);if(t){const r=Math.atan2(n.y-i.y,n.x-i.x),c=Math.sqrt(Math.pow(n.x-i.x,2)+Math.pow(n.y-i.y,2)),g=Math.min(c/i.radius,.8)*t.radius;n.x=t.x+Math.cos(r)*g,n.y=t.y+Math.sin(r)*g,this.particleDiscs.set(n,t)}})}}initializeParticles(e){const s=new Map;for(const o of e){const i=String(o.agentData[this.attribute]);s.set(i,(s.get(i)||0)+1)}this.calculateDiscPositions(s);for(const o of e){const i=String(o.agentData[this.attribute]),n=this.discs.get(i);if(n){this.particleDiscs.set(o,n);const a=Math.random()*Math.PI*2,t=Math.random()*n.radius*.8;o.x=n.x+Math.cos(a)*t,o.y=n.y+Math.sin(a)*t,o.vx=0,o.vy=0}}}assignParticlesToDiscs(e){const s=new Map;for(const o of e){const i=String(o.agentData[this.attribute]);s.set(i,(s.get(i)||0)+1)}this.calculateDiscPositions(s);for(const o of e){const i=String(o.agentData[this.attribute]),n=this.discs.get(i);n&&this.particleDiscs.set(o,n)}}calculateDiscPositions(e){const s=Array.from(e.keys());Array.from(e.values()).reduce((n,a)=>n+a,0);const o=.02,i=new Map;s.forEach(n=>{const t=(e.get(n)||0)/o,r=Math.sqrt(t/Math.PI);i.set(n,r)}),this.packDiscs(s,i)}packDiscs(e,s){const o=this.canvasWidth/2,i=this.canvasHeight/2,n=10;this.discs.clear();const a=e.sort((t,r)=>{const c=s.get(t)||0;return(s.get(r)||0)-c});if(a.length>0){const t=a[0],r=s.get(t)||50;this.discs.set(t,{x:o,y:i,radius:r})}for(let t=1;t<a.length;t++){const r=a[t],c=s.get(r)||50,l=this.findNonOverlappingPosition(o,i,c,n);this.discs.set(r,{x:l.x,y:l.y,radius:c})}}findNonOverlappingPosition(e,s,o,i){const n=Array.from(this.discs.values()),a=360,t=Math.PI*2/36;let r=0;const c=5;for(let l=0;l<a;l++){const g=l*t;r+=c;const d=e+Math.cos(g)*r,u=s+Math.sin(g)*r;if(!n.some(h=>{const v=d-h.x,f=u-h.y,y=o+h.radius+i;return Math.sqrt(v*v+f*f)<y}))return{x:d,y:u}}return{x:e,y:s}}update(e,s,o=-1e3,i=-1e3,n=!1){const a=Math.min(s/16.67,2);for(const t of e){if(t.frozen)continue;if(t.hidden){const d=S(t.x,t.y,this.canvasWidth,this.canvasHeight),u=2;t.vx+=d.dx*u*a,t.vy+=d.dy*u*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}if(t.returning){const d=this.canvasWidth/2,u=this.canvasHeight/2,m=t.x-d,h=t.y-u;if(Math.sqrt(m*m+h*h)<100)t.returning=!1;else{const f=S(t.x,t.y,this.canvasWidth,this.canvasHeight),y=2;t.vx-=f.dx*y*a,t.vy-=f.dy*y*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}}const r=this.particleDiscs.get(t);if(!r)continue;D(t,a,this.speed,this.damping,o,i,n);const c=t.x-r.x,l=t.y-r.y,g=Math.sqrt(c*c+l*l);if(g>r.radius){g-r.radius;const d=-c/g,u=-l/g,m=Math.sqrt(t.vx*t.vx+t.vy*t.vy),h=.2,v=Math.sqrt(t.vx*t.vx+t.vy*t.vy),f=v>0?t.vx/v:d,y=v>0?t.vy/v:u,C=f*(1-h)+d*h,x=y*(1-h)+u*h,w=Math.sqrt(C*C+x*x);w>0&&(t.vx=C/w*m,t.vy=x/w*m);const M=.2;t.vx+=d*M,t.vy+=u*M}}}getDiscs(){return this.discs}}class z{constructor(e=.3,s=.95,o=800,i=600){this.speed=e,this.damping=s,this.canvasWidth=o,this.canvasHeight=i,this.categoryRegions=new Map,this.particleRegions=new Map,this.categories=["access_sensitive_data","administration","communication","data_operations","integrations"],this.calculateRegionPositions()}getName(){return"Permission Positioning"}setCanvasDimensions(e,s){this.canvasWidth=e,this.canvasHeight=s,this.calculateRegionPositions()}calculateRegionPositions(){const e=this.canvasWidth/2,s=this.canvasHeight/2,o=Math.min(this.canvasWidth,this.canvasHeight)*.3,i=Math.min(this.canvasWidth,this.canvasHeight)*.15;this.categoryRegions.clear();for(let n=0;n<this.categories.length;n++){const a=n*2*Math.PI/this.categories.length-Math.PI/2,t=e+Math.cos(a)*o,r=s+Math.sin(a)*o;this.categoryRegions.set(this.categories[n],{x:t,y:r,radius:i})}}initializeParticles(e){for(const s of e){const i=this.getParticleCategories(s).map(n=>this.categoryRegions.get(n)).filter(n=>n);if(i.length===0)s.x=this.canvasWidth/2,s.y=this.canvasHeight/2;else if(i.length===1){const n=i[0],a=Math.random()*Math.PI*2,t=Math.random()*n.radius*.8;s.x=n.x+Math.cos(a)*t,s.y=n.y+Math.sin(a)*t}else{const n=i.reduce((c,l)=>c+l.x,0)/i.length,a=i.reduce((c,l)=>c+l.y,0)/i.length,t=Math.random()*Math.PI*2,r=Math.random()*30;s.x=n+Math.cos(t)*r,s.y=a+Math.sin(t)*r}s.vx=0,s.vy=0,this.particleRegions.set(s,i)}}assignParticlesToRegions(e){for(const s of e){const i=this.getParticleCategories(s).map(n=>this.categoryRegions.get(n)).filter(n=>n);this.particleRegions.set(s,i)}}getParticleCategories(e){const s=e.agentData.permission_categories;return s?Object.keys(s):[]}update(e,s,o=-1e3,i=-1e3,n=!1){const a=Math.min(s/16.67,2);for(const t of e){if(t.frozen)continue;if(t.hidden){const c=S(t.x,t.y,this.canvasWidth,this.canvasHeight),l=2;t.vx+=c.dx*l*a,t.vy+=c.dy*l*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}if(t.returning){const c=this.canvasWidth/2,l=this.canvasHeight/2,g=t.x-c,d=t.y-l;if(Math.sqrt(g*g+d*d)<100)t.returning=!1;else{const m=S(t.x,t.y,this.canvasWidth,this.canvasHeight),h=2;t.vx-=m.dx*h*a,t.vy-=m.dy*h*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}}const r=this.particleRegions.get(t)||[];if(D(t,a,this.speed,this.damping,o,i,n),r.length===1){const c=r[0],l=t.x-c.x,g=t.y-c.y,d=Math.sqrt(l*l+g*g);if(d>c.radius){const u=-l/d,m=-g/d,h=Math.sqrt(t.vx*t.vx+t.vy*t.vy),v=.2,f=Math.sqrt(t.vx*t.vx+t.vy*t.vy),y=f>0?t.vx/f:u,C=f>0?t.vy/f:m,x=y*(1-v)+u*v,w=C*(1-v)+m*v,M=Math.sqrt(x*x+w*w);M>0&&(t.vx=x/M*h,t.vy=w/M*h);const P=.2;t.vx+=u*P,t.vy+=m*P}}else if(r.length>1){const c=r.reduce((h,v)=>h+v.x,0)/r.length,l=r.reduce((h,v)=>h+v.y,0)/r.length,g=t.x-c,d=t.y-l,u=Math.sqrt(g*g+d*d);if(u>50){const h=-g/u,v=-d/u,f=.3,y=Math.sqrt(t.vx*t.vx+t.vy*t.vy),C=Math.sqrt(t.vx*t.vx+t.vy*t.vy),x=C>0?t.vx/C:h,w=C>0?t.vy/C:v,M=x*(1-f)+h*f,P=w*(1-f)+v*f,b=Math.sqrt(M*M+P*P);b>0&&(t.vx=M/b*y,t.vy=P/b*y),t.vx+=h*.3,t.vy+=v*.3}}}}getRegions(){return this.categoryRegions}}class I{constructor(e=.3,s=.95,o=800,i=600){this.speed=e,this.damping=s,this.canvasWidth=o,this.canvasHeight=i,this.gridCells=new Map,this.particleCells=new Map,this.cellParticleCounts=new Map,this.categories=["access_sensitive_data","administration","communication","data_operations","integrations"],this.categoryPermissions=new Map,this.xCategory="integrations",this.yCategory="administration",this.TARGET_DENSITY=.02,this.initializeCategoryPermissions(),this.calculateGridPositions()}getName(){return"Cross-Product"}setCanvasDimensions(e,s){this.canvasWidth=e,this.canvasHeight=s,this.calculateGridPositions()}setCategories(e,s){this.xCategory=e,this.yCategory=s,this.calculateGridPositions()}getXCategory(){return this.xCategory}getYCategory(){return this.yCategory}initializeCategoryPermissions(){this.categoryPermissions.clear(),this.categories.forEach(e=>{this.categoryPermissions.set(e,[])})}calculateGridPositions(){this.gridCells.clear();const e=this.categoryPermissions.get(this.xCategory)||[],s=this.categoryPermissions.get(this.yCategory)||[],o=[...e,"(multiple)"],i=[...s,"(multiple)"],n=100,a=200,t=this.canvasWidth-n,r=this.canvasHeight-a,c=t/o.length,l=r/i.length;for(let g=0;g<i.length;g++)for(let d=0;d<o.length;d++){const u=o[d],m=i[g],h=`${u}:${m}`;this.gridCells.set(h,{x:n+d*c+c/2,y:a+g*l+l/2,width:c,height:l})}}initializeParticles(e){this.collectCategoryPermissions(e),this.calculateGridPositions(),this.cellParticleCounts.clear();for(const s of e){const o=this.getParticleCell(s);if(this.particleCells.set(s,o),o){const i=this.getCellKey(o);this.cellParticleCounts.set(i,(this.cellParticleCounts.get(i)||0)+1)}}for(const s of e){const o=this.getParticleCell(s);if(o){const i=this.getCellKey(o),a=(this.cellParticleCounts.get(i)||1)/this.TARGET_DENSITY,t=Math.sqrt(a),r=(Math.random()-.5)*t*.9,c=(Math.random()-.5)*t*.9;s.x=o.x+r,s.y=o.y+c,s.vx=0,s.vy=0,s.hidden=!1}else s.hidden=!0}}assignParticlesToCells(e){this.collectCategoryPermissions(e),this.calculateGridPositions(),this.cellParticleCounts.clear();for(const s of e){const o=this.getParticleCell(s);if(this.particleCells.set(s,o),o){s.hidden=!1,s.returning=!0;const i=this.getCellKey(o);this.cellParticleCounts.set(i,(this.cellParticleCounts.get(i)||0)+1)}else s.hidden=!0}}getCellKey(e){return`${e.x},${e.y}`}collectCategoryPermissions(e){this.initializeCategoryPermissions();const s=new Map;this.categories.forEach(o=>{s.set(o,new Set)});for(const o of e){const i=o.agentData.permission_categories;if(i)for(const[n,a]of Object.entries(i)){const t=s.get(n);t&&Array.isArray(a)&&a.forEach(r=>t.add(r))}}s.forEach((o,i)=>{this.categoryPermissions.set(i,Array.from(o).sort())})}getParticleCell(e){const s=e.agentData.permission_categories;if(!s)return null;const o=s[this.xCategory]||[],i=s[this.yCategory]||[];if(o.length===0||i.length===0)return null;const n=o.length===1?o[0]:"(multiple)",a=i.length===1?i[0]:"(multiple)",t=`${n}:${a}`;return this.gridCells.get(t)||null}update(e,s,o=-1e3,i=-1e3,n=!1){const a=Math.min(s/16.67,2);for(const t of e){if(t.frozen)continue;if(t.hidden){const f=S(t.x,t.y,this.canvasWidth,this.canvasHeight),y=2;t.vx+=f.dx*y*a,t.vy+=f.dy*y*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}if(t.returning){const f=this.particleCells.get(t);if(f){const y=f.x-t.x,C=f.y-t.y,x=Math.sqrt(y*y+C*C);if(x<10)t.returning=!1;else{t.vx+=y/x*2*a,t.vy+=C/x*2*a,t.vx*=.98,t.vy*=.98,t.x+=t.vx*a,t.y+=t.vy*a;continue}}}const r=this.particleCells.get(t);if(!r)continue;D(t,a,this.speed,this.damping,o,i,n);const c=this.getCellKey(r),g=(this.cellParticleCounts.get(c)||1)/this.TARGET_DENSITY,u=Math.sqrt(g)/2,m=t.x-r.x,h=t.y-r.y,v=Math.sqrt(m*m+h*h);if(v>u){const f=-(m/v),y=-(h/v);t.vx+=f*.3,t.vy+=y*.3}}}getGridCells(){return this.gridCells}getXLabels(){return[...this.categoryPermissions.get(this.xCategory)||[],"(multiple)"]}getYLabels(){return[...this.categoryPermissions.get(this.yCategory)||[],"(multiple)"]}getCategories(){return this.categories}}class ${constructor(e){this.behavior=e}setBehavior(e){this.behavior=e}getBehavior(){return this.behavior}update(e,s,o,i,n){this.behavior.update(e,s,o,i,n)}}class W{constructor(e,s,o){this.selectedParticle=null,this.hoveredParticle=null,this.detailPanel=null,this.mouseX=-1e3,this.mouseY=-1e3,this.mouseActive=!1,this.canvas=e,this.particles=s,this.onSelectionChange=o,this.boundHandleClick=this.handleClick.bind(this),this.boundHandleMouseMove=this.handleMouseMove.bind(this),this.boundHandleMouseLeave=this.handleMouseLeave.bind(this),this.canvas.addEventListener("click",this.boundHandleClick),this.canvas.addEventListener("mousemove",this.boundHandleMouseMove),this.canvas.addEventListener("mouseleave",this.boundHandleMouseLeave)}handleClick(e){const s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,i=e.clientY-s.top,n=this.findParticleAtPosition(o,i,10);n&&(n.frozen=!n.frozen,this.selectedParticle=n.frozen?n:null,this.onSelectionChange&&this.onSelectionChange(this.selectedParticle))}handleMouseMove(e){const s=this.canvas.getBoundingClientRect();this.mouseX=e.clientX-s.left,this.mouseY=e.clientY-s.top,this.mouseActive=!0;const o=this.findParticleAtPosition(this.mouseX,this.mouseY,15);o!==this.hoveredParticle&&(this.hoveredParticle&&!this.hoveredParticle.frozen&&(this.hoveredParticle.hovered=!1,this.hoveredParticle.size=this.hoveredParticle.baseSize),this.hoveredParticle=o,this.hoveredParticle&&!this.hoveredParticle.frozen&&(this.hoveredParticle.hovered=!0,this.hoveredParticle.size=this.hoveredParticle.baseSize*1.5),this.hoveredParticle&&!this.selectedParticle?this.updateDetailPanel(this.hoveredParticle):!this.hoveredParticle&&!this.selectedParticle&&this.updateDetailPanel(null))}handleMouseLeave(){this.mouseActive=!1,this.mouseX=-1e3,this.mouseY=-1e3,this.hoveredParticle&&!this.hoveredParticle.frozen&&(this.hoveredParticle.hovered=!1,this.hoveredParticle.size=this.hoveredParticle.baseSize),this.hoveredParticle=null,this.selectedParticle||this.updateDetailPanel(null)}findParticleAtPosition(e,s,o){let i=null,n=o;for(const a of this.particles){const t=a.x-e,r=a.y-s,c=Math.sqrt(t*t+r*r);c<n&&(i=a,n=c)}return i}getSelectedParticle(){return this.selectedParticle}setDetailPanel(e){this.detailPanel=e}updateDetailPanel(e){if(!this.detailPanel)return;if(!e){this.detailPanel.style.display="none";return}const s=e.agentData,o=k(s.platform),i=F(o),n=Math.round(e.color[0]*255),a=Math.round(e.color[1]*255),t=Math.round(e.color[2]*255),r=`rgb(${n}, ${a}, ${t})`;this.detailPanel.innerHTML=`
      <div class="detail-panel-header">
        <span style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background-color: ${r}; margin-right: 12px;">
          <img src="${i}" alt="${s.platform}" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
        </span>
        <h3 style="margin: 0; flex: 1;">${s.agent}</h3>
        <button class="close-button" onclick="window.closeDetailPanel()">×</button>
      </div>
      <div class="detail-panel-content">
        <div class="detail-row">
          <span class="detail-label">Platform:</span>
          <span class="detail-value">${s.platform}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Owner:</span>
          <span class="detail-value">${s.owner!==null?`Employee #${s.owner}`:"Unassigned"}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Role:</span>
          <span class="detail-value">${s.role}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value ${s.status==="warning"?"status-warning":""}">${s.status}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Cohort:</span>
          <span class="detail-value">${s.cohort}</span>
        </div>
        <div class="detail-section">
          <div class="detail-label">Permissions:</div>
          <div class="permissions-list">
            ${s.permissions.map(c=>`<span class="permission-badge">${c}</span>`).join("")}
          </div>
        </div>
      </div>
    `,this.detailPanel.style.display="block"}closeDetailPanel(){this.selectedParticle&&(this.selectedParticle.frozen=!1,this.selectedParticle=null),this.detailPanel&&(this.detailPanel.style.display="none"),this.onSelectionChange&&this.onSelectionChange(null)}destroy(){this.canvas.removeEventListener("click",this.boundHandleClick),this.canvas.removeEventListener("mousemove",this.boundHandleMouseMove),this.canvas.removeEventListener("mouseleave",this.boundHandleMouseLeave)}}class A{constructor(){this.particles=[],this.lastFrameTime=0,this.animationFrameId=null,this.movementMode="unsorted",this.isGroupedMode=!1,this.zoomState=null,this.activeFilters=new Set,this.frameCount=0,this.lastFpsUpdate=0,this.currentFps=0,this.fpsElement=null,this.particleCountElement=null}async init(){if(this.canvas=document.getElementById("particle-canvas"),!this.canvas)throw new Error("Canvas element not found");if(this.overlayCanvas=document.getElementById("overlay-canvas"),!this.overlayCanvas)throw new Error("Overlay canvas element not found");const e=this.overlayCanvas.getContext("2d");if(!e)throw new Error("Could not get 2D context for overlay canvas");this.overlayCtx=e,this.fpsElement=document.getElementById("fps-counter"),this.particleCountElement=document.getElementById("particle-counter"),this.resizeCanvas(),this.boundResizeHandler=()=>this.resizeCanvas(),window.addEventListener("resize",this.boundResizeHandler);try{console.log("Loading 10k.json...");const s=await fetch("../data/10k.json");if(!s.ok)throw new Error(`Failed to load data: ${s.statusText}`);const i=(await s.json()).records;console.log(`Loaded ${i.length} agents`);const n=i;this.colorMapper=new Y,this.colorMapper.assignColors(n,"platform"),console.log("Colors assigned by platform");const a=n.map(h=>h.users_1d),t=Math.min(...a),r=Math.max(...a);console.log(`Users 1d range: ${t} - ${r}`),this.particles=n.map(h=>{const v=(h.users_1d-t)/(r-t),y=2+Math.sqrt(v)*6,C=Math.random()*window.innerWidth,x=Math.random()*window.innerHeight,w=this.colorMapper.getColor(h.platform);return{x:C,y:x,vx:0,vy:0,size:y,baseSize:y,frozen:!1,hidden:!1,returning:!1,hovered:!1,color:w,agentData:h}}),console.log(`Created ${this.particles.length} particles`),this.renderer=new H({canvas:this.canvas,particleShape:"circle"}),console.log("Renderer initialized"),this.brownianMotion=new R(.5,.95,this.canvas.width,this.canvas.height),this.discClustering=new L(.3,.95,this.canvas.width,this.canvas.height,"role"),this.permissionPositioning=new z(.3,.95,this.canvas.width,this.canvas.height),this.crossProductPositioning=new I(.3,.95,this.canvas.width,this.canvas.height),this.movementSystem=new $(this.brownianMotion),console.log("Movement system initialized (brownian motion)");const c=document.getElementById("detail-panel");this.interactionManager=new W(this.canvas,this.particles,h=>{c&&this.interactionManager.updateDetailPanel(h)}),c&&this.interactionManager.setDetailPanel(c),window.closeDetailPanel=()=>{this.interactionManager.closeDetailPanel()};const l=document.getElementById("toggle-movement");l&&l.addEventListener("click",()=>this.toggleMovementMode()),document.querySelectorAll(".cluster-button").forEach(h=>{h.addEventListener("click",v=>{const y=v.target.dataset.attribute;y&&this.changeClusteringAttribute(y)})});const d=document.getElementById("x-category-select"),u=document.getElementById("y-category-select");d&&u&&(d.addEventListener("change",()=>{this.changeCrossProductCategories(d.value,u.value)}),u.addEventListener("change",()=>{this.changeCrossProductCategories(d.value,u.value)})),this.buildFilterUI(n);const m=document.getElementById("toggle-filters");m&&m.addEventListener("click",()=>this.toggleFilters()),this.canvas.addEventListener("click",h=>{this.handleCanvasClick(h)}),this.overlayCanvas.addEventListener("click",h=>{this.handleCanvasClick(h)}),console.log("Interaction manager initialized"),this.updateParticleCount(),this.drawDiscLabels(),console.log("Disc labels drawn"),this.lastFrameTime=performance.now(),this.lastFpsUpdate=this.lastFrameTime,this.animate(this.lastFrameTime),console.log("Particle visualization started!")}catch(s){throw console.error("Failed to initialize particle app:",s),s}}toggleMovementMode(){this.movementMode==="unsorted"?(this.movementMode="grouped",this.isGroupedMode=!0):this.movementMode==="grouped"?(this.movementMode="permissions",this.isGroupedMode=!1):this.movementMode==="permissions"?(this.movementMode="crossproduct",this.isGroupedMode=!1):(this.movementMode="unsorted",this.isGroupedMode=!1);const e=document.getElementById("clustering-controls"),s=document.getElementById("crossproduct-controls");this.movementMode==="grouped"?(this.discClustering.assignParticlesToDiscs(this.particles),this.movementSystem.setBehavior(this.discClustering),this.drawDiscLabels(),e&&(e.style.display="flex"),s&&(s.style.display="none"),console.log("Switched to grouped mode (disc clustering)")):this.movementMode==="permissions"?(this.permissionPositioning.assignParticlesToRegions(this.particles),this.movementSystem.setBehavior(this.permissionPositioning),this.drawPermissionLabels(),e&&(e.style.display="none"),s&&(s.style.display="none"),console.log("Switched to permissions mode (permission positioning)")):this.movementMode==="crossproduct"?(this.crossProductPositioning.assignParticlesToCells(this.particles),this.movementSystem.setBehavior(this.crossProductPositioning),this.drawCrossProductGrid(),e&&(e.style.display="none"),s&&(s.style.display="flex"),console.log("Switched to crossproduct mode (crossproduct positioning)")):(this.movementSystem.setBehavior(this.brownianMotion),this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),e&&(e.style.display="none"),s&&(s.style.display="none"),console.log("Switched to unsorted mode (brownian motion)"));const o=document.getElementById("toggle-movement");if(o){const i=this.movementMode==="unsorted"?"Switch to Grouped":this.movementMode==="grouped"?"Switch to Permissions":this.movementMode==="permissions"?"Switch to Cross Product":"Switch to Unsorted";o.textContent=i}}changeClusteringAttribute(e){if(!this.isGroupedMode)return;document.querySelectorAll(".cluster-button").forEach(o=>{const i=o;i.dataset.attribute===e?i.classList.add("active"):i.classList.remove("active")}),this.discClustering.setClusteringAttribute(e),this.discClustering.assignParticlesToDiscs(this.particles),this.drawDiscLabels(),console.log(`Re-clustered by ${e}`)}changeCrossProductCategories(e,s){this.movementMode==="crossproduct"&&(console.log(`Changing crossproduct categories to X: ${e}, Y: ${s}`),this.crossProductPositioning.setCategories(e,s),this.crossProductPositioning.assignParticlesToCells(this.particles),this.drawCrossProductGrid())}buildFilterUI(e){const s=new Set(e.map(n=>n.platform)),o=new Set(e.map(n=>n.role)),i=new Set(e.map(n=>n.cohort));this.buildFilterSection("platform-filters",Array.from(s),"platform"),this.buildFilterSection("role-filters",Array.from(o),"role"),this.buildFilterSection("cohort-filters",Array.from(i),"cohort")}buildFilterSection(e,s,o){const i=document.getElementById(e);i&&s.sort().forEach(n=>{const a=document.createElement("div");a.className="filter-item";const t=document.createElement("input");t.type="checkbox",t.id=`filter-${o}-${n}`,t.checked=!0,t.addEventListener("change",()=>{this.handleFilterChange(o,n,t.checked)});const r=document.createElement("label");r.htmlFor=t.id,r.textContent=n,a.appendChild(t),a.appendChild(r),i.appendChild(a)})}handleFilterChange(e,s,o){const i=`${e}:${s}`;o?this.activeFilters.delete(i):this.activeFilters.add(i),this.updateParticleVisibility()}updateParticleVisibility(){for(const e of this.particles){const s=e.agentData,o=`platform:${s.platform}`,i=`role:${s.role}`,n=`cohort:${s.cohort}`,a=this.activeFilters.has(o)||this.activeFilters.has(i)||this.activeFilters.has(n);if(e.hidden&&!a){e.returning=!0;const t=this.canvas.width/2,r=this.canvas.height/2,c=e.x-t,l=e.y-r,g=Math.sqrt(c*c+l*l),d=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height)*.7;if(g>d){const u=Math.atan2(l,c);e.x=t+Math.cos(u)*d,e.y=r+Math.sin(u)*d}}e.hidden=a}}toggleFilters(){const e=document.getElementById("filters"),s=document.getElementById("filter-toggle-icon");e&&(e.classList.contains("collapsed")?(e.classList.remove("collapsed"),s&&(s.textContent="▼")):(e.classList.add("collapsed"),s&&(s.textContent="▶")))}resizeCanvas(){if(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.overlayCanvas&&(this.overlayCanvas.width=window.innerWidth,this.overlayCanvas.height=window.innerHeight),this.renderer&&this.renderer.resize(this.canvas.width,this.canvas.height),this.movementSystem){const e=this.movementSystem.getBehavior();(e instanceof R||e instanceof L||e instanceof z||e instanceof I)&&e.setCanvasDimensions(this.canvas.width,this.canvas.height)}this.movementMode==="grouped"?this.drawDiscLabels():this.movementMode==="permissions"?this.drawPermissionLabels():this.movementMode==="crossproduct"&&this.drawCrossProductGrid()}drawDiscLabels(){if(!this.overlayCtx||!this.movementSystem)return;const e=this.movementSystem.getBehavior();if(!(e instanceof L))return;this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const s=e.getDiscs();this.overlayCtx.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.overlayCtx.textAlign="center",this.overlayCtx.textBaseline="middle",s.forEach((o,i)=>{if(this.zoomState?.active&&this.zoomState.targetDisc!==i)return;const n=this.applyZoomTransform(o.x,o.y),a=i.split("_").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" "),r=this.overlayCtx.measureText(a).width,c=22;this.overlayCtx.fillStyle="rgba(0, 0, 0, 0.5)",this.overlayCtx.fillRect(n.x-r/2-8,n.y-c/2-4,r+16,c+8),this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.9)",this.overlayCtx.fillText(a,n.x,n.y)})}drawPermissionLabels(){if(!this.overlayCtx||!this.movementSystem)return;const e=this.movementSystem.getBehavior();if(!(e instanceof z))return;this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const s=e.getRegions();this.overlayCtx.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.overlayCtx.textAlign="center",this.overlayCtx.textBaseline="middle",s.forEach((o,i)=>{const n=i.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "),t=this.overlayCtx.measureText(n).width,r=22;this.overlayCtx.fillStyle="rgba(0, 0, 0, 0.5)",this.overlayCtx.fillRect(o.x-t/2-8,o.y-r/2-4,t+16,r+8),this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.9)",this.overlayCtx.fillText(n,o.x,o.y)})}applyFisheyeDistortion(e,s,o,i,n){if(!n)return{x:e,y:s,scale:1};const a=e-o,t=s-i,r=Math.sqrt(a*a+t*t),c=120;if(r>=c||r===0)return{x:e,y:s,scale:1};const l=r/c,g=1.8,d=Math.pow(1-l,2),u=(g-1)*d,m=r*(1+u),h=Math.atan2(t,a),v=o+Math.cos(h)*m,f=i+Math.sin(h)*m,y=1+u*3;return{x:v,y:f,scale:y}}applyZoomTransform(e,s){if(!this.zoomState?.active)return{x:e,y:s};const{centerX:o,centerY:i,scale:n,animationProgress:a}=this.zoomState,t=this.canvas.width/2,r=this.canvas.height/2,c=o+(t-o)*a,l=i+(r-i)*a;return{x:(e-o)*n+c,y:(s-i)*n+l}}inverseZoomTransform(e,s){if(!this.zoomState?.active)return{x:e,y:s};const{centerX:o,centerY:i,scale:n,animationProgress:a}=this.zoomState,t=this.canvas.width/2,r=this.canvas.height/2,c=o+(t-o)*a,l=i+(r-i)*a;return{x:(e-c)/n+o,y:(s-l)/n+i}}startZoomIn(e,s){const i=Math.min(this.canvas.width,this.canvas.height)/(s.radius*2.2);this.zoomState={active:!0,targetDisc:e,discRadius:s.radius,centerX:s.x,centerY:s.y,scale:1,targetScale:i,zooming:"in",animationStart:performance.now(),animationProgress:0},console.log(`Zooming into disc: ${e}, scale: ${i.toFixed(2)}`)}startZoomOut(){this.zoomState&&(this.zoomState.zooming="out",this.zoomState.animationStart=performance.now(),console.log("Zooming out to full view"))}findDiscAtPosition(e,s){if(this.movementMode!=="grouped")return null;const o=this.discClustering.getDiscs();for(const[i,n]of o){const a=e-n.x,t=s-n.y;if(Math.sqrt(a*a+t*t)<=n.radius)return{name:i,disc:n}}return null}handleCanvasClick(e){if(this.movementMode!=="grouped")return;const s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,i=e.clientY-s.top,n=60;let a=!1;if(!this.zoomState){const t=this.discClustering.getDiscs();for(const[r,c]of t){const l=o-c.x,g=i-c.y;if(Math.sqrt(l*l+g*g)<n){a=!0;break}}}if(!(!a&&this.interactionManager.findParticleAtPosition(o,i,10))){if(this.zoomState?.active&&this.zoomState.zooming!=="out"){const t=this.canvas.width/2,r=this.canvas.height/2,c=o-t,l=i-r,g=Math.sqrt(c*c+l*l),d=this.zoomState.discRadius*this.zoomState.scale;if(g>d){this.startZoomOut();return}}if(!this.zoomState){const t=this.findDiscAtPosition(o,i);t&&this.startZoomIn(t.name,t.disc)}}}drawPermissionHoverLines(){if(!this.overlayCtx||!this.movementSystem)return;const e=this.movementSystem.getBehavior();if(!(e instanceof z))return;this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const s=e.getRegions();this.overlayCtx.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.overlayCtx.textAlign="center",this.overlayCtx.textBaseline="middle",s.forEach((i,n)=>{const a=n.split("_").map(l=>l.charAt(0).toUpperCase()+l.slice(1)).join(" "),r=this.overlayCtx.measureText(a).width,c=22;this.overlayCtx.fillStyle="rgba(0, 0, 0, 0.5)",this.overlayCtx.fillRect(i.x-r/2-8,i.y-c/2-4,r+16,c+8),this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.9)",this.overlayCtx.fillText(a,i.x,i.y)}),this.particles.filter(i=>i.hovered).forEach(i=>{const n=i.agentData.permission_categories;if(!n)return;Object.keys(n).forEach(t=>{const r=s.get(t);r&&(this.overlayCtx.strokeStyle="rgba(255, 255, 255, 0.6)",this.overlayCtx.lineWidth=2,this.overlayCtx.setLineDash([5,5]),this.overlayCtx.beginPath(),this.overlayCtx.moveTo(i.x,i.y),this.overlayCtx.lineTo(r.x,r.y),this.overlayCtx.stroke(),this.overlayCtx.setLineDash([]))})})}drawCrossProductGrid(){if(!this.overlayCtx||!this.movementSystem)return;const e=this.movementSystem.getBehavior();if(!(e instanceof I))return;this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),e.getGridCells();const s=e.getXLabels(),o=e.getYLabels(),i=100,n=180,a=this.canvas.width-i,t=this.canvas.height-n,r=a/s.length,c=t/o.length;this.overlayCtx.font='bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.overlayCtx.textAlign="center",this.overlayCtx.textBaseline="bottom",this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.95)",s.forEach((l,g)=>{const d=i+g*r,u=this.overlayCtx.measureText(l),m=3;this.overlayCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.overlayCtx.fillRect(d-u.width/2-m,n-16,u.width+m*2,14),this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.95)",this.overlayCtx.fillText(l,d,n-4)}),this.overlayCtx.textAlign="right",this.overlayCtx.textBaseline="middle",o.forEach((l,g)=>{const d=n+g*c,u=this.overlayCtx.measureText(l),m=3;this.overlayCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.overlayCtx.fillRect(i-u.width-m*2-4,d-7,u.width+m*2,14),this.overlayCtx.fillStyle="rgba(255, 255, 255, 0.95)",this.overlayCtx.fillText(l,i-m-4,d)})}animate(e){const s=e-this.lastFrameTime;if(this.lastFrameTime=e,this.zoomState?.active){const h=e-this.zoomState.animationStart,f=Math.min(h/300,1),y=1-Math.pow(1-f,3);this.zoomState.zooming==="in"?(this.zoomState.scale=1+(this.zoomState.targetScale-1)*y,this.zoomState.animationProgress=y):(this.zoomState.scale=this.zoomState.targetScale+(1-this.zoomState.targetScale)*y,this.zoomState.animationProgress=1-y,f>=1&&(this.zoomState=null,this.drawDiscLabels()))}this.frameCount++,e-this.lastFpsUpdate>=1e3&&(this.currentFps=Math.round(this.frameCount*1e3/(e-this.lastFpsUpdate)),this.updateFps(),this.frameCount=0,this.lastFpsUpdate=e);const o=this.inverseZoomTransform(this.interactionManager.mouseX,this.interactionManager.mouseY);this.movementSystem.update(this.particles,s,o.x,o.y,this.interactionManager.mouseActive);const i=this.colorMapper.getWarningGlowColor(),n=this.interactionManager.mouseX,a=this.interactionManager.mouseY,t=this.interactionManager.mouseActive,r=this.particles.length,c=new Float32Array(r*2),l=new Float32Array(r*4),g=new Float32Array(r),d=new Float32Array(r),u=this.zoomState?.active?this.zoomState.scale:1;for(let h=0;h<r;h++){const v=this.particles[h],f=this.applyZoomTransform(v.x,v.y),y=this.applyFisheyeDistortion(f.x,f.y,n,a,t);c[h*2]=y.x,c[h*2+1]=y.y;const C=String(v.agentData[this.discClustering.getClusteringAttribute()]),x=!this.zoomState?.active||C===this.zoomState.targetDisc,w=v.hovered||v.frozen?1.2:1;l[h*4]=Math.min(1,v.color[0]*w),l[h*4+1]=Math.min(1,v.color[1]*w),l[h*4+2]=Math.min(1,v.color[2]*w),l[h*4+3]=x?1:.2;const M=v.frozen?v.size*2:v.size;g[h]=M*y.scale*u,d[h]=this.renderer.getPlatformIndex(v.agentData.platform)}this.renderer.render(c,l,g,d,!0);const m=this.particles.filter(h=>h.agentData.status==="warning");if(m.length>0){const h=m.length,v=new Float32Array(h*2),f=new Float32Array(h*4),y=new Float32Array(h);for(let x=0;x<h;x++){const w=m[x],M=this.applyZoomTransform(w.x,w.y),P=this.applyFisheyeDistortion(M.x,M.y,n,a,t);v[x*2]=P.x,v[x*2+1]=P.y,f[x*4]=i[0],f[x*4+1]=i[1],f[x*4+2]=i[2],f[x*4+3]=.3;const b=w.frozen?w.size*2:w.size;y[x]=b*2.5*P.scale*u}const C=new Float32Array(h).fill(-1);this.renderer.render(v,f,y,C,!1)}this.movementMode==="permissions"&&this.drawPermissionHoverLines(),this.movementMode==="grouped"&&this.zoomState?.active&&this.drawDiscLabels(),this.animationFrameId=requestAnimationFrame(h=>this.animate(h))}updateFps(){this.fpsElement&&(this.fpsElement.textContent=`FPS: ${this.currentFps}`)}updateParticleCount(){this.particleCountElement&&(this.particleCountElement.textContent=`Particles: ${this.particles.length}`)}destroy(){this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.renderer&&this.renderer.destroy(),this.interactionManager&&this.interactionManager.destroy(),this.boundResizeHandler&&window.removeEventListener("resize",this.boundResizeHandler)}}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const p=new A;window.particleApp=p,p.init().catch(console.error)});else{const p=new A;window.particleApp=p,p.init().catch(console.error)}
